var ri=Object.defineProperty;var oi=(o,t,e)=>t in o?ri(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var x=(o,t,e)=>(oi(o,typeof t!="symbol"?t+"":t,e),e);import{n as mt,e as ft,b as gt,l as pt,d as G,m as ht,i as At,o as Gt,a as it,a4 as He,D as Mt,G as ut,L as Oe,M as ce,T as Fe,s as _e,c as ue,p as St,J as K,U as ze,V as Ue,W as Ne,E as je,K as Bt}from"./scheduler.B6ZHjePS.js";import{S as xt,i as yt,t as O,g as de,b as q,e as fe,c as Zt,a as $t,m as te,d as ee,f as Ht}from"./index.D8p8-7y1.js";import{g as hi}from"./clock.CjzioAVG.js";import{s as nt}from"./dom.COxKB0-J.js";import{w as qe,d as ai}from"./index.B134a2AU.js";import{q as ge,m as dt,i as Y,a as li,d as at,R as Vt,p as ci,r as pe,t as F,u as _i,v as Xt,P as It,w as ui,x as di,W as me,B as xe,y as ye,z as we,D as Tt,C as ie,f as fi,G as gi,H as Ot,I as pi,J as mi,K as xi,M as yi,U as wi,h as bi}from"./pixi.CGO4fLu2.js";import{a as vi}from"./random.BCioE_zI.js";import{a as Ye,b as Ge}from"./colors.Cawrobd1.js";import{s as Si}from"./spring.DliCiKnh.js";function be(o,t,e){for(let i=0,s=4*e*t;i<t;++i,s+=4)if(o[s+3]!==0)return!1;return!0}function ve(o,t,e,i,s){const n=4*t;for(let r=i,h=i*n+4*e;r<=s;++r,h+=n)if(o[h+3]!==0)return!1;return!0}function Ti(o){const{width:t,height:e}=o,i=o.getContext("2d",{willReadFrequently:!0});if(i===null)throw new TypeError("Failed to get canvas 2D context");const s=i.getImageData(0,0,t,e).data;let n=0,r=0,h=t-1,a=e-1;for(;r<e&&be(s,t,r);)++r;if(r===e)return ge.EMPTY;for(;be(s,t,a);)--a;for(;ve(s,t,n,r,a);)++n;for(;ve(s,t,h,r,a);)--h;return++h,++a,new ge(n,r,h,a)}function Ci(o){const t=Ti(o),{width:e,height:i}=t;let s=null;if(!t.isEmpty()){const n=o.getContext("2d");if(n===null)throw new TypeError("Failed to get canvas 2D context");s=n.getImageData(t.left,t.top,e,i)}return{width:e,height:i,data:s}}var Se=Object.prototype.hasOwnProperty;function Te(o,t){var e,i;if(o===t)return!0;if(o&&t&&(e=o.constructor)===t.constructor){if(e===Date)return o.getTime()===t.getTime();if(e===RegExp)return o.toString()===t.toString();if(e===Array){if((i=o.length)===t.length)for(;i--&&Te(o[i],t[i]););return i===-1}if(!e||typeof o=="object"){i=0;for(e in o)if(Se.call(o,e)&&++i&&!Se.call(t,e)||!(e in t)||!Te(o[e],t[e]))return!1;return Object.keys(t).length===i}}return o!==o&&t!==t}function ki(o){let t,e;return{c(){t=ft("div"),e=ft("canvas"),this.h()},l(i){t=gt(i,"DIV",{class:!0});var s=pt(t);e=gt(s,"CANVAS",{}),pt(e).forEach(G),s.forEach(G),this.h()},h(){ht(t,"class","canvas svelte-cdatl6")},m(i,s){At(i,t,s),Gt(t,e),o[11](e)},p:it,i:it,o:it,d(i){i&&G(t),o[11](null)}}}function Di(o,t,e){let i,s,n=it,r=()=>(n(),n=Mt(i,p=>e(9,s=p)),i),h,a=it,c=()=>(a(),a=Mt(f,p=>e(10,h=p)),f);o.$$.on_destroy.push(()=>n()),o.$$.on_destroy.push(()=>a());let{width:l}=t,{height:u}=t,{domCanvasRenderer:_}=t,{stage:d}=t,{clock:f}=t;c();let g,w,y;const b=(p,k)=>{_==null||_.resize(p,k),e(7,w=p),e(8,y=k)};He(()=>(_==null||_.setCanvas(g),()=>{_==null||_.unsetCanvas()}));function m(p){ut[p?"unshift":"push"](()=>{g=p,e(1,g)})}return o.$$set=p=>{"width"in p&&e(3,l=p.width),"height"in p&&e(4,u=p.height),"domCanvasRenderer"in p&&e(5,_=p.domCanvasRenderer),"stage"in p&&e(6,d=p.stage),"clock"in p&&c(e(0,f=p.clock))},o.$$.update=()=>{o.$$.dirty&410&&g&&(w!==l||y!==u)&&b(l,u),o.$$.dirty&32&&r(e(2,i=_==null?void 0:_.dirty)),o.$$.dirty&1632&&_!=null&&_.ctx&&(h.running||s)&&(_.clear(),_.render(d.sim.entities,d.$camera))},[f,g,i,l,u,_,d,w,y,s,h,m]}class Mi extends xt{constructor(t){super(),yt(this,t,Di,ki,mt,{width:3,height:4,domCanvasRenderer:5,stage:6,clock:0})}}function Ii(o,t,e){let i,s,n,r=it,h=()=>(r(),r=Mt(l,d=>e(6,n=d)),l);o.$$.on_destroy.push(()=>r());let{pixi:a}=t,{stage:c}=t,{clock:l}=t;h();const{container:u,camera:_}=c;return Oe(o,_,d=>e(5,s=d)),a.current_scene.addChild(u),ce(()=>{a.current_scene.removeChild(u)}),ce(()=>{a.app.render(),a.app.start()}),o.$$set=d=>{"pixi"in d&&e(2,a=d.pixi),"stage"in d&&e(3,c=d.stage),"clock"in d&&h(e(0,l=d.clock))},o.$$.update=()=>{o.$$.dirty&64&&e(4,{running:i}=n,i),o.$$.dirty&52&&(i?a.app.start():(a.app.stop(),_.setPosition(s.x,s.y,{hard:!0})))},[l,_,a,c,i,s,n]}class Li extends xt{constructor(t){super(),yt(this,t,Ii,null,mt,{pixi:2,stage:3,clock:0})}}function Ce(o){let t,e;return t=new Mi({props:{width:o[3],height:o[4],domCanvasRenderer:o[2],stage:o[0],clock:o[6]}}),{c(){Zt(t.$$.fragment)},l(i){$t(t.$$.fragment,i)},m(i,s){te(t,i,s),e=!0},p(i,s){const n={};s&8&&(n.width=i[3]),s&16&&(n.height=i[4]),s&4&&(n.domCanvasRenderer=i[2]),s&1&&(n.stage=i[0]),t.$set(n)},i(i){e||(O(t.$$.fragment,i),e=!0)},o(i){q(t.$$.fragment,i),e=!1},d(i){ee(t,i)}}}function ke(o){let t,e;return t=new Li({props:{stage:o[0],pixi:o[1],clock:o[6]}}),{c(){Zt(t.$$.fragment)},l(i){$t(t.$$.fragment,i)},m(i,s){te(t,i,s),e=!0},p(i,s){const n={};s&1&&(n.stage=i[0]),s&2&&(n.pixi=i[1]),t.$set(n)},i(i){e||(O(t.$$.fragment,i),e=!0)},o(i){q(t.$$.fragment,i),e=!1},d(i){ee(t,i)}}}function Pi(o){let t,e,i,s=`${o[3]}px`,n=`${o[4]}px`,r,h,a,c=o[2]&&Ce(o),l=o[1]&&ke(o);const u=o[18].default,_=Fe(u,o,o[17],null);return{c(){t=ft("div"),c&&c.c(),e=_e(),l&&l.c(),i=_e(),_&&_.c(),this.h()},l(d){t=gt(d,"DIV",{class:!0});var f=pt(t);c&&c.l(f),e=ue(f),l&&l.l(f),i=ue(f),_&&_.l(f),f.forEach(G),this.h()},h(){ht(t,"class","world svelte-2qhvjl"),St(t,"width",s),St(t,"height",n)},m(d,f){At(d,t,f),c&&c.m(t,null),Gt(t,e),l&&l.m(t,null),Gt(t,i),_&&_.m(t,null),r=!0,h||(a=[K(window,"keydown",o[7]),K(window,"keyup",o[8])],h=!0)},p(d,[f]){d[2]?c?(c.p(d,f),f&4&&O(c,1)):(c=Ce(d),c.c(),O(c,1),c.m(t,e)):c&&(de(),q(c,1,1,()=>{c=null}),fe()),d[1]?l?(l.p(d,f),f&2&&O(l,1)):(l=ke(d),l.c(),O(l,1),l.m(t,i)):l&&(de(),q(l,1,1,()=>{l=null}),fe()),_&&_.p&&(!r||f&131072)&&ze(_,u,d,d[17],r?Ne(u,d[17],f,null):Ue(d[17]),null),f&8&&s!==(s=`${d[3]}px`)&&St(t,"width",s),f&16&&n!==(n=`${d[4]}px`)&&St(t,"height",n)},i(d){r||(O(c),O(l),O(_,d),r=!0)},o(d){q(c),q(l),q(_,d),r=!1},d(d){d&&G(t),c&&c.d(),l&&l.d(),_&&_.d(d),h=!1,je(a)}}}function Ei(o,t,e){let i,s,n,r,h,a=it,c=()=>(a(),a=Mt(s,S=>e(16,h=S)),s);o.$$.on_destroy.push(()=>a());let{$$slots:l={},$$scope:u}=t,{stage:_}=t,{pixi:d=null}=t,{domCanvasRenderer:f=null}=t,{worldWidth:g}=t,{worldHeight:w}=t,{viewWidth:y}=t,{viewHeight:b}=t,{viewportWidth:m}=t,{viewportHeight:p}=t;const k=hi();Oe(o,k,S=>e(15,r=S)),He(()=>{_.update(0),v()});const v=()=>{d==null||d.app.render()},T=S=>{i.handleKeydown(S.key)},D=S=>{i.handleKeyup(S.key)};return o.$$set=S=>{"stage"in S&&e(0,_=S.stage),"pixi"in S&&e(1,d=S.pixi),"domCanvasRenderer"in S&&e(2,f=S.domCanvasRenderer),"worldWidth"in S&&e(3,g=S.worldWidth),"worldHeight"in S&&e(4,w=S.worldHeight),"viewWidth"in S&&e(9,y=S.viewWidth),"viewHeight"in S&&e(10,b=S.viewHeight),"viewportWidth"in S&&e(11,m=S.viewportWidth),"viewportHeight"in S&&e(12,p=S.viewportHeight),"$$scope"in S&&e(17,u=S.$$scope)},o.$$.update=()=>{o.$$.dirty&6&&console.log("pixi, domCanvasRenderer",d,f),o.$$.dirty&1&&e(13,{controller:i}=_,i),o.$$.dirty&8192&&c(e(5,{moving:s}=i,s)),o.$$.dirty&32768&&e(14,{running:n}=r,n),o.$$.dirty&81920&&!n&&h&&k.resume(),o.$$.dirty&49153&&n&&_.update(r.dt),o.$$.dirty&24089&&(_.resize(g,w,y,b,m,p),!n&&v())},[_,d,f,g,w,s,k,T,D,y,b,m,p,i,n,r,h,u,l]}class Cs extends xt{constructor(t){super(),yt(this,t,Ei,Pi,mt,{stage:0,pixi:1,domCanvasRenderer:2,worldWidth:3,worldHeight:4,viewWidth:9,viewHeight:10,viewportWidth:11,viewportHeight:12})}}function Ai(o){let t,e,i,s;const n=o[14].default,r=Fe(n,o,o[13],null);return{c(){t=ft("div"),r&&r.c(),this.h()},l(h){t=gt(h,"DIV",{class:!0,tabindex:!0,role:!0});var a=pt(t);r&&r.l(a),a.forEach(G),this.h()},h(){ht(t,"class","surface svelte-1ktoghv"),ht(t,"tabindex","0"),ht(t,"role","button")},m(h,a){At(h,t,a),r&&r.m(t,null),o[15](t),e=!0,i||(s=[K(t,"pointerdown",o[1]),K(t,"pointerup",o[2]),K(t,"pointermove",o[3]),K(t,"pointerenter",o[4]),K(t,"pointerleave",o[5]),K(t,"pointercancel",o[6])],i=!0)},p(h,[a]){r&&r.p&&(!e||a&8192)&&ze(r,n,h,h[13],e?Ne(n,h[13],a,null):Ue(h[13]),null)},i(h){e||(O(r,h),e=!0)},o(h){q(r,h),e=!1},d(h){h&&G(t),r&&r.d(h),o[15](null),i=!1,je(s)}}}function Ri(o,t,e){let{$$slots:i={},$$scope:s}=t,{scale:n=1}=t,{pointing:r=void 0}=t,{pointer_down:h=void 0}=t,{pointer_x:a=void 0}=t,{pointer_y:c=void 0}=t,{cancel_on_leave:l=!0}=t;const u=(v,T)=>{const D=b.getBoundingClientRect();e(9,a=(v-D.left)/n),e(10,c=(T-D.top)/n)},_=v=>{v.shiftKey||v.button>=3||(nt(v),u(v.clientX,v.clientY),e(8,h=!0),m())},d=v=>{v.shiftKey||v.button>=3||(nt(v),u(v.clientX,v.clientY),e(8,h=!1))},f=v=>{v.shiftKey||(nt(v),u(v.clientX,v.clientY))},g=v=>{v.shiftKey||(nt(v),u(v.clientX,v.clientY),e(7,r=!0))},w=v=>{v.shiftKey||(nt(v),u(v.clientX,v.clientY),e(7,r=!1),l&&h&&(e(8,h=!1),p()))},y=v=>{v.shiftKey||(nt(v),h&&(e(8,h=!1),p()))};let b;const m=()=>{document.activeElement!==b&&b.focus()},p=()=>{document.activeElement===b&&b.blur()};function k(v){ut[v?"unshift":"push"](()=>{b=v,e(0,b)})}return o.$$set=v=>{"scale"in v&&e(11,n=v.scale),"pointing"in v&&e(7,r=v.pointing),"pointer_down"in v&&e(8,h=v.pointer_down),"pointer_x"in v&&e(9,a=v.pointer_x),"pointer_y"in v&&e(10,c=v.pointer_y),"cancel_on_leave"in v&&e(12,l=v.cancel_on_leave),"$$scope"in v&&e(13,s=v.$$scope)},[b,_,d,f,g,w,y,r,h,a,c,n,l,s,i,k]}class Wi extends xt{constructor(t){super(),yt(this,t,Ri,Ai,mt,{scale:11,pointing:7,pointer_down:8,pointer_x:9,pointer_y:10,cancel_on_leave:12})}}function Bi(o){let t,e,i,s,n,r;function h(u){o[4](u)}function a(u){o[5](u)}function c(u){o[6](u)}let l={};return o[0]!==void 0&&(l.pointer_down=o[0]),o[1]!==void 0&&(l.pointer_x=o[1]),o[2]!==void 0&&(l.pointer_y=o[2]),e=new Wi({props:l}),ut.push(()=>Ht(e,"pointer_down",h)),ut.push(()=>Ht(e,"pointer_x",a)),ut.push(()=>Ht(e,"pointer_y",c)),{c(){t=ft("div"),Zt(e.$$.fragment),this.h()},l(u){t=gt(u,"DIV",{class:!0});var _=pt(t);$t(e.$$.fragment,_),_.forEach(G),this.h()},h(){ht(t,"class","surface-wrapper svelte-1w41ucz")},m(u,_){At(u,t,_),te(e,t,null),r=!0},p(u,[_]){const d={};!i&&_&1&&(i=!0,d.pointer_down=u[0],Bt(()=>i=!1)),!s&&_&2&&(s=!0,d.pointer_x=u[1],Bt(()=>s=!1)),!n&&_&4&&(n=!0,d.pointer_y=u[2],Bt(()=>n=!1)),e.$set(d)},i(u){r||(O(e.$$.fragment,u),r=!0)},o(u){q(e.$$.fragment,u),r=!1},d(u){u&&G(t),ee(e)}}}function Hi(o,t,e){let{controller:i}=t,s=!1,n,r;function h(l){s=l,e(0,s)}function a(l){n=l,e(1,n)}function c(l){r=l,e(2,r)}return o.$$set=l=>{"controller"in l&&e(3,i=l.controller)},o.$$.update=()=>{o.$$.dirty&14&&n!==void 0&&i.setPointerLocation(n,r),o.$$.dirty&9&&i.pointer_down!==s&&i.setPointerDown(s)},[s,n,r,i,h,a,c]}class ks extends xt{constructor(t){super(),yt(this,t,Hi,Bi,mt,{controller:3})}}class Ds{constructor(){x(this,"width",-1);x(this,"height",-1);x(this,"canvas",null);x(this,"ctx",null);x(this,"dirty",qe(!1))}setCanvas(t){if(this.canvas=t,!(this.ctx=t.getContext("2d")))throw Error("Failed to get canvas context");this.width!==-1&&this.height!==-1&&(t.width=this.width,t.height=this.height),this.dirty.set(!0)}unsetCanvas(){this.canvas=null,this.ctx=null}resize(t,e){console.log("[renderer] resize, width, height",t,e),this.width=t,this.height=e,this.canvas&&(this.canvas.width=t,this.canvas.height=e),this.dirty.set(!0)}clear(){const{ctx:t,width:e,height:i}=this;if(!t)throw Error("Expected rendering context");if(e===-1||i===-1)throw Error("Expected renderer dimensions");t.clearRect(0,0,e,i)}render(t,e){const{ctx:i}=this;if(!i)throw Error("Expected rendering context");if(this.width===-1||this.height===-1)throw Error("Expected renderer dimensions");this.dirty.set(!1);for(const s of t)if(!s.invisible){if(i.beginPath(),i.strokeStyle=s.colorStr||"#fff",s.body._circle)Oi(i,s.body,e);else throw Error("TODO");i.stroke(),s.text&&Fi(i,s,e)}}}const Oi=(o,t,e)=>{const{x:i,y:s}=t,n=t.radius*t.scale,r=(i-e.x)*e.scale+e.width/2,h=(s-e.y)*e.scale+e.height/2;o.moveTo(r+n,h),o.arc(r,h,n,0,Math.PI*2)},Fi=(o,t,e)=>{const i=(t.x-e.x)*e.scale+e.width/2+t.textOffsetX,s=(t.y-e.y)*e.scale+e.height/2+t.textOffsetY;o.textAlign="center",o.textBaseline="middle",o.font=t.font||"30px sans-serif",o.fillText(t.text,i,s)};var se=(o=>(o[o.LINEAR_VERTICAL=0]="LINEAR_VERTICAL",o[o.LINEAR_HORIZONTAL=1]="LINEAR_HORIZONTAL",o))(se||{});const Ct={willReadFrequently:!0},N=class C{static get experimentalLetterSpacingSupported(){let t=C._experimentalLetterSpacingSupported;if(t!==void 0){const e=dt.ADAPTER.getCanvasRenderingContext2D().prototype;t=C._experimentalLetterSpacingSupported="letterSpacing"in e||"textLetterSpacing"in e}return t}constructor(t,e,i,s,n,r,h,a,c){this.text=t,this.style=e,this.width=i,this.height=s,this.lines=n,this.lineWidths=r,this.lineHeight=h,this.maxLineWidth=a,this.fontProperties=c}static measureText(t,e,i,s=C._canvas){i=i??e.wordWrap;const n=e.toFontString(),r=C.measureFont(n);r.fontSize===0&&(r.fontSize=e.fontSize,r.ascent=e.fontSize);const h=s.getContext("2d",Ct);h.font=n;const a=(i?C.wordWrap(t,e,s):t).split(/(?:\r\n|\r|\n)/),c=new Array(a.length);let l=0;for(let f=0;f<a.length;f++){const g=C._measureText(a[f],e.letterSpacing,h);c[f]=g,l=Math.max(l,g)}let u=l+e.strokeThickness;e.dropShadow&&(u+=e.dropShadowDistance);const _=e.lineHeight||r.fontSize+e.strokeThickness;let d=Math.max(_,r.fontSize+e.strokeThickness*2)+e.leading+(a.length-1)*(_+e.leading);return e.dropShadow&&(d+=e.dropShadowDistance),new C(t,e,u,d,a,c,_+e.leading,l,r)}static _measureText(t,e,i){let s=!1;C.experimentalLetterSpacingSupported&&(C.experimentalLetterSpacing?(i.letterSpacing=`${e}px`,i.textLetterSpacing=`${e}px`,s=!0):(i.letterSpacing="0px",i.textLetterSpacing="0px"));let n=i.measureText(t).width;return n>0&&(s?n-=e:n+=(C.graphemeSegmenter(t).length-1)*e),n}static wordWrap(t,e,i=C._canvas){const s=i.getContext("2d",Ct);let n=0,r="",h="";const a=Object.create(null),{letterSpacing:c,whiteSpace:l}=e,u=C.collapseSpaces(l),_=C.collapseNewlines(l);let d=!u;const f=e.wordWrapWidth+c,g=C.tokenize(t);for(let w=0;w<g.length;w++){let y=g[w];if(C.isNewline(y)){if(!_){h+=C.addLine(r),d=!u,r="",n=0;continue}y=" "}if(u){const m=C.isBreakingSpace(y),p=C.isBreakingSpace(r[r.length-1]);if(m&&p)continue}const b=C.getFromCache(y,c,a,s);if(b>f)if(r!==""&&(h+=C.addLine(r),r="",n=0),C.canBreakWords(y,e.breakWords)){const m=C.wordWrapSplit(y);for(let p=0;p<m.length;p++){let k=m[p],v=k,T=1;for(;m[p+T];){const S=m[p+T];if(!C.canBreakChars(v,S,y,p,e.breakWords))k+=S;else break;v=S,T++}p+=T-1;const D=C.getFromCache(k,c,a,s);D+n>f&&(h+=C.addLine(r),d=!1,r="",n=0),r+=k,n+=D}}else{r.length>0&&(h+=C.addLine(r),r="",n=0);const m=w===g.length-1;h+=C.addLine(y,!m),d=!1,r="",n=0}else b+n>f&&(d=!1,h+=C.addLine(r),r="",n=0),(r.length>0||!C.isBreakingSpace(y)||d)&&(r+=y,n+=b)}return h+=C.addLine(r,!1),h}static addLine(t,e=!0){return t=C.trimRight(t),t=e?`${t}
`:t,t}static getFromCache(t,e,i,s){let n=i[t];return typeof n!="number"&&(n=C._measureText(t,e,s)+e,i[t]=n),n}static collapseSpaces(t){return t==="normal"||t==="pre-line"}static collapseNewlines(t){return t==="normal"}static trimRight(t){if(typeof t!="string")return"";for(let e=t.length-1;e>=0;e--){const i=t[e];if(!C.isBreakingSpace(i))break;t=t.slice(0,-1)}return t}static isNewline(t){return typeof t!="string"?!1:C._newlines.includes(t.charCodeAt(0))}static isBreakingSpace(t,e){return typeof t!="string"?!1:C._breakingSpaces.includes(t.charCodeAt(0))}static tokenize(t){const e=[];let i="";if(typeof t!="string")return e;for(let s=0;s<t.length;s++){const n=t[s],r=t[s+1];if(C.isBreakingSpace(n,r)||C.isNewline(n)){i!==""&&(e.push(i),i=""),e.push(n);continue}i+=n}return i!==""&&e.push(i),e}static canBreakWords(t,e){return e}static canBreakChars(t,e,i,s,n){return!0}static wordWrapSplit(t){return C.graphemeSegmenter(t)}static measureFont(t){if(C._fonts[t])return C._fonts[t];const e={ascent:0,descent:0,fontSize:0},i=C._canvas,s=C._context;s.font=t;const n=C.METRICS_STRING+C.BASELINE_SYMBOL,r=Math.ceil(s.measureText(n).width);let h=Math.ceil(s.measureText(C.BASELINE_SYMBOL).width);const a=Math.ceil(C.HEIGHT_MULTIPLIER*h);if(h=h*C.BASELINE_MULTIPLIER|0,r===0||a===0)return C._fonts[t]=e,e;i.width=r,i.height=a,s.fillStyle="#f00",s.fillRect(0,0,r,a),s.font=t,s.textBaseline="alphabetic",s.fillStyle="#000",s.fillText(n,0,h);const c=s.getImageData(0,0,r,a).data,l=c.length,u=r*4;let _=0,d=0,f=!1;for(_=0;_<h;++_){for(let g=0;g<u;g+=4)if(c[d+g]!==255){f=!0;break}if(!f)d+=u;else break}for(e.ascent=h-_,d=l-u,f=!1,_=a;_>h;--_){for(let g=0;g<u;g+=4)if(c[d+g]!==255){f=!0;break}if(!f)d-=u;else break}return e.descent=_-h,e.fontSize=e.ascent+e.descent,C._fonts[t]=e,e}static clearMetrics(t=""){t?delete C._fonts[t]:C._fonts={}}static get _canvas(){var t;if(!C.__canvas){let e;try{const i=new OffscreenCanvas(0,0);if((t=i.getContext("2d",Ct))!=null&&t.measureText)return C.__canvas=i,i;e=dt.ADAPTER.createCanvas()}catch{e=dt.ADAPTER.createCanvas()}e.width=e.height=10,C.__canvas=e}return C.__canvas}static get _context(){return C.__context||(C.__context=C._canvas.getContext("2d",Ct)),C.__context}};N.METRICS_STRING="|ÉqÅ",N.BASELINE_SYMBOL="M",N.BASELINE_MULTIPLIER=1.4,N.HEIGHT_MULTIPLIER=2,N.graphemeSegmenter=(()=>{if(typeof(Intl==null?void 0:Intl.Segmenter)=="function"){const o=new Intl.Segmenter;return t=>[...o.segment(t)].map(e=>e.segment)}return o=>[...o]})(),N.experimentalLetterSpacing=!1,N._fonts={},N._newlines=[10,13],N._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];let rt=N;const zi=["serif","sans-serif","monospace","cursive","fantasy","system-ui"],Ve=class _t{constructor(t){this.styleID=0,this.reset(),zt(this,t,t)}clone(){const t={};return zt(t,this,_t.defaultStyle),new _t(t)}reset(){zt(this,_t.defaultStyle,_t.defaultStyle)}get align(){return this._align}set align(t){this._align!==t&&(this._align=t,this.styleID++)}get breakWords(){return this._breakWords}set breakWords(t){this._breakWords!==t&&(this._breakWords=t,this.styleID++)}get dropShadow(){return this._dropShadow}set dropShadow(t){this._dropShadow!==t&&(this._dropShadow=t,this.styleID++)}get dropShadowAlpha(){return this._dropShadowAlpha}set dropShadowAlpha(t){this._dropShadowAlpha!==t&&(this._dropShadowAlpha=t,this.styleID++)}get dropShadowAngle(){return this._dropShadowAngle}set dropShadowAngle(t){this._dropShadowAngle!==t&&(this._dropShadowAngle=t,this.styleID++)}get dropShadowBlur(){return this._dropShadowBlur}set dropShadowBlur(t){this._dropShadowBlur!==t&&(this._dropShadowBlur=t,this.styleID++)}get dropShadowColor(){return this._dropShadowColor}set dropShadowColor(t){const e=Ft(t);this._dropShadowColor!==e&&(this._dropShadowColor=e,this.styleID++)}get dropShadowDistance(){return this._dropShadowDistance}set dropShadowDistance(t){this._dropShadowDistance!==t&&(this._dropShadowDistance=t,this.styleID++)}get fill(){return this._fill}set fill(t){const e=Ft(t);this._fill!==e&&(this._fill=e,this.styleID++)}get fillGradientType(){return this._fillGradientType}set fillGradientType(t){this._fillGradientType!==t&&(this._fillGradientType=t,this.styleID++)}get fillGradientStops(){return this._fillGradientStops}set fillGradientStops(t){Ui(this._fillGradientStops,t)||(this._fillGradientStops=t,this.styleID++)}get fontFamily(){return this._fontFamily}set fontFamily(t){this.fontFamily!==t&&(this._fontFamily=t,this.styleID++)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.styleID++)}get fontStyle(){return this._fontStyle}set fontStyle(t){this._fontStyle!==t&&(this._fontStyle=t,this.styleID++)}get fontVariant(){return this._fontVariant}set fontVariant(t){this._fontVariant!==t&&(this._fontVariant=t,this.styleID++)}get fontWeight(){return this._fontWeight}set fontWeight(t){this._fontWeight!==t&&(this._fontWeight=t,this.styleID++)}get letterSpacing(){return this._letterSpacing}set letterSpacing(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.styleID++)}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.styleID++)}get leading(){return this._leading}set leading(t){this._leading!==t&&(this._leading=t,this.styleID++)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin!==t&&(this._lineJoin=t,this.styleID++)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit!==t&&(this._miterLimit=t,this.styleID++)}get padding(){return this._padding}set padding(t){this._padding!==t&&(this._padding=t,this.styleID++)}get stroke(){return this._stroke}set stroke(t){const e=Ft(t);this._stroke!==e&&(this._stroke=e,this.styleID++)}get strokeThickness(){return this._strokeThickness}set strokeThickness(t){this._strokeThickness!==t&&(this._strokeThickness=t,this.styleID++)}get textBaseline(){return this._textBaseline}set textBaseline(t){this._textBaseline!==t&&(this._textBaseline=t,this.styleID++)}get trim(){return this._trim}set trim(t){this._trim!==t&&(this._trim=t,this.styleID++)}get whiteSpace(){return this._whiteSpace}set whiteSpace(t){this._whiteSpace!==t&&(this._whiteSpace=t,this.styleID++)}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!==t&&(this._wordWrap=t,this.styleID++)}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.styleID++)}toFontString(){const t=typeof this.fontSize=="number"?`${this.fontSize}px`:this.fontSize;let e=this.fontFamily;Array.isArray(this.fontFamily)||(e=this.fontFamily.split(","));for(let i=e.length-1;i>=0;i--){let s=e[i].trim();!/([\"\'])[^\'\"]+\1/.test(s)&&!zi.includes(s)&&(s=`"${s}"`),e[i]=s}return`${this.fontStyle} ${this.fontVariant} ${this.fontWeight} ${t} ${e.join(",")}`}};Ve.defaultStyle={align:"left",breakWords:!1,dropShadow:!1,dropShadowAlpha:1,dropShadowAngle:Math.PI/6,dropShadowBlur:0,dropShadowColor:"black",dropShadowDistance:5,fill:"black",fillGradientType:se.LINEAR_VERTICAL,fillGradientStops:[],fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,lineJoin:"miter",miterLimit:10,padding:0,stroke:"black",strokeThickness:0,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let De=Ve;function Ft(o){const t=Y.shared,e=i=>{const s=t.setValue(i);return s.alpha===1?s.toHex():s.toRgbaString()};return Array.isArray(o)?o.map(e):e(o)}function Ui(o,t){if(!Array.isArray(o)||!Array.isArray(t)||o.length!==t.length)return!1;for(let e=0;e<o.length;++e)if(o[e]!==t[e])return!1;return!0}function zt(o,t,e){for(const i in e)Array.isArray(t[i])?o[i]=t[i].slice():o[i]=t[i]}const Ni={texture:!0,children:!1,baseTexture:!0},Xe=class Kt extends li{constructor(t,e,i){let s=!1;i||(i=dt.ADAPTER.createCanvas(),s=!0),i.width=3,i.height=3;const n=at.from(i);n.orig=new Vt,n.trim=new Vt,super(n),this._ownCanvas=s,this.canvas=i,this.context=i.getContext("2d",{willReadFrequently:!0}),this._resolution=Kt.defaultResolution??dt.RESOLUTION,this._autoResolution=Kt.defaultAutoResolution,this._text=null,this._style=null,this._styleListener=null,this._font="",this.text=t,this.style=e,this.localStyleID=-1}static get experimentalLetterSpacing(){return rt.experimentalLetterSpacing}static set experimentalLetterSpacing(t){ci("7.1.0","Text.experimentalLetterSpacing is deprecated, use TextMetrics.experimentalLetterSpacing"),rt.experimentalLetterSpacing=t}updateText(t){const e=this._style;if(this.localStyleID!==e.styleID&&(this.dirty=!0,this.localStyleID=e.styleID),!this.dirty&&t)return;this._font=this._style.toFontString();const i=this.context,s=rt.measureText(this._text||" ",this._style,this._style.wordWrap,this.canvas),n=s.width,r=s.height,h=s.lines,a=s.lineHeight,c=s.lineWidths,l=s.maxLineWidth,u=s.fontProperties;this.canvas.width=Math.ceil(Math.ceil(Math.max(1,n)+e.padding*2)*this._resolution),this.canvas.height=Math.ceil(Math.ceil(Math.max(1,r)+e.padding*2)*this._resolution),i.scale(this._resolution,this._resolution),i.clearRect(0,0,this.canvas.width,this.canvas.height),i.font=this._font,i.lineWidth=e.strokeThickness,i.textBaseline=e.textBaseline,i.lineJoin=e.lineJoin,i.miterLimit=e.miterLimit;let _,d;const f=e.dropShadow?2:1;for(let g=0;g<f;++g){const w=e.dropShadow&&g===0,y=w?Math.ceil(Math.max(1,r)+e.padding*2):0,b=y*this._resolution;if(w){i.fillStyle="black",i.strokeStyle="black";const p=e.dropShadowColor,k=e.dropShadowBlur*this._resolution,v=e.dropShadowDistance*this._resolution;i.shadowColor=Y.shared.setValue(p).setAlpha(e.dropShadowAlpha).toRgbaString(),i.shadowBlur=k,i.shadowOffsetX=Math.cos(e.dropShadowAngle)*v,i.shadowOffsetY=Math.sin(e.dropShadowAngle)*v+b}else i.fillStyle=this._generateFillStyle(e,h,s),i.strokeStyle=e.stroke,i.shadowColor="black",i.shadowBlur=0,i.shadowOffsetX=0,i.shadowOffsetY=0;let m=(a-u.fontSize)/2;a-u.fontSize<0&&(m=0);for(let p=0;p<h.length;p++)_=e.strokeThickness/2,d=e.strokeThickness/2+p*a+u.ascent+m,e.align==="right"?_+=l-c[p]:e.align==="center"&&(_+=(l-c[p])/2),e.stroke&&e.strokeThickness&&this.drawLetterSpacing(h[p],_+e.padding,d+e.padding-y,!0),e.fill&&this.drawLetterSpacing(h[p],_+e.padding,d+e.padding-y)}this.updateTexture()}drawLetterSpacing(t,e,i,s=!1){const n=this._style.letterSpacing;let r=!1;if(rt.experimentalLetterSpacingSupported&&(rt.experimentalLetterSpacing?(this.context.letterSpacing=`${n}px`,this.context.textLetterSpacing=`${n}px`,r=!0):(this.context.letterSpacing="0px",this.context.textLetterSpacing="0px")),n===0||r){s?this.context.strokeText(t,e,i):this.context.fillText(t,e,i);return}let h=e;const a=rt.graphemeSegmenter(t);let c=this.context.measureText(t).width,l=0;for(let u=0;u<a.length;++u){const _=a[u];s?this.context.strokeText(_,h,i):this.context.fillText(_,h,i);let d="";for(let f=u+1;f<a.length;++f)d+=a[f];l=this.context.measureText(d).width,h+=c-l+n,c=l}}updateTexture(){const t=this.canvas;if(this._style.trim){const r=Ci(t);r.data&&(t.width=r.width,t.height=r.height,this.context.putImageData(r.data,0,0))}const e=this._texture,i=this._style,s=i.trim?0:i.padding,n=e.baseTexture;e.trim.width=e._frame.width=t.width/this._resolution,e.trim.height=e._frame.height=t.height/this._resolution,e.trim.x=-s,e.trim.y=-s,e.orig.width=e._frame.width-s*2,e.orig.height=e._frame.height-s*2,this._onTextureUpdate(),n.setRealSize(t.width,t.height,this._resolution),e.updateUvs(),this.dirty=!1}_render(t){this._autoResolution&&this._resolution!==t.resolution&&(this._resolution=t.resolution,this.dirty=!0),this.updateText(!0),super._render(t)}updateTransform(){this.updateText(!0),super.updateTransform()}getBounds(t,e){return this.updateText(!0),this._textureID===-1&&(t=!1),super.getBounds(t,e)}getLocalBounds(t){return this.updateText(!0),super.getLocalBounds.call(this,t)}_calculateBounds(){this.calculateVertices(),this._bounds.addQuad(this.vertexData)}_generateFillStyle(t,e,i){const s=t.fill;if(Array.isArray(s)){if(s.length===1)return s[0]}else return s;let n;const r=t.dropShadow?t.dropShadowDistance:0,h=t.padding||0,a=this.canvas.width/this._resolution-r-h*2,c=this.canvas.height/this._resolution-r-h*2,l=s.slice(),u=t.fillGradientStops.slice();if(!u.length){const _=l.length+1;for(let d=1;d<_;++d)u.push(d/_)}if(l.unshift(s[0]),u.unshift(0),l.push(s[s.length-1]),u.push(1),t.fillGradientType===se.LINEAR_VERTICAL){n=this.context.createLinearGradient(a/2,h,a/2,c+h);const _=i.fontProperties.fontSize+t.strokeThickness;for(let d=0;d<e.length;d++){const f=i.lineHeight*(d-1)+_,g=i.lineHeight*d;let w=g;d>0&&f>g&&(w=(g+f)/2);const y=g+_,b=i.lineHeight*(d+1);let m=y;d+1<e.length&&b<y&&(m=(y+b)/2);const p=(m-w)/c;for(let k=0;k<l.length;k++){let v=0;typeof u[k]=="number"?v=u[k]:v=k/l.length;let T=Math.min(1,Math.max(0,w/c+v*p));T=Number(T.toFixed(5)),n.addColorStop(T,l[k])}}}else{n=this.context.createLinearGradient(h,c/2,a+h,c/2);const _=l.length+1;let d=1;for(let f=0;f<l.length;f++){let g;typeof u[f]=="number"?g=u[f]:g=d/_,n.addColorStop(g,l[f]),d++}}return n}destroy(t){typeof t=="boolean"&&(t={children:t}),t=Object.assign({},Ni,t),super.destroy(t),this._ownCanvas&&(this.canvas.height=this.canvas.width=0),this.context=null,this.canvas=null,this._style=null}get width(){return this.updateText(!0),Math.abs(this.scale.x)*this._texture.orig.width}set width(t){this.updateText(!0);const e=pe(this.scale.x)||1;this.scale.x=e*t/this._texture.orig.width,this._width=t}get height(){return this.updateText(!0),Math.abs(this.scale.y)*this._texture.orig.height}set height(t){this.updateText(!0);const e=pe(this.scale.y)||1;this.scale.y=e*t/this._texture.orig.height,this._height=t}get style(){return this._style}set style(t){t=t||{},t instanceof De?this._style=t:this._style=new De(t),this.localStyleID=-1,this.dirty=!0}get text(){return this._text}set text(t){t=String(t??""),this._text!==t&&(this._text=t,this.dirty=!0)}get resolution(){return this._resolution}set resolution(t){this._autoResolution=!1,this._resolution!==t&&(this._resolution=t,this.dirty=!0)}};Xe.defaultAutoResolution=!0;let ji=Xe;const Lt={build(o){const t=o.points;let e,i,s,n,r,h;if(o.type===F.CIRC){const f=o.shape;e=f.x,i=f.y,r=h=f.radius,s=n=0}else if(o.type===F.ELIP){const f=o.shape;e=f.x,i=f.y,r=f.width,h=f.height,s=n=0}else{const f=o.shape,g=f.width/2,w=f.height/2;e=f.x+g,i=f.y+w,r=h=Math.max(0,Math.min(f.radius,Math.min(g,w))),s=g-r,n=w-h}if(!(r>=0&&h>=0&&s>=0&&n>=0)){t.length=0;return}const a=Math.ceil(2.3*Math.sqrt(r+h)),c=a*8+(s?4:0)+(n?4:0);if(t.length=c,c===0)return;if(a===0){t.length=8,t[0]=t[6]=e+s,t[1]=t[3]=i+n,t[2]=t[4]=e-s,t[5]=t[7]=i-n;return}let l=0,u=a*4+(s?2:0)+2,_=u,d=c;{const f=s+r,g=n,w=e+f,y=e-f,b=i+g;if(t[l++]=w,t[l++]=b,t[--u]=b,t[--u]=y,n){const m=i-g;t[_++]=y,t[_++]=m,t[--d]=m,t[--d]=w}}for(let f=1;f<a;f++){const g=Math.PI/2*(f/a),w=s+Math.cos(g)*r,y=n+Math.sin(g)*h,b=e+w,m=e-w,p=i+y,k=i-y;t[l++]=b,t[l++]=p,t[--u]=p,t[--u]=m,t[_++]=m,t[_++]=k,t[--d]=k,t[--d]=b}{const f=s,g=n+h,w=e+f,y=e-f,b=i+g,m=i-g;t[l++]=w,t[l++]=b,t[--d]=m,t[--d]=w,s&&(t[l++]=y,t[l++]=b,t[--d]=m,t[--d]=y)}},triangulate(o,t){const e=o.points,i=t.points,s=t.indices;if(e.length===0)return;let n=i.length/2;const r=n;let h,a;if(o.type!==F.RREC){const l=o.shape;h=l.x,a=l.y}else{const l=o.shape;h=l.x+l.width/2,a=l.y+l.height/2}const c=o.matrix;i.push(o.matrix?c.a*h+c.c*a+c.tx:h,o.matrix?c.b*h+c.d*a+c.ty:a),n++,i.push(e[0],e[1]);for(let l=2;l<e.length;l+=2)i.push(e[l],e[l+1]),s.push(n++,r,n);s.push(r+1,r,n)}};function Me(o,t=!1){const e=o.length;if(e<6)return;let i=0;for(let s=0,n=o[e-2],r=o[e-1];s<e;s+=2){const h=o[s],a=o[s+1];i+=(h-n)*(a+r),n=h,r=a}if(!t&&i>0||t&&i<=0){const s=e/2;for(let n=s+s%2;n<e;n+=2){const r=e-n-2,h=e-n-1,a=n,c=n+1;[o[r],o[a]]=[o[a],o[r]],[o[h],o[c]]=[o[c],o[h]]}}}const Ke={build(o){o.points=o.shape.points.slice()},triangulate(o,t){let e=o.points;const i=o.holes,s=t.points,n=t.indices;if(e.length>=6){Me(e,!1);const r=[];for(let c=0;c<i.length;c++){const l=i[c];Me(l.points,!0),r.push(e.length/2),e=e.concat(l.points)}const h=_i(e,r,2);if(!h)return;const a=s.length/2;for(let c=0;c<h.length;c+=3)n.push(h[c]+a),n.push(h[c+1]+a),n.push(h[c+2]+a);for(let c=0;c<e.length;c++)s.push(e[c])}}},qi={build(o){const t=o.shape,e=t.x,i=t.y,s=t.width,n=t.height,r=o.points;r.length=0,s>=0&&n>=0&&r.push(e,i,e+s,i,e+s,i+n,e,i+n)},triangulate(o,t){const e=o.points,i=t.points;if(e.length===0)return;const s=i.length/2;i.push(e[0],e[1],e[2],e[3],e[6],e[7],e[4],e[5]),t.indices.push(s,s+1,s+2,s+1,s+2,s+3)}},Yi={build(o){Lt.build(o)},triangulate(o,t){Lt.triangulate(o,t)}};var B=(o=>(o.MITER="miter",o.BEVEL="bevel",o.ROUND="round",o))(B||{}),J=(o=>(o.BUTT="butt",o.ROUND="round",o.SQUARE="square",o))(J||{});const lt={adaptive:!0,maxLength:10,minSegments:8,maxSegments:2048,epsilon:1e-4,_segmentsCount(o,t=20){if(!this.adaptive||!o||isNaN(o))return t;let e=Math.ceil(o/this.maxLength);return e<this.minSegments?e=this.minSegments:e>this.maxSegments&&(e=this.maxSegments),e}};class Ie{static curveTo(t,e,i,s,n,r){const h=r[r.length-2],a=r[r.length-1]-e,c=h-t,l=s-e,u=i-t,_=Math.abs(a*u-c*l);if(_<1e-8||n===0)return(r[r.length-2]!==t||r[r.length-1]!==e)&&r.push(t,e),null;const d=a*a+c*c,f=l*l+u*u,g=a*l+c*u,w=n*Math.sqrt(d)/_,y=n*Math.sqrt(f)/_,b=w*g/d,m=y*g/f,p=w*u+y*c,k=w*l+y*a,v=c*(y+b),T=a*(y+b),D=u*(w+m),S=l*(w+m),P=Math.atan2(T-k,v-p),E=Math.atan2(S-k,D-p);return{cx:p+t,cy:k+e,radius:n,startAngle:P,endAngle:E,anticlockwise:c*l>u*a}}static arc(t,e,i,s,n,r,h,a,c){const l=h-r,u=lt._segmentsCount(Math.abs(l)*n,Math.ceil(Math.abs(l)/Xt)*40),_=l/(u*2),d=_*2,f=Math.cos(_),g=Math.sin(_),w=u-1,y=w%1/w;for(let b=0;b<=w;++b){const m=b+y*b,p=_+r+d*m,k=Math.cos(p),v=-Math.sin(p);c.push((f*k+g*v)*n+i,(f*-v+g*k)*n+s)}}}class Gi{constructor(){this.reset()}begin(t,e,i){this.reset(),this.style=t,this.start=e,this.attribStart=i}end(t,e){this.attribSize=e-this.attribStart,this.size=t-this.start}reset(){this.style=null,this.size=0,this.start=0,this.attribStart=0,this.attribSize=0}}class ne{static curveLength(t,e,i,s,n,r,h,a){let c=0,l=0,u=0,_=0,d=0,f=0,g=0,w=0,y=0,b=0,m=0,p=t,k=e;for(let v=1;v<=10;++v)l=v/10,u=l*l,_=u*l,d=1-l,f=d*d,g=f*d,w=g*t+3*f*l*i+3*d*u*n+_*h,y=g*e+3*f*l*s+3*d*u*r+_*a,b=p-w,m=k-y,p=w,k=y,c+=Math.sqrt(b*b+m*m);return c}static curveTo(t,e,i,s,n,r,h){const a=h[h.length-2],c=h[h.length-1];h.length-=2;const l=lt._segmentsCount(ne.curveLength(a,c,t,e,i,s,n,r));let u=0,_=0,d=0,f=0,g=0;h.push(a,c);for(let w=1,y=0;w<=l;++w)y=w/l,u=1-y,_=u*u,d=_*u,f=y*y,g=f*y,h.push(d*a+3*_*y*t+3*u*f*i+g*n,d*c+3*_*y*e+3*u*f*s+g*r)}}function Le(o,t,e,i,s,n,r,h){const a=o-e*s,c=t-i*s,l=o+e*n,u=t+i*n;let _,d;r?(_=i,d=-e):(_=-i,d=e);const f=a+_,g=c+d,w=l+_,y=u+d;return h.push(f,g,w,y),2}function et(o,t,e,i,s,n,r,h){const a=e-o,c=i-t;let l=Math.atan2(a,c),u=Math.atan2(s-o,n-t);h&&l<u?l+=Math.PI*2:!h&&l>u&&(u+=Math.PI*2);let _=l;const d=u-l,f=Math.abs(d),g=Math.sqrt(a*a+c*c),w=(15*f*Math.sqrt(g)/Math.PI>>0)+1,y=d/w;if(_+=y,h){r.push(o,t,e,i);for(let b=1,m=_;b<w;b++,m+=y)r.push(o,t,o+Math.sin(m)*g,t+Math.cos(m)*g);r.push(o,t,s,n)}else{r.push(e,i,o,t);for(let b=1,m=_;b<w;b++,m+=y)r.push(o+Math.sin(m)*g,t+Math.cos(m)*g,o,t);r.push(s,n,o,t)}return w*2}function Vi(o,t){const e=o.shape;let i=o.points||e.points.slice();const s=t.closePointEps;if(i.length===0)return;const n=o.lineStyle,r=new It(i[0],i[1]),h=new It(i[i.length-2],i[i.length-1]),a=e.type!==F.POLY||e.closeStroke,c=Math.abs(r.x-h.x)<s&&Math.abs(r.y-h.y)<s;if(a){i=i.slice(),c&&(i.pop(),i.pop(),h.set(i[i.length-2],i[i.length-1]));const L=(r.x+h.x)*.5,R=(h.y+r.y)*.5;i.unshift(L,R),i.push(L,R)}const l=t.points,u=i.length/2;let _=i.length;const d=l.length/2,f=n.width/2,g=f*f,w=n.miterLimit*n.miterLimit;let y=i[0],b=i[1],m=i[2],p=i[3],k=0,v=0,T=-(b-p),D=y-m,S=0,P=0,E=Math.sqrt(T*T+D*D);T/=E,D/=E,T*=f,D*=f;const z=n.alignment,M=(1-z)*2,I=z*2;a||(n.cap===J.ROUND?_+=et(y-T*(M-I)*.5,b-D*(M-I)*.5,y-T*M,b-D*M,y+T*I,b+D*I,l,!0)+2:n.cap===J.SQUARE&&(_+=Le(y,b,T,D,M,I,!0,l))),l.push(y-T*M,b-D*M,y+T*I,b+D*I);for(let L=1;L<u-1;++L){y=i[(L-1)*2],b=i[(L-1)*2+1],m=i[L*2],p=i[L*2+1],k=i[(L+1)*2],v=i[(L+1)*2+1],T=-(b-p),D=y-m,E=Math.sqrt(T*T+D*D),T/=E,D/=E,T*=f,D*=f,S=-(p-v),P=m-k,E=Math.sqrt(S*S+P*P),S/=E,P/=E,S*=f,P*=f;const R=m-y,U=b-p,H=m-k,V=v-p,Wt=R*H+U*V,X=U*H-V*R,j=X<0;if(Math.abs(X)<.001*Math.abs(Wt)){l.push(m-T*M,p-D*M,m+T*I,p+D*I),Wt>=0&&(n.join===B.ROUND?_+=et(m,p,m-T*M,p-D*M,m-S*M,p-P*M,l,!1)+4:_+=2,l.push(m-S*I,p-P*I,m+S*M,p+P*M));continue}const ct=(-T+y)*(-D+p)-(-T+m)*(-D+b),st=(-S+k)*(-P+p)-(-S+m)*(-P+v),wt=(R*st-H*ct)/X,bt=(V*ct-U*st)/X,ae=(wt-m)*(wt-m)+(bt-p)*(bt-p),Q=m+(wt-m)*M,Z=p+(bt-p)*M,$=m-(wt-m)*I,tt=p-(bt-p)*I,ii=Math.min(R*R+U*U,H*H+V*V),le=j?M:I,si=ii+le*le*g,ni=ae<=si;let vt=n.join;if(vt===B.MITER&&ae/g>w&&(vt=B.BEVEL),ni)switch(vt){case B.MITER:{l.push(Q,Z,$,tt);break}case B.BEVEL:{j?l.push(Q,Z,m+T*I,p+D*I,Q,Z,m+S*I,p+P*I):l.push(m-T*M,p-D*M,$,tt,m-S*M,p-P*M,$,tt),_+=2;break}case B.ROUND:{j?(l.push(Q,Z,m+T*I,p+D*I),_+=et(m,p,m+T*I,p+D*I,m+S*I,p+P*I,l,!0)+4,l.push(Q,Z,m+S*I,p+P*I)):(l.push(m-T*M,p-D*M,$,tt),_+=et(m,p,m-T*M,p-D*M,m-S*M,p-P*M,l,!1)+4,l.push(m-S*M,p-P*M,$,tt));break}}else{switch(l.push(m-T*M,p-D*M,m+T*I,p+D*I),vt){case B.MITER:{j?l.push($,tt,$,tt):l.push(Q,Z,Q,Z),_+=2;break}case B.ROUND:{j?_+=et(m,p,m+T*I,p+D*I,m+S*I,p+P*I,l,!0)+2:_+=et(m,p,m-T*M,p-D*M,m-S*M,p-P*M,l,!1)+2;break}}l.push(m-S*M,p-P*M,m+S*I,p+P*I),_+=2}}y=i[(u-2)*2],b=i[(u-2)*2+1],m=i[(u-1)*2],p=i[(u-1)*2+1],T=-(b-p),D=y-m,E=Math.sqrt(T*T+D*D),T/=E,D/=E,T*=f,D*=f,l.push(m-T*M,p-D*M,m+T*I,p+D*I),a||(n.cap===J.ROUND?_+=et(m-T*(M-I)*.5,p-D*(M-I)*.5,m-T*M,p-D*M,m+T*I,p+D*I,l,!1)+2:n.cap===J.SQUARE&&(_+=Le(m,p,T,D,M,I,!1,l)));const W=t.indices,A=lt.epsilon*lt.epsilon;for(let L=d;L<_+d-2;++L)y=l[L*2],b=l[L*2+1],m=l[(L+1)*2],p=l[(L+1)*2+1],k=l[(L+2)*2],v=l[(L+2)*2+1],!(Math.abs(y*(p-v)+m*(v-b)+k*(b-p))<A)&&W.push(L,L+1,L+2)}function Xi(o,t){let e=0;const i=o.shape,s=o.points||i.points,n=i.type!==F.POLY||i.closeStroke;if(s.length===0)return;const r=t.points,h=t.indices,a=s.length/2,c=r.length/2;let l=c;for(r.push(s[0],s[1]),e=1;e<a;e++)r.push(s[e*2],s[e*2+1]),h.push(l,l+1),l++;n&&h.push(l,c)}function Pe(o,t){o.lineStyle.native?Xi(o,t):Vi(o,t)}class re{static curveLength(t,e,i,s,n,r){const h=t-2*i+n,a=e-2*s+r,c=2*i-2*t,l=2*s-2*e,u=4*(h*h+a*a),_=4*(h*c+a*l),d=c*c+l*l,f=2*Math.sqrt(u+_+d),g=Math.sqrt(u),w=2*u*g,y=2*Math.sqrt(d),b=_/g;return(w*f+g*_*(f-y)+(4*d*u-_*_)*Math.log((2*g+b+f)/(b+y)))/(4*w)}static curveTo(t,e,i,s,n){const r=n[n.length-2],h=n[n.length-1],a=lt._segmentsCount(re.curveLength(r,h,t,e,i,s));let c=0,l=0;for(let u=1;u<=a;++u){const _=u/a;c=r+(t-r)*_,l=h+(e-h)*_,n.push(c+(t+(i-t)*_-c)*_,l+(e+(s-e)*_-l)*_)}}}const Ut={[F.POLY]:Ke,[F.CIRC]:Lt,[F.ELIP]:Lt,[F.RECT]:qi,[F.RREC]:Yi},Ee=[],kt=[];class Pt{constructor(t,e=null,i=null,s=null){this.points=[],this.holes=[],this.shape=t,this.lineStyle=i,this.fillStyle=e,this.matrix=s,this.type=t.type}clone(){return new Pt(this.shape,this.fillStyle,this.lineStyle,this.matrix)}destroy(){this.shape=null,this.holes.length=0,this.holes=null,this.points.length=0,this.points=null,this.lineStyle=null,this.fillStyle=null}}const ot=new It,Je=class Qe extends ui{constructor(){super(),this.closePointEps=1e-4,this.boundsPadding=0,this.uvsFloat32=null,this.indicesUint16=null,this.batchable=!1,this.points=[],this.colors=[],this.uvs=[],this.indices=[],this.textureIds=[],this.graphicsData=[],this.drawCalls=[],this.batchDirty=-1,this.batches=[],this.dirty=0,this.cacheDirty=-1,this.clearDirty=0,this.shapeIndex=0,this._bounds=new di,this.boundsDirty=-1}get bounds(){return this.updateBatches(),this.boundsDirty!==this.dirty&&(this.boundsDirty=this.dirty,this.calculateBounds()),this._bounds}invalidate(){this.boundsDirty=-1,this.dirty++,this.batchDirty++,this.shapeIndex=0,this.points.length=0,this.colors.length=0,this.uvs.length=0,this.indices.length=0,this.textureIds.length=0;for(let t=0;t<this.drawCalls.length;t++)this.drawCalls[t].texArray.clear(),kt.push(this.drawCalls[t]);this.drawCalls.length=0;for(let t=0;t<this.batches.length;t++){const e=this.batches[t];e.reset(),Ee.push(e)}this.batches.length=0}clear(){return this.graphicsData.length>0&&(this.invalidate(),this.clearDirty++,this.graphicsData.length=0),this}drawShape(t,e=null,i=null,s=null){const n=new Pt(t,e,i,s);return this.graphicsData.push(n),this.dirty++,this}drawHole(t,e=null){if(!this.graphicsData.length)return null;const i=new Pt(t,null,null,e),s=this.graphicsData[this.graphicsData.length-1];return i.lineStyle=s.lineStyle,s.holes.push(i),this.dirty++,this}destroy(){super.destroy();for(let t=0;t<this.graphicsData.length;++t)this.graphicsData[t].destroy();this.points.length=0,this.points=null,this.colors.length=0,this.colors=null,this.uvs.length=0,this.uvs=null,this.indices.length=0,this.indices=null,this.indexBuffer.destroy(),this.indexBuffer=null,this.graphicsData.length=0,this.graphicsData=null,this.drawCalls.length=0,this.drawCalls=null,this.batches.length=0,this.batches=null,this._bounds=null}containsPoint(t){const e=this.graphicsData;for(let i=0;i<e.length;++i){const s=e[i];if(s.fillStyle.visible&&s.shape&&(s.matrix?s.matrix.applyInverse(t,ot):ot.copyFrom(t),s.shape.contains(ot.x,ot.y))){let n=!1;if(s.holes){for(let r=0;r<s.holes.length;r++)if(s.holes[r].shape.contains(ot.x,ot.y)){n=!0;break}}if(!n)return!0}}return!1}updateBatches(){if(!this.graphicsData.length){this.batchable=!0;return}if(!this.validateBatching())return;this.cacheDirty=this.dirty;const t=this.uvs,e=this.graphicsData;let i=null,s=null;this.batches.length>0&&(i=this.batches[this.batches.length-1],s=i.style);for(let a=this.shapeIndex;a<e.length;a++){this.shapeIndex++;const c=e[a],l=c.fillStyle,u=c.lineStyle;Ut[c.type].build(c),c.matrix&&this.transformPoints(c.points,c.matrix),(l.visible||u.visible)&&this.processHoles(c.holes);for(let _=0;_<2;_++){const d=_===0?l:u;if(!d.visible)continue;const f=d.texture.baseTexture,g=this.indices.length,w=this.points.length/2;f.wrapMode=me.REPEAT,_===0?this.processFill(c):this.processLine(c);const y=this.points.length/2-w;y!==0&&(i&&!this._compareStyles(s,d)&&(i.end(g,w),i=null),i||(i=Ee.pop()||new Gi,i.begin(d,g,w),this.batches.push(i),s=d),this.addUvs(this.points,t,d.texture,w,y,d.matrix))}}const n=this.indices.length,r=this.points.length/2;if(i&&i.end(n,r),this.batches.length===0){this.batchable=!0;return}const h=r>65535;this.indicesUint16&&this.indices.length===this.indicesUint16.length&&h===this.indicesUint16.BYTES_PER_ELEMENT>2?this.indicesUint16.set(this.indices):this.indicesUint16=h?new Uint32Array(this.indices):new Uint16Array(this.indices),this.batchable=this.isBatchable(),this.batchable?this.packBatches():this.buildDrawCalls()}_compareStyles(t,e){return!(!t||!e||t.texture.baseTexture!==e.texture.baseTexture||t.color+t.alpha!==e.color+e.alpha||!!t.native!=!!e.native)}validateBatching(){if(this.dirty===this.cacheDirty||!this.graphicsData.length)return!1;for(let t=0,e=this.graphicsData.length;t<e;t++){const i=this.graphicsData[t],s=i.fillStyle,n=i.lineStyle;if(s&&!s.texture.baseTexture.valid||n&&!n.texture.baseTexture.valid)return!1}return!0}packBatches(){this.batchDirty++,this.uvsFloat32=new Float32Array(this.uvs);const t=this.batches;for(let e=0,i=t.length;e<i;e++){const s=t[e];for(let n=0;n<s.size;n++){const r=s.start+n;this.indicesUint16[r]=this.indicesUint16[r]-s.attribStart}}}isBatchable(){if(this.points.length>65535*2)return!1;const t=this.batches;for(let e=0;e<t.length;e++)if(t[e].style.native)return!1;return this.points.length<Qe.BATCHABLE_SIZE*2}buildDrawCalls(){let t=++xe._globalBatch;for(let u=0;u<this.drawCalls.length;u++)this.drawCalls[u].texArray.clear(),kt.push(this.drawCalls[u]);this.drawCalls.length=0;const e=this.colors,i=this.textureIds;let s=kt.pop();s||(s=new ye,s.texArray=new we),s.texArray.count=0,s.start=0,s.size=0,s.type=Tt.TRIANGLES;let n=0,r=null,h=0,a=!1,c=Tt.TRIANGLES,l=0;this.drawCalls.push(s);for(let u=0;u<this.batches.length;u++){const _=this.batches[u],d=8,f=_.style,g=f.texture.baseTexture;a!==!!f.native&&(a=!!f.native,c=a?Tt.LINES:Tt.TRIANGLES,r=null,n=d,t++),r!==g&&(r=g,g._batchEnabled!==t&&(n===d&&(t++,n=0,s.size>0&&(s=kt.pop(),s||(s=new ye,s.texArray=new we),this.drawCalls.push(s)),s.start=l,s.size=0,s.texArray.count=0,s.type=c),g.touched=1,g._batchEnabled=t,g._batchLocation=n,g.wrapMode=me.REPEAT,s.texArray.elements[s.texArray.count++]=g,n++)),s.size+=_.size,l+=_.size,h=g._batchLocation,this.addColors(e,f.color,f.alpha,_.attribSize,_.attribStart),this.addTextureIds(i,h,_.attribSize,_.attribStart)}xe._globalBatch=t,this.packAttributes()}packAttributes(){const t=this.points,e=this.uvs,i=this.colors,s=this.textureIds,n=new ArrayBuffer(t.length*3*4),r=new Float32Array(n),h=new Uint32Array(n);let a=0;for(let c=0;c<t.length/2;c++)r[a++]=t[c*2],r[a++]=t[c*2+1],r[a++]=e[c*2],r[a++]=e[c*2+1],h[a++]=i[c],r[a++]=s[c];this._buffer.update(n),this._indexBuffer.update(this.indicesUint16)}processFill(t){t.holes.length?Ke.triangulate(t,this):Ut[t.type].triangulate(t,this)}processLine(t){Pe(t,this);for(let e=0;e<t.holes.length;e++)Pe(t.holes[e],this)}processHoles(t){for(let e=0;e<t.length;e++){const i=t[e];Ut[i.type].build(i),i.matrix&&this.transformPoints(i.points,i.matrix)}}calculateBounds(){const t=this._bounds;t.clear(),t.addVertexData(this.points,0,this.points.length),t.pad(this.boundsPadding,this.boundsPadding)}transformPoints(t,e){for(let i=0;i<t.length/2;i++){const s=t[i*2],n=t[i*2+1];t[i*2]=e.a*s+e.c*n+e.tx,t[i*2+1]=e.b*s+e.d*n+e.ty}}addColors(t,e,i,s,n=0){const r=Y.shared.setValue(e).toLittleEndianNumber(),h=Y.shared.setValue(r).toPremultiplied(i);t.length=Math.max(t.length,n+s);for(let a=0;a<s;a++)t[n+a]=h}addTextureIds(t,e,i,s=0){t.length=Math.max(t.length,s+i);for(let n=0;n<i;n++)t[s+n]=e}addUvs(t,e,i,s,n,r=null){let h=0;const a=e.length,c=i.frame;for(;h<n;){let u=t[(s+h)*2],_=t[(s+h)*2+1];if(r){const d=r.a*u+r.c*_+r.tx;_=r.b*u+r.d*_+r.ty,u=d}h++,e.push(u/c.width,_/c.height)}const l=i.baseTexture;(c.width<l.width||c.height<l.height)&&this.adjustUvs(e,i,a,n)}adjustUvs(t,e,i,s){const n=e.baseTexture,r=1e-6,h=i+s*2,a=e.frame,c=a.width/n.width,l=a.height/n.height;let u=a.x/a.width,_=a.y/a.height,d=Math.floor(t[i]+r),f=Math.floor(t[i+1]+r);for(let g=i+2;g<h;g+=2)d=Math.min(d,Math.floor(t[g]+r)),f=Math.min(f,Math.floor(t[g+1]+r));u-=d,_-=f;for(let g=i;g<h;g+=2)t[g]=(t[g]+u)*c,t[g+1]=(t[g+1]+_)*l}};Je.BATCHABLE_SIZE=100;let Ki=Je;class Rt{constructor(){this.color=16777215,this.alpha=1,this.texture=at.WHITE,this.matrix=null,this.visible=!1,this.reset()}clone(){const t=new Rt;return t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.matrix=this.matrix,t.visible=this.visible,t}reset(){this.color=16777215,this.alpha=1,this.texture=at.WHITE,this.matrix=null,this.visible=!1}destroy(){this.texture=null,this.matrix=null}}class oe extends Rt{constructor(){super(...arguments),this.width=0,this.alignment=.5,this.native=!1,this.cap=J.BUTT,this.join=B.MITER,this.miterLimit=10}clone(){const t=new oe;return t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.matrix=this.matrix,t.visible=this.visible,t.width=this.width,t.alignment=this.alignment,t.native=this.native,t.cap=this.cap,t.join=this.join,t.miterLimit=this.miterLimit,t}reset(){super.reset(),this.color=0,this.alignment=.5,this.width=0,this.native=!1,this.cap=J.BUTT,this.join=B.MITER,this.miterLimit=10}}const Nt={},Jt=class Dt extends ie{constructor(t=null){super(),this.shader=null,this.pluginName="batch",this.currentPath=null,this.batches=[],this.batchTint=-1,this.batchDirty=-1,this.vertexData=null,this._fillStyle=new Rt,this._lineStyle=new oe,this._matrix=null,this._holeMode=!1,this.state=fi.for2d(),this._geometry=t||new Ki,this._geometry.refCount++,this._transformID=-1,this._tintColor=new Y(16777215),this.blendMode=gi.NORMAL}get geometry(){return this._geometry}clone(){return this.finishPoly(),new Dt(this._geometry)}set blendMode(t){this.state.blendMode=t}get blendMode(){return this.state.blendMode}get tint(){return this._tintColor.value}set tint(t){this._tintColor.setValue(t)}get fill(){return this._fillStyle}get line(){return this._lineStyle}lineStyle(t=null,e=0,i,s=.5,n=!1){return typeof t=="number"&&(t={width:t,color:e,alpha:i,alignment:s,native:n}),this.lineTextureStyle(t)}lineTextureStyle(t){const e={width:0,texture:at.WHITE,color:t!=null&&t.texture?16777215:0,matrix:null,alignment:.5,native:!1,cap:J.BUTT,join:B.MITER,miterLimit:10};t=Object.assign(e,t),this.normalizeColor(t),this.currentPath&&this.startPoly();const i=t.width>0&&t.alpha>0;return i?(t.matrix&&(t.matrix=t.matrix.clone(),t.matrix.invert()),Object.assign(this._lineStyle,{visible:i},t)):this._lineStyle.reset(),this}startPoly(){if(this.currentPath){const t=this.currentPath.points,e=this.currentPath.points.length;e>2&&(this.drawShape(this.currentPath),this.currentPath=new Ot,this.currentPath.closeStroke=!1,this.currentPath.points.push(t[e-2],t[e-1]))}else this.currentPath=new Ot,this.currentPath.closeStroke=!1}finishPoly(){this.currentPath&&(this.currentPath.points.length>2?(this.drawShape(this.currentPath),this.currentPath=null):this.currentPath.points.length=0)}moveTo(t,e){return this.startPoly(),this.currentPath.points[0]=t,this.currentPath.points[1]=e,this}lineTo(t,e){this.currentPath||this.moveTo(0,0);const i=this.currentPath.points,s=i[i.length-2],n=i[i.length-1];return(s!==t||n!==e)&&i.push(t,e),this}_initCurve(t=0,e=0){this.currentPath?this.currentPath.points.length===0&&(this.currentPath.points=[t,e]):this.moveTo(t,e)}quadraticCurveTo(t,e,i,s){this._initCurve();const n=this.currentPath.points;return n.length===0&&this.moveTo(0,0),re.curveTo(t,e,i,s,n),this}bezierCurveTo(t,e,i,s,n,r){return this._initCurve(),ne.curveTo(t,e,i,s,n,r,this.currentPath.points),this}arcTo(t,e,i,s,n){this._initCurve(t,e);const r=this.currentPath.points,h=Ie.curveTo(t,e,i,s,n,r);if(h){const{cx:a,cy:c,radius:l,startAngle:u,endAngle:_,anticlockwise:d}=h;this.arc(a,c,l,u,_,d)}return this}arc(t,e,i,s,n,r=!1){if(s===n)return this;if(!r&&n<=s?n+=Xt:r&&s<=n&&(s+=Xt),n-s===0)return this;const h=t+Math.cos(s)*i,a=e+Math.sin(s)*i,c=this._geometry.closePointEps;let l=this.currentPath?this.currentPath.points:null;if(l){const u=Math.abs(l[l.length-2]-h),_=Math.abs(l[l.length-1]-a);u<c&&_<c||l.push(h,a)}else this.moveTo(h,a),l=this.currentPath.points;return Ie.arc(h,a,t,e,i,s,n,r,l),this}beginFill(t=0,e){return this.beginTextureFill({texture:at.WHITE,color:t,alpha:e})}normalizeColor(t){const e=Y.shared.setValue(t.color??0);t.color=e.toNumber(),t.alpha??(t.alpha=e.alpha)}beginTextureFill(t){const e={texture:at.WHITE,color:16777215,matrix:null};t=Object.assign(e,t),this.normalizeColor(t),this.currentPath&&this.startPoly();const i=t.alpha>0;return i?(t.matrix&&(t.matrix=t.matrix.clone(),t.matrix.invert()),Object.assign(this._fillStyle,{visible:i},t)):this._fillStyle.reset(),this}endFill(){return this.finishPoly(),this._fillStyle.reset(),this}drawRect(t,e,i,s){return this.drawShape(new Vt(t,e,i,s))}drawRoundedRect(t,e,i,s,n){return this.drawShape(new pi(t,e,i,s,n))}drawCircle(t,e,i){return this.drawShape(new mi(t,e,i))}drawEllipse(t,e,i,s){return this.drawShape(new xi(t,e,i,s))}drawPolygon(...t){let e,i=!0;const s=t[0];s.points?(i=s.closeStroke,e=s.points):Array.isArray(t[0])?e=t[0]:e=t;const n=new Ot(e);return n.closeStroke=i,this.drawShape(n),this}drawShape(t){return this._holeMode?this._geometry.drawHole(t,this._matrix):this._geometry.drawShape(t,this._fillStyle.clone(),this._lineStyle.clone(),this._matrix),this}clear(){return this._geometry.clear(),this._lineStyle.reset(),this._fillStyle.reset(),this._boundsID++,this._matrix=null,this._holeMode=!1,this.currentPath=null,this}isFastRect(){const t=this._geometry.graphicsData;return t.length===1&&t[0].shape.type===F.RECT&&!t[0].matrix&&!t[0].holes.length&&!(t[0].lineStyle.visible&&t[0].lineStyle.width)}_render(t){this.finishPoly();const e=this._geometry;e.updateBatches(),e.batchable?(this.batchDirty!==e.batchDirty&&this._populateBatches(),this._renderBatched(t)):(t.batch.flush(),this._renderDirect(t))}_populateBatches(){const t=this._geometry,e=this.blendMode,i=t.batches.length;this.batchTint=-1,this._transformID=-1,this.batchDirty=t.batchDirty,this.batches.length=i,this.vertexData=new Float32Array(t.points);for(let s=0;s<i;s++){const n=t.batches[s],r=n.style.color,h=new Float32Array(this.vertexData.buffer,n.attribStart*4*2,n.attribSize*2),a=new Float32Array(t.uvsFloat32.buffer,n.attribStart*4*2,n.attribSize*2),c=new Uint16Array(t.indicesUint16.buffer,n.start*2,n.size),l={vertexData:h,blendMode:e,indices:c,uvs:a,_batchRGB:Y.shared.setValue(r).toRgbArray(),_tintRGB:r,_texture:n.style.texture,alpha:n.style.alpha,worldAlpha:1};this.batches[s]=l}}_renderBatched(t){if(this.batches.length){t.batch.setObjectRenderer(t.plugins[this.pluginName]),this.calculateVertices(),this.calculateTints();for(let e=0,i=this.batches.length;e<i;e++){const s=this.batches[e];s.worldAlpha=this.worldAlpha*s.alpha,t.plugins[this.pluginName].render(s)}}}_renderDirect(t){const e=this._resolveDirectShader(t),i=this._geometry,s=this.worldAlpha,n=e.uniforms,r=i.drawCalls;n.translationMatrix=this.transform.worldTransform,Y.shared.setValue(this._tintColor).premultiply(s).toArray(n.tint),t.shader.bind(e),t.geometry.bind(i,e),t.state.set(this.state);for(let h=0,a=r.length;h<a;h++)this._renderDrawCallDirect(t,i.drawCalls[h])}_renderDrawCallDirect(t,e){const{texArray:i,type:s,size:n,start:r}=e,h=i.count;for(let a=0;a<h;a++)t.texture.bind(i.elements[a],a);t.geometry.draw(s,n,r)}_resolveDirectShader(t){let e=this.shader;const i=this.pluginName;if(!e){if(!Nt[i]){const{maxTextures:s}=t.plugins[i],n=new Int32Array(s);for(let a=0;a<s;a++)n[a]=a;const r={tint:new Float32Array([1,1,1,1]),translationMatrix:new yi,default:wi.from({uSamplers:n},!0)},h=t.plugins[i]._shader.program;Nt[i]=new bi(h,r)}e=Nt[i]}return e}_calculateBounds(){this.finishPoly();const t=this._geometry;if(!t.graphicsData.length)return;const{minX:e,minY:i,maxX:s,maxY:n}=t.bounds;this._bounds.addFrame(this.transform,e,i,s,n)}containsPoint(t){return this.worldTransform.applyInverse(t,Dt._TEMP_POINT),this._geometry.containsPoint(Dt._TEMP_POINT)}calculateTints(){if(this.batchTint!==this.tint){this.batchTint=this._tintColor.toNumber();for(let t=0;t<this.batches.length;t++){const e=this.batches[t];e._tintRGB=Y.shared.setValue(this._tintColor).multiply(e._batchRGB).toLittleEndianNumber()}}}calculateVertices(){const t=this.transform._worldID;if(this._transformID===t)return;this._transformID=t;const e=this.transform.worldTransform,i=e.a,s=e.b,n=e.c,r=e.d,h=e.tx,a=e.ty,c=this._geometry.points,l=this.vertexData;let u=0;for(let _=0;_<c.length;_+=2){const d=c[_],f=c[_+1];l[u++]=i*d+n*f+h,l[u++]=r*f+s*d+a}}closePath(){const t=this.currentPath;return t&&(t.closeStroke=!0,this.finishPoly()),this}setMatrix(t){return this._matrix=t,this}beginHole(){return this.finishPoly(),this._holeMode=!0,this}endHole(){return this.finishPoly(),this._holeMode=!1,this}destroy(t){this._geometry.refCount--,this._geometry.refCount===0&&this._geometry.dispose(),this._matrix=null,this.currentPath=null,this._lineStyle.destroy(),this._lineStyle=null,this._fillStyle.destroy(),this._fillStyle=null,this._geometry=null,this.shader=null,this.vertexData=null,this.batches.length=0,this.batches=null,super.destroy(t)}};Jt.curves=lt,Jt._TEMP_POINT=new It;let Qt=Jt;const he=[.611,1,.7],Ji=Ye(...he),Qi=Ge(...he),Ae=3,Zi=1,Ms=1;class $i{constructor(t,e=new ie){x(this,"speed",0);x(this,"strength",Zi);x(this,"directionX",0);x(this,"directionY",0);x(this,"_radius",0);x(this,"_invisible",!1);x(this,"dead",!1);x(this,"ghostly",!1);x(this,"disableSimulation",!1);x(this,"_color",he);x(this,"colorStr",Ji);x(this,"colorHex",Qi);x(this,"text",null);x(this,"textOffsetX",0);x(this,"textOffsetY",0);x(this,"_fontFamily","Arial");x(this,"_fontSize",26);x(this,"_font","26px Arial");x(this,"_x");x(this,"_y");x(this,"graphics");x(this,"drawn",!1);this.body=t,this.container=e,t.entity=this,this.x=t.x,this.y=t.y,t._circle&&(this.radius=t.radius)}get radius(){return this._radius}set radius(t){this._radius=t,this.body._circle&&(this.body.radius=t)}get invisible(){return this._invisible}set invisible(t){this._invisible=t,this.container.visible=!t}get color(){return this._color}set color(t){const{_color:e}=this;if(t===e)return;const[i,s,n]=t,[r,h,a]=e;if(i===r&&s===h&&n===a)return;this._color=t,this.colorStr=Ye(i,s,n);const c=this.colorHex=Ge(i,s,n);this.graphics&&(this.graphics.tint=c)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this._font=`${t}px ${this._fontFamily}`}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this._font=`${this._fontSize}px ${t}`}get font(){return this._font}get x(){return this._x}set x(t){this._x=t,this.body.x=t,this.container.x=t}get y(){return this._y}set y(t){this._y=t,this.body.y=t,this.container.y=t}draw(){if(this.drawn)throw Error("TODO allow drawing an entity more than once");this.drawn=!0;const{body:t}=this;if(t._circle){const e=this.graphics=new Qt;this.container.addChild(e),e.lineStyle(Ae,16777215),e.beginFill(0,0),e.drawCircle(0,0,this.radius),e.endFill(),e.tint=this.colorHex}else if(t._polygon){const e=this.graphics=new Qt;this.container.addChild(e),e.lineStyle(Ae,16777215),e.beginFill(0,0),e.rotation=t.angle,e.drawPolygon(Array.from(t._points)),e.endFill(),e.tint=this.colorHex}if(this.text){const e=new ji(this.text,{fontSize:this.fontSize,fontFamily:this.fontFamily});(this.textOffsetX||this.textOffsetY)&&e.position.set(this.textOffsetX,this.textOffsetY),this.container.addChild(e),e.anchor.set(.5,.5)}}destroy(){this.dead=!0,this.container.destroy({children:!0,texture:!0,baseTexture:!0})}}const ts=(...o)=>{let t=0,e=0,i=0,s=1;const n=o.length?o:[Date.now()];let r=es();t=r(" "),e=r(" "),i=r(" ");for(const a of n)t-=r(a),t<0&&(t+=1),e-=r(a),e<0&&(e+=1),i-=r(a),i<0&&(i+=1);r=null;const h=()=>{const a=2091639*t+s*23283064365386963e-26;return t=e,e=i,i=a-(s=a|0)};return h.uint32=()=>h()*4294967296,h.fract53=()=>h()+(h()*2097152|0)*11102230246251565e-32,h.version="Alea 0.9",h.seeds=n,h},es=()=>{let o=4022871197;return t=>{const e=t+"";for(let i=0;i<e.length;i++){o+=e.charCodeAt(i);let s=.02519603282416938*o;o=s>>>0,s-=o,s*=o,o=s>>>0,s-=o,o+=s*4294967296}return(o>>>0)*23283064365386963e-26}};function Ze(o,t,e=null,i=!0){const s=o._polygon,n=t._polygon;let r=!1;return e&&(e.a=o,e.b=t,e.a_in_b=!0,e.b_in_a=!0,e.overlap=null,e.overlap_x=0,e.overlap_y=0),s&&(o._dirty_coords||o.x!==o._x||o.y!==o._y||o.angle!==o._angle||o.scale_x!==o._scale_x||o.scale_y!==o._scale_y)&&o._calculate_coords(),n&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculate_coords(),(!i||is(o,t))&&(s&&o._dirty_normals&&o._calculate_normals(),n&&t._dirty_normals&&t._calculate_normals(),r=s&&n?ss(o,t,e):s?Re(o,t,e,!1):n?Re(t,o,e,!0):ns(o,t,e)),e&&(e.collision=r),r}const is=(o,t)=>{const e=o._polygon,i=e?0:o.x,s=e?0:o.y,n=e?0:o.radius*o.scale,r=e?o._min_x:i-n,h=e?o._min_y:s-n,a=e?o._max_x:i+n,c=e?o._max_y:s+n,l=t._polygon,u=l?0:t.x,_=l?0:t.y,d=l?0:t.radius*t.scale,f=l?t._min_x:u-d,g=l?t._min_y:_-d,w=l?t._max_x:u+d,y=l?t._max_y:_+d;return r<w&&h<y&&a>f&&c>g},ss=(o,t,e=null)=>{const i=o._coords.length,s=t._coords.length;if(i===2&&s===2){const c=o._coords,l=t._coords;return e&&(e.overlap=0),c[0]===l[0]&&c[1]===l[1]}const n=o._coords,r=t._coords,h=o._normals,a=t._normals;if(i>2){for(let c=0,l=1;c<i;c+=2,l+=2)if(We(n,r,h[c],h[l],e))return!1}if(s>2){for(let c=0,l=1;c<s;c+=2,l+=2)if(We(n,r,a[c],a[l],e))return!1}return!0},Re=(o,t,e=null,i=!1)=>{const s=o._coords,n=o._edges,r=o._normals,h=t.x,a=t.y,c=t.radius*t.scale,l=c*2,u=c*c,_=s.length;let d=!0,f=!0,g=null,w=0,y=0;if(_===2){const b=h-s[0],m=a-s[1],p=b*b+m*m;if(p>u)return!1;if(e){const k=Math.sqrt(p);g=c-k,w=b/k,y=m/k,f=!1}}else for(let b=0,m=1;b<_;b+=2,m+=2){const p=h-s[b],k=a-s[m],v=n[b],T=n[m],D=p*v+k*T,S=D<0?-1:D>v*v+T*T?1:0;let P=!1,E=0,z=0,M=0;if(e&&d&&p*p+k*k>u&&(d=!1),S){const I=S===-1,W=I?b===0?_-2:b-2:b===_-2?0:b+2,A=W+1,L=h-s[W],R=a-s[A],U=n[W],H=n[A],V=L*U+R*H;if((V<0?-1:V>U*U+H*H?1:0)===-S){const X=I?p:L,j=I?k:R,ct=X*X+j*j;if(ct>u)return!1;if(e){const st=Math.sqrt(ct);P=!0,E=c-st,z=X/st,M=j/st,f=!1}}}else{const I=r[b],W=r[m],A=p*I+k*W,L=A<0?-A:A;if(A>0&&L>c)return!1;e&&(P=!0,E=c-A,z=I,M=W,(f&&A>=0||E<l)&&(f=!1))}P&&(g===null||g>E)&&(g=E,w=z,y=M)}return e&&(e.a_in_b=i?f:d,e.b_in_a=i?d:f,e.overlap=g,e.overlap_x=i?-w:w,e.overlap_y=i?-y:y),!0},ns=(o,t,e=null)=>{const i=o.radius*o.scale,s=t.radius*t.scale,n=t.x-o.x,r=t.y-o.y,h=i+s,a=n*n+r*r;if(a>h*h)return!1;if(e){const c=Math.sqrt(a);e.a_in_b=i<=s&&c<=s-i,e.b_in_a=s<=i&&c<=i-s,e.overlap=h-c,e.overlap_x=n/c,e.overlap_y=r/c}return!0},We=(o,t,e,i,s=null)=>{const n=o.length,r=t.length;if(!n||!r)return!0;let h=null,a=null,c=null,l=null;for(let u=0,_=1;u<n;u+=2,_+=2){const d=o[u]*e+o[_]*i;(h===null||h>d)&&(h=d),(a===null||a<d)&&(a=d)}for(let u=0,_=1;u<r;u+=2,_+=2){const d=t[u]*e+t[_]*i;(c===null||c>d)&&(c=d),(l===null||l<d)&&(l=d)}if(h>l||a<c)return!0;if(s){let u=0;if(h<c)if(s.a_in_b=!1,a<l)u=a-c,s.b_in_a=!1;else{const f=a-c,g=l-h;u=f<g?f:-g}else if(s.b_in_a=!1,a>l)u=h-l,s.a_in_b=!1;else{const f=a-c,g=l-h;u=f<g?f:-g}const _=s.overlap,d=u<0?-u:u;if(_===null||_>d){const f=u<0?-1:1;s.overlap=d,s.overlap_x=e*f,s.overlap_y=i*f}}return!1};class $e{constructor(t=0,e=0,i=0){x(this,"_circle",!1);x(this,"_polygon",!1);x(this,"_point",!1);x(this,"x");x(this,"y");x(this,"padding");x(this,"_bvh_branch",!1);x(this,"_bvh",null);x(this,"_bvh_parent",null);x(this,"_bvh_padding");x(this,"_bvh_min_x",0);x(this,"_bvh_min_y",0);x(this,"_bvh_max_x",0);x(this,"_bvh_max_y",0);this.x=t,this.y=e,this.padding=i,this._bvh_padding=i}collides(t,e=null,i=!0){return Ze(this,t,e,i)}potentials(t,e){const i=this._bvh;if(i===null)throw new Error("Body does not belong to a collision system");return i.potentials(this,t,e)}remove(){const t=this._bvh;t&&t.remove(this,!1)}}const jt=[];class Et{constructor(){x(this,"_bvh_branch",!0);x(this,"_bvh_parent",null);x(this,"_bvh_left",null);x(this,"_bvh_right",null);x(this,"_bvh_sort",0);x(this,"_bvh_min_x",0);x(this,"_bvh_min_y",0);x(this,"_bvh_max_x",0);x(this,"_bvh_max_y",0)}static get_branch(){return jt.length?jt.pop():new Et}static release_branch(t){jt.push(t)}static sort_branches(t,e){return t._bvh_sort>e._bvh_sort?-1:1}}class rs{constructor(){x(this,"_hierarchy",null);x(this,"_bodies",[]);x(this,"_dirty_branches",[])}insert(t,e=!1){if(!e){const f=t._bvh;if(f&&f!==this)throw new Error("Body belongs to another collision system");t._bvh=this,this._bodies.push(t)}const i=t._polygon,s=t.x,n=t.y;i&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculate_coords();const r=t._bvh_padding,h=i?0:t.radius*t.scale,a=(i?t._min_x:s-h)-r,c=(i?t._min_y:n-h)-r,l=(i?t._max_x:s+h)+r,u=(i?t._max_y:n+h)+r;t._bvh_min_x=a,t._bvh_min_y=c,t._bvh_max_x=l,t._bvh_max_y=u;let _=this._hierarchy,d=0;if(!_)this._hierarchy=t;else for(;;)if(_._bvh_branch){const f=_._bvh_left,g=f._bvh_min_y,w=f._bvh_max_x,y=f._bvh_max_y,b=a<f._bvh_min_x?a:f._bvh_min_x,m=c<g?c:g,p=l>w?l:w,k=u>y?u:y,v=(w-f._bvh_min_x)*(y-g),D=(p-b)*(k-m)-v,S=_._bvh_right,P=S._bvh_min_x,E=S._bvh_min_y,z=S._bvh_max_x,M=S._bvh_max_y,I=a<P?a:P,W=c<E?c:E,A=l>z?l:z,L=u>M?u:M,R=(z-P)*(M-E),H=(A-I)*(L-W)-R;_._bvh_sort=d++,_._bvh_min_x=b<I?b:I,_._bvh_min_y=m<W?m:W,_._bvh_max_x=p>A?p:A,_._bvh_max_y=k>L?k:L,_=D<=H?f:S}else{const f=_._bvh_parent,g=_._bvh_min_x,w=_._bvh_min_y,y=_._bvh_max_x,b=_._bvh_max_y,m=_._bvh_parent=t._bvh_parent=Et.get_branch();m._bvh_parent=f,m._bvh_left=_,m._bvh_right=t,m._bvh_sort=d++,m._bvh_min_x=a<g?a:g,m._bvh_min_y=c<w?c:w,m._bvh_max_x=l>y?l:y,m._bvh_max_y=u>b?u:b,f?f._bvh_left===_?f._bvh_left=m:f._bvh_right=m:this._hierarchy=m;break}}remove(t,e=!1){if(!e){const h=t._bvh;if(h&&h!==this)throw new Error("Body belongs to another collision system");t._bvh=null,this._bodies.splice(this._bodies.indexOf(t),1)}if(this._hierarchy===t){this._hierarchy=null;return}const i=t._bvh_parent,s=i._bvh_parent,n=i._bvh_left,r=n===t?i._bvh_right:n;if(r._bvh_parent=s,r._bvh_branch&&(r._bvh_sort=i._bvh_sort),s){s._bvh_left===i?s._bvh_left=r:s._bvh_right=r;let h=s;for(;h;){const a=h._bvh_left,c=a._bvh_min_x,l=a._bvh_min_y,u=a._bvh_max_x,_=a._bvh_max_y,d=h._bvh_right,f=d._bvh_min_x,g=d._bvh_min_y,w=d._bvh_max_x,y=d._bvh_max_y;h._bvh_min_x=c<f?c:f,h._bvh_min_y=l<g?l:g,h._bvh_max_x=u>w?u:w,h._bvh_max_y=_>y?_:y,h=h._bvh_parent}}else this._hierarchy=r;Et.release_branch(i)}update(){const t=this._bodies,e=t.length;for(let i=0;i<e;++i){let s=t[i],n=!1;if(!n&&s.padding!==s._bvh_padding&&(s._bvh_padding=s.padding,n=!0),!n){const r=s._polygon;r&&(s=s,(s._dirty_coords||s.x!==s._x||s.y!==s._y||s.angle!==s._angle||s.scale_x!==s._scale_x||s.scale_y!==s._scale_y)&&s._calculate_coords());const h=s.x,a=s.y,c=r?0:s.radius*s.scale,l=r?s._min_x:h-c,u=r?s._min_y:a-c,_=r?s._max_x:h+c,d=r?s._max_y:a+c;n=l<s._bvh_min_x||u<s._bvh_min_y||_>s._bvh_max_x||d>s._bvh_max_y}n&&(this.remove(s,!0),this.insert(s,!0))}}potentials(t,e,i=[]){const s=t._bvh_min_x,n=t._bvh_min_y,r=t._bvh_max_x,h=t._bvh_max_y;let a=this._hierarchy,c=!0;if(!a||!a._bvh_branch)return i;for(;a;){if(c){c=!1;let u=a._bvh_branch?a._bvh_left:null;for(;u&&u._bvh_max_x>=s&&u._bvh_max_y>=n&&u._bvh_min_x<=r&&u._bvh_min_y<=h;)a=u,u=a._bvh_branch?a._bvh_left:null}const l=a._bvh_branch?a._bvh_right:null;if(l&&l._bvh_max_x>s&&l._bvh_max_y>n&&l._bvh_min_x<r&&l._bvh_min_y<h)a=l,c=!0;else{!a._bvh_branch&&a!==t&&(!e||e(t,a))&&i.push(a);let u=a._bvh_parent;if(u){for(;u&&u._bvh_right===a;)a=u,u=a._bvh_parent;a=u}else break}}return i}}class os extends $e{constructor(e=0,i=0,s=0,n=1,r=0){super(e,i,r);x(this,"_polygon",!1);x(this,"_circle",!0);x(this,"_point",!1);x(this,"radius");x(this,"scale");this.radius=s,this.scale=n}}class ti extends $e{constructor(e=0,i=0,s=[],n=0,r=1,h=1,a=0){super(e,i,a);x(this,"_polygon",!0);x(this,"_circle",!1);x(this,"_point",!1);x(this,"angle");x(this,"scale_x");x(this,"scale_y");x(this,"_x");x(this,"_y");x(this,"_angle");x(this,"_scale_x");x(this,"_scale_y");x(this,"_min_x",0);x(this,"_min_y",0);x(this,"_max_x",0);x(this,"_max_y",0);x(this,"_points",null);x(this,"_coords",null);x(this,"_edges",null);x(this,"_normals",null);x(this,"_dirty_coords",!0);x(this,"_dirty_normals",!0);this.angle=n,this.scale_x=r,this.scale_y=h,this._x=e,this._y=i,this._angle=n,this._scale_x=r,this._scale_y=h,this.set_points(s)}set_points(e){const i=e.length;this._points=new Float64Array(i*2),this._coords=new Float64Array(i*2),this._edges=new Float64Array(i*2),this._normals=new Float64Array(i*2);const s=this._points;for(let n=0,r=0,h=1;n<i;++n,r+=2,h+=2){const a=e[n];s[r]=a[0],s[h]=a[1]}this._dirty_coords=!0}_calculate_coords(){const{x:e,y:i,angle:s,scale_x:n,scale_y:r,_points:h,_coords:a}=this,c=h.length;let l=0,u=0,_=0,d=0;for(let f=0,g=1;f<c;f+=2,g+=2){let w=h[f]*n,y=h[g]*r;if(s){const b=Math.cos(s),m=Math.sin(s),p=w,k=y;w=p*b-k*m,y=p*m+k*b}w+=e,y+=i,a[f]=w,a[g]=y,f===0?(l=u=w,_=d=y):(w<l?l=w:w>u&&(u=w),y<_?_=y:y>d&&(d=y))}this._x=e,this._y=i,this._angle=s,this._scale_x=n,this._scale_y=r,this._min_x=l,this._min_y=_,this._max_x=u,this._max_y=d,this._dirty_coords=!1,this._dirty_normals=!0}_calculate_normals(){const{_coords:e,_edges:i,_normals:s}=this,n=e.length;for(let r=0,h=1;r<n;r+=2,h+=2){const a=r+2<n?r+2:0,c=e[a]-e[r],l=e[a+1]-e[h],u=c||l?Math.sqrt(c*c+l*l):0;i[r]=c,i[h]=l,s[r]=u?l/u:0,s[h]=u?-c/u:0}this._dirty_normals=!1}}class hs extends ti{constructor(e=0,i=0,s=0){super(e,i,[[0,0]],0,1,1,s);x(this,"_polygon",!0);x(this,"_circle",!1);x(this,"_point",!0);x(this,"set_points")}}class as{constructor(){x(this,"_bvh");this._bvh=new rs}create_circle(t=0,e=0,i=0,s=1,n=0){const r=new os(t,e,i,s,n);return this._bvh.insert(r),r}create_polygon(t=0,e=0,i=[[0,0]],s=0,n=1,r=1,h=0){const a=new ti(t,e,i,s,n,r,h);return this._bvh.insert(a),a}create_point(t=0,e=0,i=0){const s=new hs(t,e,i);return this._bvh.insert(s),s}insert(...t){for(const e of t)this._bvh.insert(e,!1);return this}remove(...t){for(const e of t)this._bvh.remove(e,!1);return this}update(){return this._bvh.update(),this}potentials(t,e,i){return this._bvh.potentials(t,e,i)}collides(t,e,i=null,s=!0){return Ze(t,e,i,s)}}class ls{constructor(){x(this,"collision",!1);x(this,"a",null);x(this,"b",null);x(this,"a_in_b",!1);x(this,"b_in_a",!1);x(this,"overlap",0);x(this,"overlap_x",0);x(this,"overlap_y",0)}}const Be=new ls,Is=(o,t,e)=>{const i=e.overlap*e.overlap_x,s=e.overlap*e.overlap_y,n=o.strength/(o.strength+t.strength)*(t.speed/(t.speed+o.speed)),r=1-n;o.x-=r*i,o.y-=r*s,t.x+=n*i,t.y+=n*s},Ls=(o,t,e,i=48)=>{const s=[];if(o.body._circle){const n=cs(Math.PI*o.radius**2,e,i);for(let r=0;r<e;r++){const h=new $i(t.create_circle(o.x,o.y,n[r]));h.speed=o.speed,h.directionX=o.directionX,h.directionY=o.directionY,h.color=o.color,s.push(h)}}else throw Error("TODO more types than circles");return s},cs=(o,t,e)=>{const i=[];for(let a=0;a<t;a++)i[a]=1+vi(0,1)*(e-1);const s=i.reduce((a,c)=>a+c);return i.map(a=>a/s).map(a=>a*o).map(a=>Math.sqrt(a/Math.PI))},qt=[];class _s{constructor(t){x(this,"collisions");x(this,"entities",new Set);this.collisions=t}addEntity(t){this.entities.add(t)}removeEntity(t){t.body.remove(),this.entities.delete(t)}update(t,e,i){this.collisions.update();let s;for(const n of this.entities)if(!n.disableSimulation&&(s=n.speed*t,n.x+=n.directionX*s,n.y+=n.directionY*s,!n.ghostly)){qt.length=0,n.body.potentials(i,qt);for(const r of qt)if(!r.entity.ghostly&&n.body.collides(r,Be)&&(e(n,r.entity,Be),n.dead))break}}}class us{constructor(){x(this,"moving",qe(!1));x(this,"movingLeft",!1);x(this,"movingRight",!1);x(this,"movingUp",!1);x(this,"movingDown",!1);x(this,"pointer_down",!1);x(this,"viewportWidth",0);x(this,"viewportHeight",0);x(this,"viewWidth",0);x(this,"viewHeight",0);x(this,"worldWidth",0);x(this,"worldHeight",0);x(this,"pointerScreenX",null);x(this,"pointerScreenY",null)}setPointerDown(t){this.pointer_down=t,this.moving.set(this.isMoving())}setPointerLocation(t,e){this.pointerScreenX=t,this.pointerScreenY=e}isMoving(){return this.pointer_down||this.movingDown||this.movingUp||this.movingLeft||this.movingRight}handleKeydown(t){switch(t){case"ArrowLeft":case"a":{this.movingLeft=!0,this.moving.set(!0);break}case"ArrowRight":case"d":{this.movingRight=!0,this.moving.set(!0);break}case"ArrowUp":case"w":{this.movingUp=!0,this.moving.set(!0);break}case"ArrowDown":case"s":{this.movingDown=!0,this.moving.set(!0);break}default:console.log("unhandled keydown",t)}}handleKeyup(t){switch(t){case"ArrowLeft":case"a":{this.movingLeft=!1,this.moving.set(this.isMoving());break}case"ArrowRight":case"d":{this.movingRight=!1,this.moving.set(this.isMoving());break}case"ArrowUp":case"w":{this.movingUp=!1,this.moving.set(this.isMoving());break}case"ArrowDown":case"s":{this.movingDown=!1,this.moving.set(this.isMoving());break}default:console.log("unhandled keyup",t)}}}const ds=5,Ps=(o,t,e)=>{if(o.pointer_down&&o.pointerScreenX!==null&&o.pointerScreenY!==null){const i=o.viewWidth/o.worldWidth,s=o.pointerScreenX-o.viewportWidth/2+o.viewWidth/2,n=o.pointerScreenY-o.viewportHeight/2+o.viewHeight/2,r=s/i+e.x-e.width/2,h=n/i+e.y-e.height/2,a=r-t.x,c=h-t.y,l=Math.hypot(a,c),u=!l||l<ds;t.directionX=u?0:a/l,t.directionY=u?0:c/l}else{const{movingLeft:i,movingRight:s,movingUp:n,movingDown:r}=o,h=i&&!s?-1:s&&!i?1:0,a=n&&!r?-1:r&&!n?1:0;t.directionX=a===0?h:h/Math.SQRT2,t.directionY=h===0?a:a/Math.SQRT2}},ei={hard:!0},fs=(o,t)=>{const e={x:0,y:0,scale:1,width:0,height:0,...o},i=Si(e,{stiffness:.006,damping:.12,...t}),{subscribe:s}=ai(i,r=>{const h=r.x-r.width/2,a=r.y-r.height/2;return{...r,left:h,right:h+r.width,top:a,bottom:a+r.height}});return{subscribe:s,zoom:r=>{console.log("zoom amount",r)},setPosition:(r,h,a)=>i.update(c=>({...c,x:r,y:h}),a),set_dimensions:(r,h,a=ei)=>i.update(c=>({...c,width:r,height:h}),a)}};var Yt;let Es=(Yt=class{constructor(t){x(this,"exit");x(this,"sim");x(this,"collisions");x(this,"container");x(this,"mask",null);x(this,"controller");x(this,"random");x(this,"time",0);x(this,"timeDilation",1);x(this,"worldWidth");x(this,"worldHeight");x(this,"viewWidth");x(this,"viewHeight");x(this,"viewportWidth");x(this,"viewportHeight");x(this,"camera");x(this,"$camera");x(this,"freezeCamera",!1);x(this,"subscriptions",[]);const{exit:e,data:i,worldWidth:s,worldHeight:n,viewWidth:r,viewHeight:h,viewportWidth:a,viewportHeight:c,collisions:l=new as,sim:u=new _s(l),container:_=new ie,controller:d=new us,random:f=ts()}=t;i&&(i.freezeCamera!==void 0&&(this.freezeCamera=i.freezeCamera),i.timeDilation!==void 0&&(this.timeDilation=i.timeDilation)),this.exit=e,this.sim=u,this.collisions=l,this.container=_,this.controller=d,this.random=f,this.worldWidth=s,this.worldHeight=n,this.viewWidth=r,this.viewHeight=h,this.viewportWidth=a,this.viewportHeight=c,this.camera=fs({width:s,height:n,x:s/2,y:n/2}),this.subscriptions.push(this.camera.subscribe(g=>this.$camera=g))}async setup(t){}async teardown(){}destroy(){this.container.destroy({children:!0,baseTexture:!0,texture:!0});for(const t of this.subscriptions)t()}update(t){this.time+=t,this.updateCameraPosition()}toData(){return{freezeCamera:this.freezeCamera,playerSpeed:this.player.speed,playerStrength:this.player.strength,timeDilation:this.timeDilation}}resize(t,e,i,s,n,r){this.worldWidth=t,this.worldHeight=e,this.viewWidth=i,this.viewHeight=s,this.viewportWidth=n,this.viewportHeight=r,this.drawMask(),this.camera.set_dimensions(t,e),this.freezeCamera&&this.camera.setPosition(t/2,e/2,ei),this.updateCameraPosition(),this.afterResize()}updateCameraPosition(){const{container:t,viewWidth:e,viewHeight:i,$camera:s}=this,n=Math.min(e/this.worldWidth,i/this.worldHeight);t.scale.set(n),t.position.set((-s.x+s.width/2)*n+(this.viewportWidth-e)/2,(-s.y+s.height/2)*n+(this.viewportHeight-i)/2)}afterResize(){}drawMask(){const t=(this.viewportWidth-this.viewWidth)/2,e=(this.viewportHeight-this.viewHeight)/2;t===0&&e===0?this.mask&&(this.container.mask=null,this.mask.parent.removeChild(this.mask),this.mask.destroy({baseTexture:!0,texture:!0}),this.mask=null):(this.mask?this.mask.clear():(this.mask=new Qt,this.container.mask=this.mask,this.container.addChild(this.mask)),this.mask.beginFill(0),this.mask.drawRect(0,0,this.worldWidth,this.worldHeight),this.mask.endFill())}addEntity(t){this.sim.addEntity(t),this.container.addChild(t.container),t.draw()}removeEntity(t){this.container.removeChild(t.container),this.sim.removeEntity(t),t.destroy()}},x(Yt,"meta"),Yt);export{Zi as D,$i as E,ks as S,Cs as W,Ms as a,Ds as b,Es as c,Te as d,Is as e,Ls as f,Ps as u};
