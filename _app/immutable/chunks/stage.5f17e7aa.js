var be=Object.defineProperty;var we=(o,t,e)=>t in o?be(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var m=(o,t,e)=>(we(o,typeof t!="symbol"?t+"":t,e),e);import{q as zt,m as rt,i as j,a as ve,d as et,R as Ct,p as Se,r as Ut,t as F,u as Te,v as Lt,P as ut,w as Me,x as De,W as Nt,B as jt,y as qt,z as Gt,D as lt,C as At,f as Ce,G as Le,H as yt,I as Ie,J as Pe,K as ke,M as Ae,U as Ee,h as Re}from"./pixi.1982b13e.js";import{a as Be}from"./random.c2e51b4a.js";import{a as he,b as ae}from"./colors.454075f6.js";import{w as We,d as He}from"./index.adfb9031.js";import{s as Fe}from"./spring.6b027579.js";function Yt(o,t,e){for(let i=0,s=4*e*t;i<t;++i,s+=4)if(o[s+3]!==0)return!1;return!0}function Vt(o,t,e,i,s){const n=4*t;for(let r=i,a=i*n+4*e;r<=s;++r,a+=n)if(o[a+3]!==0)return!1;return!0}function Oe(o){const{width:t,height:e}=o,i=o.getContext("2d",{willReadFrequently:!0});if(i===null)throw new TypeError("Failed to get canvas 2D context");const s=i.getImageData(0,0,t,e).data;let n=0,r=0,a=t-1,h=e-1;for(;r<e&&Yt(s,t,r);)++r;if(r===e)return zt.EMPTY;for(;Yt(s,t,h);)--h;for(;Vt(s,t,n,r,h);)++n;for(;Vt(s,t,a,r,h);)--a;return++a,++h,new zt(n,r,a,h)}function ze(o){const t=Oe(o),{width:e,height:i}=t;let s=null;if(!t.isEmpty()){const n=o.getContext("2d");if(n===null)throw new TypeError("Failed to get canvas 2D context");s=n.getImageData(t.left,t.top,e,i)}return{width:e,height:i,data:s}}var Xt=Object.prototype.hasOwnProperty;function $t(o,t){var e,i;if(o===t)return!0;if(o&&t&&(e=o.constructor)===t.constructor){if(e===Date)return o.getTime()===t.getTime();if(e===RegExp)return o.toString()===t.toString();if(e===Array){if((i=o.length)===t.length)for(;i--&&$t(o[i],t[i]););return i===-1}if(!e||typeof o=="object"){i=0;for(e in o)if(Xt.call(o,e)&&++i&&!Xt.call(t,e)||!(e in t)||!$t(o[e],t[e]))return!1;return Object.keys(t).length===i}}return o!==o&&t!==t}var Et=(o=>(o[o.LINEAR_VERTICAL=0]="LINEAR_VERTICAL",o[o.LINEAR_HORIZONTAL=1]="LINEAR_HORIZONTAL",o))(Et||{});const ct={willReadFrequently:!0},U=class v{static get experimentalLetterSpacingSupported(){let t=v._experimentalLetterSpacingSupported;if(t!==void 0){const e=rt.ADAPTER.getCanvasRenderingContext2D().prototype;t=v._experimentalLetterSpacingSupported="letterSpacing"in e||"textLetterSpacing"in e}return t}constructor(t,e,i,s,n,r,a,h,c){this.text=t,this.style=e,this.width=i,this.height=s,this.lines=n,this.lineWidths=r,this.lineHeight=a,this.maxLineWidth=h,this.fontProperties=c}static measureText(t,e,i,s=v._canvas){i=i??e.wordWrap;const n=e.toFontString(),r=v.measureFont(n);r.fontSize===0&&(r.fontSize=e.fontSize,r.ascent=e.fontSize);const a=s.getContext("2d",ct);a.font=n;const h=(i?v.wordWrap(t,e,s):t).split(/(?:\r\n|\r|\n)/),c=new Array(h.length);let l=0;for(let u=0;u<h.length;u++){const g=v._measureText(h[u],e.letterSpacing,a);c[u]=g,l=Math.max(l,g)}let _=l+e.strokeThickness;e.dropShadow&&(_+=e.dropShadowDistance);const d=e.lineHeight||r.fontSize+e.strokeThickness;let p=Math.max(d,r.fontSize+e.strokeThickness*2)+e.leading+(h.length-1)*(d+e.leading);return e.dropShadow&&(p+=e.dropShadowDistance),new v(t,e,_,p,h,c,d+e.leading,l,r)}static _measureText(t,e,i){let s=!1;v.experimentalLetterSpacingSupported&&(v.experimentalLetterSpacing?(i.letterSpacing=`${e}px`,i.textLetterSpacing=`${e}px`,s=!0):(i.letterSpacing="0px",i.textLetterSpacing="0px"));let n=i.measureText(t).width;return n>0&&(s?n-=e:n+=(v.graphemeSegmenter(t).length-1)*e),n}static wordWrap(t,e,i=v._canvas){const s=i.getContext("2d",ct);let n=0,r="",a="";const h=Object.create(null),{letterSpacing:c,whiteSpace:l}=e,_=v.collapseSpaces(l),d=v.collapseNewlines(l);let p=!_;const u=e.wordWrapWidth+c,g=v.tokenize(t);for(let b=0;b<g.length;b++){let y=g[b];if(v.isNewline(y)){if(!d){a+=v.addLine(r),p=!_,r="",n=0;continue}y=" "}if(_){const f=v.isBreakingSpace(y),x=v.isBreakingSpace(r[r.length-1]);if(f&&x)continue}const w=v.getFromCache(y,c,h,s);if(w>u)if(r!==""&&(a+=v.addLine(r),r="",n=0),v.canBreakWords(y,e.breakWords)){const f=v.wordWrapSplit(y);for(let x=0;x<f.length;x++){let C=f[x],I=C,S=1;for(;f[x+S];){const L=f[x+S];if(!v.canBreakChars(I,L,y,x,e.breakWords))C+=L;else break;I=L,S++}x+=S-1;const D=v.getFromCache(C,c,h,s);D+n>u&&(a+=v.addLine(r),p=!1,r="",n=0),r+=C,n+=D}}else{r.length>0&&(a+=v.addLine(r),r="",n=0);const f=b===g.length-1;a+=v.addLine(y,!f),p=!1,r="",n=0}else w+n>u&&(p=!1,a+=v.addLine(r),r="",n=0),(r.length>0||!v.isBreakingSpace(y)||p)&&(r+=y,n+=w)}return a+=v.addLine(r,!1),a}static addLine(t,e=!0){return t=v.trimRight(t),t=e?`${t}
`:t,t}static getFromCache(t,e,i,s){let n=i[t];return typeof n!="number"&&(n=v._measureText(t,e,s)+e,i[t]=n),n}static collapseSpaces(t){return t==="normal"||t==="pre-line"}static collapseNewlines(t){return t==="normal"}static trimRight(t){if(typeof t!="string")return"";for(let e=t.length-1;e>=0;e--){const i=t[e];if(!v.isBreakingSpace(i))break;t=t.slice(0,-1)}return t}static isNewline(t){return typeof t!="string"?!1:v._newlines.includes(t.charCodeAt(0))}static isBreakingSpace(t,e){return typeof t!="string"?!1:v._breakingSpaces.includes(t.charCodeAt(0))}static tokenize(t){const e=[];let i="";if(typeof t!="string")return e;for(let s=0;s<t.length;s++){const n=t[s],r=t[s+1];if(v.isBreakingSpace(n,r)||v.isNewline(n)){i!==""&&(e.push(i),i=""),e.push(n);continue}i+=n}return i!==""&&e.push(i),e}static canBreakWords(t,e){return e}static canBreakChars(t,e,i,s,n){return!0}static wordWrapSplit(t){return v.graphemeSegmenter(t)}static measureFont(t){if(v._fonts[t])return v._fonts[t];const e={ascent:0,descent:0,fontSize:0},i=v._canvas,s=v._context;s.font=t;const n=v.METRICS_STRING+v.BASELINE_SYMBOL,r=Math.ceil(s.measureText(n).width);let a=Math.ceil(s.measureText(v.BASELINE_SYMBOL).width);const h=Math.ceil(v.HEIGHT_MULTIPLIER*a);if(a=a*v.BASELINE_MULTIPLIER|0,r===0||h===0)return v._fonts[t]=e,e;i.width=r,i.height=h,s.fillStyle="#f00",s.fillRect(0,0,r,h),s.font=t,s.textBaseline="alphabetic",s.fillStyle="#000",s.fillText(n,0,a);const c=s.getImageData(0,0,r,h).data,l=c.length,_=r*4;let d=0,p=0,u=!1;for(d=0;d<a;++d){for(let g=0;g<_;g+=4)if(c[p+g]!==255){u=!0;break}if(!u)p+=_;else break}for(e.ascent=a-d,p=l-_,u=!1,d=h;d>a;--d){for(let g=0;g<_;g+=4)if(c[p+g]!==255){u=!0;break}if(!u)p-=_;else break}return e.descent=d-a,e.fontSize=e.ascent+e.descent,v._fonts[t]=e,e}static clearMetrics(t=""){t?delete v._fonts[t]:v._fonts={}}static get _canvas(){var t;if(!v.__canvas){let e;try{const i=new OffscreenCanvas(0,0);if((t=i.getContext("2d",ct))!=null&&t.measureText)return v.__canvas=i,i;e=rt.ADAPTER.createCanvas()}catch{e=rt.ADAPTER.createCanvas()}e.width=e.height=10,v.__canvas=e}return v.__canvas}static get _context(){return v.__context||(v.__context=v._canvas.getContext("2d",ct)),v.__context}};U.METRICS_STRING="|ÉqÅ",U.BASELINE_SYMBOL="M",U.BASELINE_MULTIPLIER=1.4,U.HEIGHT_MULTIPLIER=2,U.graphemeSegmenter=(()=>{if(typeof(Intl==null?void 0:Intl.Segmenter)=="function"){const o=new Intl.Segmenter;return t=>[...o.segment(t)].map(e=>e.segment)}return o=>[...o]})(),U.experimentalLetterSpacing=!1,U._fonts={},U._newlines=[10,13],U._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];let Z=U;const Ue=["serif","sans-serif","monospace","cursive","fantasy","system-ui"],oe=class nt{constructor(t){this.styleID=0,this.reset(),wt(this,t,t)}clone(){const t={};return wt(t,this,nt.defaultStyle),new nt(t)}reset(){wt(this,nt.defaultStyle,nt.defaultStyle)}get align(){return this._align}set align(t){this._align!==t&&(this._align=t,this.styleID++)}get breakWords(){return this._breakWords}set breakWords(t){this._breakWords!==t&&(this._breakWords=t,this.styleID++)}get dropShadow(){return this._dropShadow}set dropShadow(t){this._dropShadow!==t&&(this._dropShadow=t,this.styleID++)}get dropShadowAlpha(){return this._dropShadowAlpha}set dropShadowAlpha(t){this._dropShadowAlpha!==t&&(this._dropShadowAlpha=t,this.styleID++)}get dropShadowAngle(){return this._dropShadowAngle}set dropShadowAngle(t){this._dropShadowAngle!==t&&(this._dropShadowAngle=t,this.styleID++)}get dropShadowBlur(){return this._dropShadowBlur}set dropShadowBlur(t){this._dropShadowBlur!==t&&(this._dropShadowBlur=t,this.styleID++)}get dropShadowColor(){return this._dropShadowColor}set dropShadowColor(t){const e=bt(t);this._dropShadowColor!==e&&(this._dropShadowColor=e,this.styleID++)}get dropShadowDistance(){return this._dropShadowDistance}set dropShadowDistance(t){this._dropShadowDistance!==t&&(this._dropShadowDistance=t,this.styleID++)}get fill(){return this._fill}set fill(t){const e=bt(t);this._fill!==e&&(this._fill=e,this.styleID++)}get fillGradientType(){return this._fillGradientType}set fillGradientType(t){this._fillGradientType!==t&&(this._fillGradientType=t,this.styleID++)}get fillGradientStops(){return this._fillGradientStops}set fillGradientStops(t){Ne(this._fillGradientStops,t)||(this._fillGradientStops=t,this.styleID++)}get fontFamily(){return this._fontFamily}set fontFamily(t){this.fontFamily!==t&&(this._fontFamily=t,this.styleID++)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.styleID++)}get fontStyle(){return this._fontStyle}set fontStyle(t){this._fontStyle!==t&&(this._fontStyle=t,this.styleID++)}get fontVariant(){return this._fontVariant}set fontVariant(t){this._fontVariant!==t&&(this._fontVariant=t,this.styleID++)}get fontWeight(){return this._fontWeight}set fontWeight(t){this._fontWeight!==t&&(this._fontWeight=t,this.styleID++)}get letterSpacing(){return this._letterSpacing}set letterSpacing(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.styleID++)}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.styleID++)}get leading(){return this._leading}set leading(t){this._leading!==t&&(this._leading=t,this.styleID++)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin!==t&&(this._lineJoin=t,this.styleID++)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit!==t&&(this._miterLimit=t,this.styleID++)}get padding(){return this._padding}set padding(t){this._padding!==t&&(this._padding=t,this.styleID++)}get stroke(){return this._stroke}set stroke(t){const e=bt(t);this._stroke!==e&&(this._stroke=e,this.styleID++)}get strokeThickness(){return this._strokeThickness}set strokeThickness(t){this._strokeThickness!==t&&(this._strokeThickness=t,this.styleID++)}get textBaseline(){return this._textBaseline}set textBaseline(t){this._textBaseline!==t&&(this._textBaseline=t,this.styleID++)}get trim(){return this._trim}set trim(t){this._trim!==t&&(this._trim=t,this.styleID++)}get whiteSpace(){return this._whiteSpace}set whiteSpace(t){this._whiteSpace!==t&&(this._whiteSpace=t,this.styleID++)}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!==t&&(this._wordWrap=t,this.styleID++)}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.styleID++)}toFontString(){const t=typeof this.fontSize=="number"?`${this.fontSize}px`:this.fontSize;let e=this.fontFamily;Array.isArray(this.fontFamily)||(e=this.fontFamily.split(","));for(let i=e.length-1;i>=0;i--){let s=e[i].trim();!/([\"\'])[^\'\"]+\1/.test(s)&&!Ue.includes(s)&&(s=`"${s}"`),e[i]=s}return`${this.fontStyle} ${this.fontVariant} ${this.fontWeight} ${t} ${e.join(",")}`}};oe.defaultStyle={align:"left",breakWords:!1,dropShadow:!1,dropShadowAlpha:1,dropShadowAngle:Math.PI/6,dropShadowBlur:0,dropShadowColor:"black",dropShadowDistance:5,fill:"black",fillGradientType:Et.LINEAR_VERTICAL,fillGradientStops:[],fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,lineJoin:"miter",miterLimit:10,padding:0,stroke:"black",strokeThickness:0,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let Jt=oe;function bt(o){const t=j.shared,e=i=>{const s=t.setValue(i);return s.alpha===1?s.toHex():s.toRgbaString()};return Array.isArray(o)?o.map(e):e(o)}function Ne(o,t){if(!Array.isArray(o)||!Array.isArray(t)||o.length!==t.length)return!1;for(let e=0;e<o.length;++e)if(o[e]!==t[e])return!1;return!0}function wt(o,t,e){for(const i in e)Array.isArray(t[i])?o[i]=t[i].slice():o[i]=t[i]}const je={texture:!0,children:!1,baseTexture:!0},le=class It extends ve{constructor(t,e,i){let s=!1;i||(i=rt.ADAPTER.createCanvas(),s=!0),i.width=3,i.height=3;const n=et.from(i);n.orig=new Ct,n.trim=new Ct,super(n),this._ownCanvas=s,this.canvas=i,this.context=i.getContext("2d",{willReadFrequently:!0}),this._resolution=It.defaultResolution??rt.RESOLUTION,this._autoResolution=It.defaultAutoResolution,this._text=null,this._style=null,this._styleListener=null,this._font="",this.text=t,this.style=e,this.localStyleID=-1}static get experimentalLetterSpacing(){return Z.experimentalLetterSpacing}static set experimentalLetterSpacing(t){Se("7.1.0","Text.experimentalLetterSpacing is deprecated, use TextMetrics.experimentalLetterSpacing"),Z.experimentalLetterSpacing=t}updateText(t){const e=this._style;if(this.localStyleID!==e.styleID&&(this.dirty=!0,this.localStyleID=e.styleID),!this.dirty&&t)return;this._font=this._style.toFontString();const i=this.context,s=Z.measureText(this._text||" ",this._style,this._style.wordWrap,this.canvas),n=s.width,r=s.height,a=s.lines,h=s.lineHeight,c=s.lineWidths,l=s.maxLineWidth,_=s.fontProperties;this.canvas.width=Math.ceil(Math.ceil(Math.max(1,n)+e.padding*2)*this._resolution),this.canvas.height=Math.ceil(Math.ceil(Math.max(1,r)+e.padding*2)*this._resolution),i.scale(this._resolution,this._resolution),i.clearRect(0,0,this.canvas.width,this.canvas.height),i.font=this._font,i.lineWidth=e.strokeThickness,i.textBaseline=e.textBaseline,i.lineJoin=e.lineJoin,i.miterLimit=e.miterLimit;let d,p;const u=e.dropShadow?2:1;for(let g=0;g<u;++g){const b=e.dropShadow&&g===0,y=b?Math.ceil(Math.max(1,r)+e.padding*2):0,w=y*this._resolution;if(b){i.fillStyle="black",i.strokeStyle="black";const x=e.dropShadowColor,C=e.dropShadowBlur*this._resolution,I=e.dropShadowDistance*this._resolution;i.shadowColor=j.shared.setValue(x).setAlpha(e.dropShadowAlpha).toRgbaString(),i.shadowBlur=C,i.shadowOffsetX=Math.cos(e.dropShadowAngle)*I,i.shadowOffsetY=Math.sin(e.dropShadowAngle)*I+w}else i.fillStyle=this._generateFillStyle(e,a,s),i.strokeStyle=e.stroke,i.shadowColor="black",i.shadowBlur=0,i.shadowOffsetX=0,i.shadowOffsetY=0;let f=(h-_.fontSize)/2;h-_.fontSize<0&&(f=0);for(let x=0;x<a.length;x++)d=e.strokeThickness/2,p=e.strokeThickness/2+x*h+_.ascent+f,e.align==="right"?d+=l-c[x]:e.align==="center"&&(d+=(l-c[x])/2),e.stroke&&e.strokeThickness&&this.drawLetterSpacing(a[x],d+e.padding,p+e.padding-y,!0),e.fill&&this.drawLetterSpacing(a[x],d+e.padding,p+e.padding-y)}this.updateTexture()}drawLetterSpacing(t,e,i,s=!1){const n=this._style.letterSpacing;let r=!1;if(Z.experimentalLetterSpacingSupported&&(Z.experimentalLetterSpacing?(this.context.letterSpacing=`${n}px`,this.context.textLetterSpacing=`${n}px`,r=!0):(this.context.letterSpacing="0px",this.context.textLetterSpacing="0px")),n===0||r){s?this.context.strokeText(t,e,i):this.context.fillText(t,e,i);return}let a=e;const h=Z.graphemeSegmenter(t);let c=this.context.measureText(t).width,l=0;for(let _=0;_<h.length;++_){const d=h[_];s?this.context.strokeText(d,a,i):this.context.fillText(d,a,i);let p="";for(let u=_+1;u<h.length;++u)p+=h[u];l=this.context.measureText(p).width,a+=c-l+n,c=l}}updateTexture(){const t=this.canvas;if(this._style.trim){const r=ze(t);r.data&&(t.width=r.width,t.height=r.height,this.context.putImageData(r.data,0,0))}const e=this._texture,i=this._style,s=i.trim?0:i.padding,n=e.baseTexture;e.trim.width=e._frame.width=t.width/this._resolution,e.trim.height=e._frame.height=t.height/this._resolution,e.trim.x=-s,e.trim.y=-s,e.orig.width=e._frame.width-s*2,e.orig.height=e._frame.height-s*2,this._onTextureUpdate(),n.setRealSize(t.width,t.height,this._resolution),e.updateUvs(),this.dirty=!1}_render(t){this._autoResolution&&this._resolution!==t.resolution&&(this._resolution=t.resolution,this.dirty=!0),this.updateText(!0),super._render(t)}updateTransform(){this.updateText(!0),super.updateTransform()}getBounds(t,e){return this.updateText(!0),this._textureID===-1&&(t=!1),super.getBounds(t,e)}getLocalBounds(t){return this.updateText(!0),super.getLocalBounds.call(this,t)}_calculateBounds(){this.calculateVertices(),this._bounds.addQuad(this.vertexData)}_generateFillStyle(t,e,i){const s=t.fill;if(Array.isArray(s)){if(s.length===1)return s[0]}else return s;let n;const r=t.dropShadow?t.dropShadowDistance:0,a=t.padding||0,h=this.canvas.width/this._resolution-r-a*2,c=this.canvas.height/this._resolution-r-a*2,l=s.slice(),_=t.fillGradientStops.slice();if(!_.length){const d=l.length+1;for(let p=1;p<d;++p)_.push(p/d)}if(l.unshift(s[0]),_.unshift(0),l.push(s[s.length-1]),_.push(1),t.fillGradientType===Et.LINEAR_VERTICAL){n=this.context.createLinearGradient(h/2,a,h/2,c+a);const d=i.fontProperties.fontSize+t.strokeThickness;for(let p=0;p<e.length;p++){const u=i.lineHeight*(p-1)+d,g=i.lineHeight*p;let b=g;p>0&&u>g&&(b=(g+u)/2);const y=g+d,w=i.lineHeight*(p+1);let f=y;p+1<e.length&&w<y&&(f=(y+w)/2);const x=(f-b)/c;for(let C=0;C<l.length;C++){let I=0;typeof _[C]=="number"?I=_[C]:I=C/l.length;let S=Math.min(1,Math.max(0,b/c+I*x));S=Number(S.toFixed(5)),n.addColorStop(S,l[C])}}}else{n=this.context.createLinearGradient(a,c/2,h+a,c/2);const d=l.length+1;let p=1;for(let u=0;u<l.length;u++){let g;typeof _[u]=="number"?g=_[u]:g=p/d,n.addColorStop(g,l[u]),p++}}return n}destroy(t){typeof t=="boolean"&&(t={children:t}),t=Object.assign({},je,t),super.destroy(t),this._ownCanvas&&(this.canvas.height=this.canvas.width=0),this.context=null,this.canvas=null,this._style=null}get width(){return this.updateText(!0),Math.abs(this.scale.x)*this._texture.orig.width}set width(t){this.updateText(!0);const e=Ut(this.scale.x)||1;this.scale.x=e*t/this._texture.orig.width,this._width=t}get height(){return this.updateText(!0),Math.abs(this.scale.y)*this._texture.orig.height}set height(t){this.updateText(!0);const e=Ut(this.scale.y)||1;this.scale.y=e*t/this._texture.orig.height,this._height=t}get style(){return this._style}set style(t){t=t||{},t instanceof Jt?this._style=t:this._style=new Jt(t),this.localStyleID=-1,this.dirty=!0}get text(){return this._text}set text(t){t=String(t??""),this._text!==t&&(this._text=t,this.dirty=!0)}get resolution(){return this._resolution}set resolution(t){this._autoResolution=!1,this._resolution!==t&&(this._resolution=t,this.dirty=!0)}};le.defaultAutoResolution=!0;let qe=le;const pt={build(o){const t=o.points;let e,i,s,n,r,a;if(o.type===F.CIRC){const u=o.shape;e=u.x,i=u.y,r=a=u.radius,s=n=0}else if(o.type===F.ELIP){const u=o.shape;e=u.x,i=u.y,r=u.width,a=u.height,s=n=0}else{const u=o.shape,g=u.width/2,b=u.height/2;e=u.x+g,i=u.y+b,r=a=Math.max(0,Math.min(u.radius,Math.min(g,b))),s=g-r,n=b-a}if(!(r>=0&&a>=0&&s>=0&&n>=0)){t.length=0;return}const h=Math.ceil(2.3*Math.sqrt(r+a)),c=h*8+(s?4:0)+(n?4:0);if(t.length=c,c===0)return;if(h===0){t.length=8,t[0]=t[6]=e+s,t[1]=t[3]=i+n,t[2]=t[4]=e-s,t[5]=t[7]=i-n;return}let l=0,_=h*4+(s?2:0)+2,d=_,p=c;{const u=s+r,g=n,b=e+u,y=e-u,w=i+g;if(t[l++]=b,t[l++]=w,t[--_]=w,t[--_]=y,n){const f=i-g;t[d++]=y,t[d++]=f,t[--p]=f,t[--p]=b}}for(let u=1;u<h;u++){const g=Math.PI/2*(u/h),b=s+Math.cos(g)*r,y=n+Math.sin(g)*a,w=e+b,f=e-b,x=i+y,C=i-y;t[l++]=w,t[l++]=x,t[--_]=x,t[--_]=f,t[d++]=f,t[d++]=C,t[--p]=C,t[--p]=w}{const u=s,g=n+a,b=e+u,y=e-u,w=i+g,f=i-g;t[l++]=b,t[l++]=w,t[--p]=f,t[--p]=b,s&&(t[l++]=y,t[l++]=w,t[--p]=f,t[--p]=y)}},triangulate(o,t){const e=o.points,i=t.points,s=t.indices;if(e.length===0)return;let n=i.length/2;const r=n;let a,h;if(o.type!==F.RREC){const l=o.shape;a=l.x,h=l.y}else{const l=o.shape;a=l.x+l.width/2,h=l.y+l.height/2}const c=o.matrix;i.push(o.matrix?c.a*a+c.c*h+c.tx:a,o.matrix?c.b*a+c.d*h+c.ty:h),n++,i.push(e[0],e[1]);for(let l=2;l<e.length;l+=2)i.push(e[l],e[l+1]),s.push(n++,r,n);s.push(r+1,r,n)}};function Qt(o,t=!1){const e=o.length;if(e<6)return;let i=0;for(let s=0,n=o[e-2],r=o[e-1];s<e;s+=2){const a=o[s],h=o[s+1];i+=(a-n)*(h+r),n=a,r=h}if(!t&&i>0||t&&i<=0){const s=e/2;for(let n=s+s%2;n<e;n+=2){const r=e-n-2,a=e-n-1,h=n,c=n+1;[o[r],o[h]]=[o[h],o[r]],[o[a],o[c]]=[o[c],o[a]]}}}const ce={build(o){o.points=o.shape.points.slice()},triangulate(o,t){let e=o.points;const i=o.holes,s=t.points,n=t.indices;if(e.length>=6){Qt(e,!1);const r=[];for(let c=0;c<i.length;c++){const l=i[c];Qt(l.points,!0),r.push(e.length/2),e=e.concat(l.points)}const a=Te(e,r,2);if(!a)return;const h=s.length/2;for(let c=0;c<a.length;c+=3)n.push(a[c]+h),n.push(a[c+1]+h),n.push(a[c+2]+h);for(let c=0;c<e.length;c++)s.push(e[c])}}},Ge={build(o){const t=o.shape,e=t.x,i=t.y,s=t.width,n=t.height,r=o.points;r.length=0,s>=0&&n>=0&&r.push(e,i,e+s,i,e+s,i+n,e,i+n)},triangulate(o,t){const e=o.points,i=t.points;if(e.length===0)return;const s=i.length/2;i.push(e[0],e[1],e[2],e[3],e[6],e[7],e[4],e[5]),t.indices.push(s,s+1,s+2,s+1,s+2,s+3)}},Ye={build(o){pt.build(o)},triangulate(o,t){pt.triangulate(o,t)}};var W=(o=>(o.MITER="miter",o.BEVEL="bevel",o.ROUND="round",o))(W||{}),Y=(o=>(o.BUTT="butt",o.ROUND="round",o.SQUARE="square",o))(Y||{});const it={adaptive:!0,maxLength:10,minSegments:8,maxSegments:2048,epsilon:1e-4,_segmentsCount(o,t=20){if(!this.adaptive||!o||isNaN(o))return t;let e=Math.ceil(o/this.maxLength);return e<this.minSegments?e=this.minSegments:e>this.maxSegments&&(e=this.maxSegments),e}};class Kt{static curveTo(t,e,i,s,n,r){const a=r[r.length-2],h=r[r.length-1]-e,c=a-t,l=s-e,_=i-t,d=Math.abs(h*_-c*l);if(d<1e-8||n===0)return(r[r.length-2]!==t||r[r.length-1]!==e)&&r.push(t,e),null;const p=h*h+c*c,u=l*l+_*_,g=h*l+c*_,b=n*Math.sqrt(p)/d,y=n*Math.sqrt(u)/d,w=b*g/p,f=y*g/u,x=b*_+y*c,C=b*l+y*h,I=c*(y+w),S=h*(y+w),D=_*(b+f),L=l*(b+f),k=Math.atan2(S-C,I-x),A=Math.atan2(L-C,D-x);return{cx:x+t,cy:C+e,radius:n,startAngle:k,endAngle:A,anticlockwise:c*l>_*h}}static arc(t,e,i,s,n,r,a,h,c){const l=a-r,_=it._segmentsCount(Math.abs(l)*n,Math.ceil(Math.abs(l)/Lt)*40),d=l/(_*2),p=d*2,u=Math.cos(d),g=Math.sin(d),b=_-1,y=b%1/b;for(let w=0;w<=b;++w){const f=w+y*w,x=d+r+p*f,C=Math.cos(x),I=-Math.sin(x);c.push((u*C+g*I)*n+i,(u*-I+g*C)*n+s)}}}class Ve{constructor(){this.reset()}begin(t,e,i){this.reset(),this.style=t,this.start=e,this.attribStart=i}end(t,e){this.attribSize=e-this.attribStart,this.size=t-this.start}reset(){this.style=null,this.size=0,this.start=0,this.attribStart=0,this.attribSize=0}}class Rt{static curveLength(t,e,i,s,n,r,a,h){let c=0,l=0,_=0,d=0,p=0,u=0,g=0,b=0,y=0,w=0,f=0,x=t,C=e;for(let I=1;I<=10;++I)l=I/10,_=l*l,d=_*l,p=1-l,u=p*p,g=u*p,b=g*t+3*u*l*i+3*p*_*n+d*a,y=g*e+3*u*l*s+3*p*_*r+d*h,w=x-b,f=C-y,x=b,C=y,c+=Math.sqrt(w*w+f*f);return c}static curveTo(t,e,i,s,n,r,a){const h=a[a.length-2],c=a[a.length-1];a.length-=2;const l=it._segmentsCount(Rt.curveLength(h,c,t,e,i,s,n,r));let _=0,d=0,p=0,u=0,g=0;a.push(h,c);for(let b=1,y=0;b<=l;++b)y=b/l,_=1-y,d=_*_,p=d*_,u=y*y,g=u*y,a.push(p*h+3*d*y*t+3*_*u*i+g*n,p*c+3*d*y*e+3*_*u*s+g*r)}}function Zt(o,t,e,i,s,n,r,a){const h=o-e*s,c=t-i*s,l=o+e*n,_=t+i*n;let d,p;r?(d=i,p=-e):(d=-i,p=e);const u=h+d,g=c+p,b=l+d,y=_+p;return a.push(u,g,b,y),2}function Q(o,t,e,i,s,n,r,a){const h=e-o,c=i-t;let l=Math.atan2(h,c),_=Math.atan2(s-o,n-t);a&&l<_?l+=Math.PI*2:!a&&l>_&&(_+=Math.PI*2);let d=l;const p=_-l,u=Math.abs(p),g=Math.sqrt(h*h+c*c),b=(15*u*Math.sqrt(g)/Math.PI>>0)+1,y=p/b;if(d+=y,a){r.push(o,t,e,i);for(let w=1,f=d;w<b;w++,f+=y)r.push(o,t,o+Math.sin(f)*g,t+Math.cos(f)*g);r.push(o,t,s,n)}else{r.push(e,i,o,t);for(let w=1,f=d;w<b;w++,f+=y)r.push(o+Math.sin(f)*g,t+Math.cos(f)*g,o,t);r.push(s,n,o,t)}return b*2}function Xe(o,t){const e=o.shape;let i=o.points||e.points.slice();const s=t.closePointEps;if(i.length===0)return;const n=o.lineStyle,r=new ut(i[0],i[1]),a=new ut(i[i.length-2],i[i.length-1]),h=e.type!==F.POLY||e.closeStroke,c=Math.abs(r.x-a.x)<s&&Math.abs(r.y-a.y)<s;if(h){i=i.slice(),c&&(i.pop(),i.pop(),a.set(i[i.length-2],i[i.length-1]));const P=(r.x+a.x)*.5,R=(a.y+r.y)*.5;i.unshift(P,R),i.push(P,R)}const l=t.points,_=i.length/2;let d=i.length;const p=l.length/2,u=n.width/2,g=u*u,b=n.miterLimit*n.miterLimit;let y=i[0],w=i[1],f=i[2],x=i[3],C=0,I=0,S=-(w-x),D=y-f,L=0,k=0,A=Math.sqrt(S*S+D*D);S/=A,D/=A,S*=u,D*=u;const O=n.alignment,T=(1-O)*2,M=O*2;h||(n.cap===Y.ROUND?d+=Q(y-S*(T-M)*.5,w-D*(T-M)*.5,y-S*T,w-D*T,y+S*M,w+D*M,l,!0)+2:n.cap===Y.SQUARE&&(d+=Zt(y,w,S,D,T,M,!0,l))),l.push(y-S*T,w-D*T,y+S*M,w+D*M);for(let P=1;P<_-1;++P){y=i[(P-1)*2],w=i[(P-1)*2+1],f=i[P*2],x=i[P*2+1],C=i[(P+1)*2],I=i[(P+1)*2+1],S=-(w-x),D=y-f,A=Math.sqrt(S*S+D*D),S/=A,D/=A,S*=u,D*=u,L=-(x-I),k=f-C,A=Math.sqrt(L*L+k*k),L/=A,k/=A,L*=u,k*=u;const R=f-y,z=w-x,H=f-C,q=I-x,xt=R*H+z*q,G=z*H-q*R,N=G<0;if(Math.abs(G)<.001*Math.abs(xt)){l.push(f-S*T,x-D*T,f+S*M,x+D*M),xt>=0&&(n.join===W.ROUND?d+=Q(f,x,f-S*T,x-D*T,f-L*T,x-k*T,l,!1)+4:d+=2,l.push(f-L*M,x-k*M,f+L*T,x+k*T));continue}const st=(-S+y)*(-D+x)-(-S+f)*(-D+w),K=(-L+C)*(-k+x)-(-L+f)*(-k+I),ht=(R*K-H*st)/G,at=(q*st-z*K)/G,Ft=(ht-f)*(ht-f)+(at-x)*(at-x),V=f+(ht-f)*T,X=x+(at-x)*T,$=f-(ht-f)*M,J=x-(at-x)*M,me=Math.min(R*R+z*z,H*H+q*q),Ot=N?T:M,xe=me+Ot*Ot*g,ye=Ft<=xe;let ot=n.join;if(ot===W.MITER&&Ft/g>b&&(ot=W.BEVEL),ye)switch(ot){case W.MITER:{l.push(V,X,$,J);break}case W.BEVEL:{N?l.push(V,X,f+S*M,x+D*M,V,X,f+L*M,x+k*M):l.push(f-S*T,x-D*T,$,J,f-L*T,x-k*T,$,J),d+=2;break}case W.ROUND:{N?(l.push(V,X,f+S*M,x+D*M),d+=Q(f,x,f+S*M,x+D*M,f+L*M,x+k*M,l,!0)+4,l.push(V,X,f+L*M,x+k*M)):(l.push(f-S*T,x-D*T,$,J),d+=Q(f,x,f-S*T,x-D*T,f-L*T,x-k*T,l,!1)+4,l.push(f-L*T,x-k*T,$,J));break}}else{switch(l.push(f-S*T,x-D*T,f+S*M,x+D*M),ot){case W.MITER:{N?l.push($,J,$,J):l.push(V,X,V,X),d+=2;break}case W.ROUND:{N?d+=Q(f,x,f+S*M,x+D*M,f+L*M,x+k*M,l,!0)+2:d+=Q(f,x,f-S*T,x-D*T,f-L*T,x-k*T,l,!1)+2;break}}l.push(f-L*T,x-k*T,f+L*M,x+k*M),d+=2}}y=i[(_-2)*2],w=i[(_-2)*2+1],f=i[(_-1)*2],x=i[(_-1)*2+1],S=-(w-x),D=y-f,A=Math.sqrt(S*S+D*D),S/=A,D/=A,S*=u,D*=u,l.push(f-S*T,x-D*T,f+S*M,x+D*M),h||(n.cap===Y.ROUND?d+=Q(f-S*(T-M)*.5,x-D*(T-M)*.5,f-S*T,x-D*T,f+S*M,x+D*M,l,!1)+2:n.cap===Y.SQUARE&&(d+=Zt(f,x,S,D,T,M,!1,l)));const B=t.indices,E=it.epsilon*it.epsilon;for(let P=p;P<d+p-2;++P)y=l[P*2],w=l[P*2+1],f=l[(P+1)*2],x=l[(P+1)*2+1],C=l[(P+2)*2],I=l[(P+2)*2+1],!(Math.abs(y*(x-I)+f*(I-w)+C*(w-x))<E)&&B.push(P,P+1,P+2)}function $e(o,t){let e=0;const i=o.shape,s=o.points||i.points,n=i.type!==F.POLY||i.closeStroke;if(s.length===0)return;const r=t.points,a=t.indices,h=s.length/2,c=r.length/2;let l=c;for(r.push(s[0],s[1]),e=1;e<h;e++)r.push(s[e*2],s[e*2+1]),a.push(l,l+1),l++;n&&a.push(l,c)}function te(o,t){o.lineStyle.native?$e(o,t):Xe(o,t)}class Bt{static curveLength(t,e,i,s,n,r){const a=t-2*i+n,h=e-2*s+r,c=2*i-2*t,l=2*s-2*e,_=4*(a*a+h*h),d=4*(a*c+h*l),p=c*c+l*l,u=2*Math.sqrt(_+d+p),g=Math.sqrt(_),b=2*_*g,y=2*Math.sqrt(p),w=d/g;return(b*u+g*d*(u-y)+(4*p*_-d*d)*Math.log((2*g+w+u)/(w+y)))/(4*b)}static curveTo(t,e,i,s,n){const r=n[n.length-2],a=n[n.length-1],h=it._segmentsCount(Bt.curveLength(r,a,t,e,i,s));let c=0,l=0;for(let _=1;_<=h;++_){const d=_/h;c=r+(t-r)*d,l=a+(e-a)*d,n.push(c+(t+(i-t)*d-c)*d,l+(e+(s-e)*d-l)*d)}}}const vt={[F.POLY]:ce,[F.CIRC]:pt,[F.ELIP]:pt,[F.RECT]:Ge,[F.RREC]:Ye},ee=[],_t=[];class gt{constructor(t,e=null,i=null,s=null){this.points=[],this.holes=[],this.shape=t,this.lineStyle=i,this.fillStyle=e,this.matrix=s,this.type=t.type}clone(){return new gt(this.shape,this.fillStyle,this.lineStyle,this.matrix)}destroy(){this.shape=null,this.holes.length=0,this.holes=null,this.points.length=0,this.points=null,this.lineStyle=null,this.fillStyle=null}}const tt=new ut,_e=class de extends Me{constructor(){super(),this.closePointEps=1e-4,this.boundsPadding=0,this.uvsFloat32=null,this.indicesUint16=null,this.batchable=!1,this.points=[],this.colors=[],this.uvs=[],this.indices=[],this.textureIds=[],this.graphicsData=[],this.drawCalls=[],this.batchDirty=-1,this.batches=[],this.dirty=0,this.cacheDirty=-1,this.clearDirty=0,this.shapeIndex=0,this._bounds=new De,this.boundsDirty=-1}get bounds(){return this.updateBatches(),this.boundsDirty!==this.dirty&&(this.boundsDirty=this.dirty,this.calculateBounds()),this._bounds}invalidate(){this.boundsDirty=-1,this.dirty++,this.batchDirty++,this.shapeIndex=0,this.points.length=0,this.colors.length=0,this.uvs.length=0,this.indices.length=0,this.textureIds.length=0;for(let t=0;t<this.drawCalls.length;t++)this.drawCalls[t].texArray.clear(),_t.push(this.drawCalls[t]);this.drawCalls.length=0;for(let t=0;t<this.batches.length;t++){const e=this.batches[t];e.reset(),ee.push(e)}this.batches.length=0}clear(){return this.graphicsData.length>0&&(this.invalidate(),this.clearDirty++,this.graphicsData.length=0),this}drawShape(t,e=null,i=null,s=null){const n=new gt(t,e,i,s);return this.graphicsData.push(n),this.dirty++,this}drawHole(t,e=null){if(!this.graphicsData.length)return null;const i=new gt(t,null,null,e),s=this.graphicsData[this.graphicsData.length-1];return i.lineStyle=s.lineStyle,s.holes.push(i),this.dirty++,this}destroy(){super.destroy();for(let t=0;t<this.graphicsData.length;++t)this.graphicsData[t].destroy();this.points.length=0,this.points=null,this.colors.length=0,this.colors=null,this.uvs.length=0,this.uvs=null,this.indices.length=0,this.indices=null,this.indexBuffer.destroy(),this.indexBuffer=null,this.graphicsData.length=0,this.graphicsData=null,this.drawCalls.length=0,this.drawCalls=null,this.batches.length=0,this.batches=null,this._bounds=null}containsPoint(t){const e=this.graphicsData;for(let i=0;i<e.length;++i){const s=e[i];if(s.fillStyle.visible&&s.shape&&(s.matrix?s.matrix.applyInverse(t,tt):tt.copyFrom(t),s.shape.contains(tt.x,tt.y))){let n=!1;if(s.holes){for(let r=0;r<s.holes.length;r++)if(s.holes[r].shape.contains(tt.x,tt.y)){n=!0;break}}if(!n)return!0}}return!1}updateBatches(){if(!this.graphicsData.length){this.batchable=!0;return}if(!this.validateBatching())return;this.cacheDirty=this.dirty;const t=this.uvs,e=this.graphicsData;let i=null,s=null;this.batches.length>0&&(i=this.batches[this.batches.length-1],s=i.style);for(let h=this.shapeIndex;h<e.length;h++){this.shapeIndex++;const c=e[h],l=c.fillStyle,_=c.lineStyle;vt[c.type].build(c),c.matrix&&this.transformPoints(c.points,c.matrix),(l.visible||_.visible)&&this.processHoles(c.holes);for(let d=0;d<2;d++){const p=d===0?l:_;if(!p.visible)continue;const u=p.texture.baseTexture,g=this.indices.length,b=this.points.length/2;u.wrapMode=Nt.REPEAT,d===0?this.processFill(c):this.processLine(c);const y=this.points.length/2-b;y!==0&&(i&&!this._compareStyles(s,p)&&(i.end(g,b),i=null),i||(i=ee.pop()||new Ve,i.begin(p,g,b),this.batches.push(i),s=p),this.addUvs(this.points,t,p.texture,b,y,p.matrix))}}const n=this.indices.length,r=this.points.length/2;if(i&&i.end(n,r),this.batches.length===0){this.batchable=!0;return}const a=r>65535;this.indicesUint16&&this.indices.length===this.indicesUint16.length&&a===this.indicesUint16.BYTES_PER_ELEMENT>2?this.indicesUint16.set(this.indices):this.indicesUint16=a?new Uint32Array(this.indices):new Uint16Array(this.indices),this.batchable=this.isBatchable(),this.batchable?this.packBatches():this.buildDrawCalls()}_compareStyles(t,e){return!(!t||!e||t.texture.baseTexture!==e.texture.baseTexture||t.color+t.alpha!==e.color+e.alpha||!!t.native!=!!e.native)}validateBatching(){if(this.dirty===this.cacheDirty||!this.graphicsData.length)return!1;for(let t=0,e=this.graphicsData.length;t<e;t++){const i=this.graphicsData[t],s=i.fillStyle,n=i.lineStyle;if(s&&!s.texture.baseTexture.valid||n&&!n.texture.baseTexture.valid)return!1}return!0}packBatches(){this.batchDirty++,this.uvsFloat32=new Float32Array(this.uvs);const t=this.batches;for(let e=0,i=t.length;e<i;e++){const s=t[e];for(let n=0;n<s.size;n++){const r=s.start+n;this.indicesUint16[r]=this.indicesUint16[r]-s.attribStart}}}isBatchable(){if(this.points.length>65535*2)return!1;const t=this.batches;for(let e=0;e<t.length;e++)if(t[e].style.native)return!1;return this.points.length<de.BATCHABLE_SIZE*2}buildDrawCalls(){let t=++jt._globalBatch;for(let _=0;_<this.drawCalls.length;_++)this.drawCalls[_].texArray.clear(),_t.push(this.drawCalls[_]);this.drawCalls.length=0;const e=this.colors,i=this.textureIds;let s=_t.pop();s||(s=new qt,s.texArray=new Gt),s.texArray.count=0,s.start=0,s.size=0,s.type=lt.TRIANGLES;let n=0,r=null,a=0,h=!1,c=lt.TRIANGLES,l=0;this.drawCalls.push(s);for(let _=0;_<this.batches.length;_++){const d=this.batches[_],p=8,u=d.style,g=u.texture.baseTexture;h!==!!u.native&&(h=!!u.native,c=h?lt.LINES:lt.TRIANGLES,r=null,n=p,t++),r!==g&&(r=g,g._batchEnabled!==t&&(n===p&&(t++,n=0,s.size>0&&(s=_t.pop(),s||(s=new qt,s.texArray=new Gt),this.drawCalls.push(s)),s.start=l,s.size=0,s.texArray.count=0,s.type=c),g.touched=1,g._batchEnabled=t,g._batchLocation=n,g.wrapMode=Nt.REPEAT,s.texArray.elements[s.texArray.count++]=g,n++)),s.size+=d.size,l+=d.size,a=g._batchLocation,this.addColors(e,u.color,u.alpha,d.attribSize,d.attribStart),this.addTextureIds(i,a,d.attribSize,d.attribStart)}jt._globalBatch=t,this.packAttributes()}packAttributes(){const t=this.points,e=this.uvs,i=this.colors,s=this.textureIds,n=new ArrayBuffer(t.length*3*4),r=new Float32Array(n),a=new Uint32Array(n);let h=0;for(let c=0;c<t.length/2;c++)r[h++]=t[c*2],r[h++]=t[c*2+1],r[h++]=e[c*2],r[h++]=e[c*2+1],a[h++]=i[c],r[h++]=s[c];this._buffer.update(n),this._indexBuffer.update(this.indicesUint16)}processFill(t){t.holes.length?ce.triangulate(t,this):vt[t.type].triangulate(t,this)}processLine(t){te(t,this);for(let e=0;e<t.holes.length;e++)te(t.holes[e],this)}processHoles(t){for(let e=0;e<t.length;e++){const i=t[e];vt[i.type].build(i),i.matrix&&this.transformPoints(i.points,i.matrix)}}calculateBounds(){const t=this._bounds;t.clear(),t.addVertexData(this.points,0,this.points.length),t.pad(this.boundsPadding,this.boundsPadding)}transformPoints(t,e){for(let i=0;i<t.length/2;i++){const s=t[i*2],n=t[i*2+1];t[i*2]=e.a*s+e.c*n+e.tx,t[i*2+1]=e.b*s+e.d*n+e.ty}}addColors(t,e,i,s,n=0){const r=j.shared.setValue(e).toLittleEndianNumber(),a=j.shared.setValue(r).toPremultiplied(i);t.length=Math.max(t.length,n+s);for(let h=0;h<s;h++)t[n+h]=a}addTextureIds(t,e,i,s=0){t.length=Math.max(t.length,s+i);for(let n=0;n<i;n++)t[s+n]=e}addUvs(t,e,i,s,n,r=null){let a=0;const h=e.length,c=i.frame;for(;a<n;){let _=t[(s+a)*2],d=t[(s+a)*2+1];if(r){const p=r.a*_+r.c*d+r.tx;d=r.b*_+r.d*d+r.ty,_=p}a++,e.push(_/c.width,d/c.height)}const l=i.baseTexture;(c.width<l.width||c.height<l.height)&&this.adjustUvs(e,i,h,n)}adjustUvs(t,e,i,s){const n=e.baseTexture,r=1e-6,a=i+s*2,h=e.frame,c=h.width/n.width,l=h.height/n.height;let _=h.x/h.width,d=h.y/h.height,p=Math.floor(t[i]+r),u=Math.floor(t[i+1]+r);for(let g=i+2;g<a;g+=2)p=Math.min(p,Math.floor(t[g]+r)),u=Math.min(u,Math.floor(t[g+1]+r));_-=p,d-=u;for(let g=i;g<a;g+=2)t[g]=(t[g]+_)*c,t[g+1]=(t[g+1]+d)*l}};_e.BATCHABLE_SIZE=100;let Je=_e;class mt{constructor(){this.color=16777215,this.alpha=1,this.texture=et.WHITE,this.matrix=null,this.visible=!1,this.reset()}clone(){const t=new mt;return t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.matrix=this.matrix,t.visible=this.visible,t}reset(){this.color=16777215,this.alpha=1,this.texture=et.WHITE,this.matrix=null,this.visible=!1}destroy(){this.texture=null,this.matrix=null}}class Wt extends mt{constructor(){super(...arguments),this.width=0,this.alignment=.5,this.native=!1,this.cap=Y.BUTT,this.join=W.MITER,this.miterLimit=10}clone(){const t=new Wt;return t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.matrix=this.matrix,t.visible=this.visible,t.width=this.width,t.alignment=this.alignment,t.native=this.native,t.cap=this.cap,t.join=this.join,t.miterLimit=this.miterLimit,t}reset(){super.reset(),this.color=0,this.alignment=.5,this.width=0,this.native=!1,this.cap=Y.BUTT,this.join=W.MITER,this.miterLimit=10}}const St={},Pt=class dt extends At{constructor(t=null){super(),this.shader=null,this.pluginName="batch",this.currentPath=null,this.batches=[],this.batchTint=-1,this.batchDirty=-1,this.vertexData=null,this._fillStyle=new mt,this._lineStyle=new Wt,this._matrix=null,this._holeMode=!1,this.state=Ce.for2d(),this._geometry=t||new Je,this._geometry.refCount++,this._transformID=-1,this._tintColor=new j(16777215),this.blendMode=Le.NORMAL}get geometry(){return this._geometry}clone(){return this.finishPoly(),new dt(this._geometry)}set blendMode(t){this.state.blendMode=t}get blendMode(){return this.state.blendMode}get tint(){return this._tintColor.value}set tint(t){this._tintColor.setValue(t)}get fill(){return this._fillStyle}get line(){return this._lineStyle}lineStyle(t=null,e=0,i,s=.5,n=!1){return typeof t=="number"&&(t={width:t,color:e,alpha:i,alignment:s,native:n}),this.lineTextureStyle(t)}lineTextureStyle(t){const e={width:0,texture:et.WHITE,color:t!=null&&t.texture?16777215:0,matrix:null,alignment:.5,native:!1,cap:Y.BUTT,join:W.MITER,miterLimit:10};t=Object.assign(e,t),this.normalizeColor(t),this.currentPath&&this.startPoly();const i=t.width>0&&t.alpha>0;return i?(t.matrix&&(t.matrix=t.matrix.clone(),t.matrix.invert()),Object.assign(this._lineStyle,{visible:i},t)):this._lineStyle.reset(),this}startPoly(){if(this.currentPath){const t=this.currentPath.points,e=this.currentPath.points.length;e>2&&(this.drawShape(this.currentPath),this.currentPath=new yt,this.currentPath.closeStroke=!1,this.currentPath.points.push(t[e-2],t[e-1]))}else this.currentPath=new yt,this.currentPath.closeStroke=!1}finishPoly(){this.currentPath&&(this.currentPath.points.length>2?(this.drawShape(this.currentPath),this.currentPath=null):this.currentPath.points.length=0)}moveTo(t,e){return this.startPoly(),this.currentPath.points[0]=t,this.currentPath.points[1]=e,this}lineTo(t,e){this.currentPath||this.moveTo(0,0);const i=this.currentPath.points,s=i[i.length-2],n=i[i.length-1];return(s!==t||n!==e)&&i.push(t,e),this}_initCurve(t=0,e=0){this.currentPath?this.currentPath.points.length===0&&(this.currentPath.points=[t,e]):this.moveTo(t,e)}quadraticCurveTo(t,e,i,s){this._initCurve();const n=this.currentPath.points;return n.length===0&&this.moveTo(0,0),Bt.curveTo(t,e,i,s,n),this}bezierCurveTo(t,e,i,s,n,r){return this._initCurve(),Rt.curveTo(t,e,i,s,n,r,this.currentPath.points),this}arcTo(t,e,i,s,n){this._initCurve(t,e);const r=this.currentPath.points,a=Kt.curveTo(t,e,i,s,n,r);if(a){const{cx:h,cy:c,radius:l,startAngle:_,endAngle:d,anticlockwise:p}=a;this.arc(h,c,l,_,d,p)}return this}arc(t,e,i,s,n,r=!1){if(s===n)return this;if(!r&&n<=s?n+=Lt:r&&s<=n&&(s+=Lt),n-s===0)return this;const a=t+Math.cos(s)*i,h=e+Math.sin(s)*i,c=this._geometry.closePointEps;let l=this.currentPath?this.currentPath.points:null;if(l){const _=Math.abs(l[l.length-2]-a),d=Math.abs(l[l.length-1]-h);_<c&&d<c||l.push(a,h)}else this.moveTo(a,h),l=this.currentPath.points;return Kt.arc(a,h,t,e,i,s,n,r,l),this}beginFill(t=0,e){return this.beginTextureFill({texture:et.WHITE,color:t,alpha:e})}normalizeColor(t){const e=j.shared.setValue(t.color??0);t.color=e.toNumber(),t.alpha??(t.alpha=e.alpha)}beginTextureFill(t){const e={texture:et.WHITE,color:16777215,matrix:null};t=Object.assign(e,t),this.normalizeColor(t),this.currentPath&&this.startPoly();const i=t.alpha>0;return i?(t.matrix&&(t.matrix=t.matrix.clone(),t.matrix.invert()),Object.assign(this._fillStyle,{visible:i},t)):this._fillStyle.reset(),this}endFill(){return this.finishPoly(),this._fillStyle.reset(),this}drawRect(t,e,i,s){return this.drawShape(new Ct(t,e,i,s))}drawRoundedRect(t,e,i,s,n){return this.drawShape(new Ie(t,e,i,s,n))}drawCircle(t,e,i){return this.drawShape(new Pe(t,e,i))}drawEllipse(t,e,i,s){return this.drawShape(new ke(t,e,i,s))}drawPolygon(...t){let e,i=!0;const s=t[0];s.points?(i=s.closeStroke,e=s.points):Array.isArray(t[0])?e=t[0]:e=t;const n=new yt(e);return n.closeStroke=i,this.drawShape(n),this}drawShape(t){return this._holeMode?this._geometry.drawHole(t,this._matrix):this._geometry.drawShape(t,this._fillStyle.clone(),this._lineStyle.clone(),this._matrix),this}clear(){return this._geometry.clear(),this._lineStyle.reset(),this._fillStyle.reset(),this._boundsID++,this._matrix=null,this._holeMode=!1,this.currentPath=null,this}isFastRect(){const t=this._geometry.graphicsData;return t.length===1&&t[0].shape.type===F.RECT&&!t[0].matrix&&!t[0].holes.length&&!(t[0].lineStyle.visible&&t[0].lineStyle.width)}_render(t){this.finishPoly();const e=this._geometry;e.updateBatches(),e.batchable?(this.batchDirty!==e.batchDirty&&this._populateBatches(),this._renderBatched(t)):(t.batch.flush(),this._renderDirect(t))}_populateBatches(){const t=this._geometry,e=this.blendMode,i=t.batches.length;this.batchTint=-1,this._transformID=-1,this.batchDirty=t.batchDirty,this.batches.length=i,this.vertexData=new Float32Array(t.points);for(let s=0;s<i;s++){const n=t.batches[s],r=n.style.color,a=new Float32Array(this.vertexData.buffer,n.attribStart*4*2,n.attribSize*2),h=new Float32Array(t.uvsFloat32.buffer,n.attribStart*4*2,n.attribSize*2),c=new Uint16Array(t.indicesUint16.buffer,n.start*2,n.size),l={vertexData:a,blendMode:e,indices:c,uvs:h,_batchRGB:j.shared.setValue(r).toRgbArray(),_tintRGB:r,_texture:n.style.texture,alpha:n.style.alpha,worldAlpha:1};this.batches[s]=l}}_renderBatched(t){if(this.batches.length){t.batch.setObjectRenderer(t.plugins[this.pluginName]),this.calculateVertices(),this.calculateTints();for(let e=0,i=this.batches.length;e<i;e++){const s=this.batches[e];s.worldAlpha=this.worldAlpha*s.alpha,t.plugins[this.pluginName].render(s)}}}_renderDirect(t){const e=this._resolveDirectShader(t),i=this._geometry,s=this.worldAlpha,n=e.uniforms,r=i.drawCalls;n.translationMatrix=this.transform.worldTransform,j.shared.setValue(this._tintColor).premultiply(s).toArray(n.tint),t.shader.bind(e),t.geometry.bind(i,e),t.state.set(this.state);for(let a=0,h=r.length;a<h;a++)this._renderDrawCallDirect(t,i.drawCalls[a])}_renderDrawCallDirect(t,e){const{texArray:i,type:s,size:n,start:r}=e,a=i.count;for(let h=0;h<a;h++)t.texture.bind(i.elements[h],h);t.geometry.draw(s,n,r)}_resolveDirectShader(t){let e=this.shader;const i=this.pluginName;if(!e){if(!St[i]){const{maxTextures:s}=t.plugins[i],n=new Int32Array(s);for(let h=0;h<s;h++)n[h]=h;const r={tint:new Float32Array([1,1,1,1]),translationMatrix:new Ae,default:Ee.from({uSamplers:n},!0)},a=t.plugins[i]._shader.program;St[i]=new Re(a,r)}e=St[i]}return e}_calculateBounds(){this.finishPoly();const t=this._geometry;if(!t.graphicsData.length)return;const{minX:e,minY:i,maxX:s,maxY:n}=t.bounds;this._bounds.addFrame(this.transform,e,i,s,n)}containsPoint(t){return this.worldTransform.applyInverse(t,dt._TEMP_POINT),this._geometry.containsPoint(dt._TEMP_POINT)}calculateTints(){if(this.batchTint!==this.tint){this.batchTint=this._tintColor.toNumber();for(let t=0;t<this.batches.length;t++){const e=this.batches[t];e._tintRGB=j.shared.setValue(this._tintColor).multiply(e._batchRGB).toLittleEndianNumber()}}}calculateVertices(){const t=this.transform._worldID;if(this._transformID===t)return;this._transformID=t;const e=this.transform.worldTransform,i=e.a,s=e.b,n=e.c,r=e.d,a=e.tx,h=e.ty,c=this._geometry.points,l=this.vertexData;let _=0;for(let d=0;d<c.length;d+=2){const p=c[d],u=c[d+1];l[_++]=i*p+n*u+a,l[_++]=r*u+s*p+h}}closePath(){const t=this.currentPath;return t&&(t.closeStroke=!0,this.finishPoly()),this}setMatrix(t){return this._matrix=t,this}beginHole(){return this.finishPoly(),this._holeMode=!0,this}endHole(){return this.finishPoly(),this._holeMode=!1,this}destroy(t){this._geometry.refCount--,this._geometry.refCount===0&&this._geometry.dispose(),this._matrix=null,this.currentPath=null,this._lineStyle.destroy(),this._lineStyle=null,this._fillStyle.destroy(),this._fillStyle=null,this._geometry=null,this.shader=null,this.vertexData=null,this.batches.length=0,this.batches=null,super.destroy(t)}};Pt.curves=it,Pt._TEMP_POINT=new ut;let kt=Pt;const Ht=[.611,1,.7],Qe=he(...Ht),Ke=ae(...Ht),ie=3,Ze=1,vi=1;class ti{constructor(t,e=new At){m(this,"speed",0);m(this,"strength",Ze);m(this,"directionX",0);m(this,"directionY",0);m(this,"_radius",0);m(this,"_invisible",!1);m(this,"dead",!1);m(this,"ghostly",!1);m(this,"disableSimulation",!1);m(this,"_color",Ht);m(this,"colorStr",Qe);m(this,"colorHex",Ke);m(this,"text",null);m(this,"textOffsetX",0);m(this,"textOffsetY",0);m(this,"_fontFamily","Arial");m(this,"_fontSize",26);m(this,"_font","26px Arial");m(this,"_x");m(this,"_y");m(this,"graphics");m(this,"drawn",!1);this.body=t,this.container=e,t.entity=this,this.x=t.x,this.y=t.y,t._circle&&(this.radius=t.radius)}get radius(){return this._radius}set radius(t){this._radius=t,this.body._circle&&(this.body.radius=t)}get invisible(){return this._invisible}set invisible(t){this._invisible=t,this.container.visible=!t}get color(){return this._color}set color(t){const{_color:e}=this;if(t===e)return;const[i,s,n]=t,[r,a,h]=e;if(i===r&&s===a&&n===h)return;this._color=t,this.colorStr=he(i,s,n);const c=this.colorHex=ae(i,s,n);this.graphics&&(this.graphics.tint=c)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this._font=`${t}px ${this._fontFamily}`}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this._font=`${this._fontSize}px ${t}`}get font(){return this._font}get x(){return this._x}set x(t){this._x=t,this.body.x=t,this.container.x=t}get y(){return this._y}set y(t){this._y=t,this.body.y=t,this.container.y=t}draw(){if(this.drawn)throw Error("TODO allow drawing an entity more than once");this.drawn=!0;const{body:t}=this;if(t._circle){const e=this.graphics=new kt;this.container.addChild(e),e.lineStyle(ie,16777215),e.beginFill(0,0),e.drawCircle(0,0,this.radius),e.endFill(),e.tint=this.colorHex}else if(t._polygon){const e=this.graphics=new kt;this.container.addChild(e),e.lineStyle(ie,16777215),e.beginFill(0,0),e.rotation=t.angle,e.drawPolygon(Array.from(t._points)),e.endFill(),e.tint=this.colorHex}if(this.text){const e=new qe(this.text,{fontSize:this.fontSize,fontFamily:this.fontFamily});(this.textOffsetX||this.textOffsetY)&&e.position.set(this.textOffsetX,this.textOffsetY),this.container.addChild(e),e.anchor.set(.5,.5)}}destroy(){this.dead=!0,this.container.destroy({children:!0,texture:!0,baseTexture:!0})}}const ei=(...o)=>{let t=0,e=0,i=0,s=1;const n=o.length?o:[Date.now()];let r=ii();t=r(" "),e=r(" "),i=r(" ");for(const h of n)t-=r(h),t<0&&(t+=1),e-=r(h),e<0&&(e+=1),i-=r(h),i<0&&(i+=1);r=null;const a=()=>{const h=2091639*t+s*23283064365386963e-26;return t=e,e=i,i=h-(s=h|0)};return a.uint32=()=>a()*4294967296,a.fract53=()=>a()+(a()*2097152|0)*11102230246251565e-32,a.version="Alea 0.9",a.seeds=n,a},ii=()=>{let o=4022871197;return t=>{const e=t+"";for(let i=0;i<e.length;i++){o+=e.charCodeAt(i);let s=.02519603282416938*o;o=s>>>0,s-=o,s*=o,o=s>>>0,s-=o,o+=s*4294967296}return(o>>>0)*23283064365386963e-26}};function ue(o,t,e=null,i=!0){const s=o._polygon,n=t._polygon;let r=!1;return e&&(e.a=o,e.b=t,e.a_in_b=!0,e.b_in_a=!0,e.overlap=null,e.overlap_x=0,e.overlap_y=0),s&&(o._dirty_coords||o.x!==o._x||o.y!==o._y||o.angle!==o._angle||o.scale_x!==o._scale_x||o.scale_y!==o._scale_y)&&o._calculate_coords(),n&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculate_coords(),(!i||si(o,t))&&(s&&o._dirty_normals&&o._calculate_normals(),n&&t._dirty_normals&&t._calculate_normals(),r=s&&n?ni(o,t,e):s?se(o,t,e,!1):n?se(t,o,e,!0):ri(o,t,e)),e&&(e.collision=r),r}const si=(o,t)=>{const e=o._polygon,i=e?0:o.x,s=e?0:o.y,n=e?0:o.radius*o.scale,r=e?o._min_x:i-n,a=e?o._min_y:s-n,h=e?o._max_x:i+n,c=e?o._max_y:s+n,l=t._polygon,_=l?0:t.x,d=l?0:t.y,p=l?0:t.radius*t.scale,u=l?t._min_x:_-p,g=l?t._min_y:d-p,b=l?t._max_x:_+p,y=l?t._max_y:d+p;return r<b&&a<y&&h>u&&c>g},ni=(o,t,e=null)=>{const i=o._coords.length,s=t._coords.length;if(i===2&&s===2){const c=o._coords,l=t._coords;return e&&(e.overlap=0),c[0]===l[0]&&c[1]===l[1]}const n=o._coords,r=t._coords,a=o._normals,h=t._normals;if(i>2){for(let c=0,l=1;c<i;c+=2,l+=2)if(ne(n,r,a[c],a[l],e))return!1}if(s>2){for(let c=0,l=1;c<s;c+=2,l+=2)if(ne(n,r,h[c],h[l],e))return!1}return!0},se=(o,t,e=null,i=!1)=>{const s=o._coords,n=o._edges,r=o._normals,a=t.x,h=t.y,c=t.radius*t.scale,l=c*2,_=c*c,d=s.length;let p=!0,u=!0,g=null,b=0,y=0;if(d===2){const w=a-s[0],f=h-s[1],x=w*w+f*f;if(x>_)return!1;if(e){const C=Math.sqrt(x);g=c-C,b=w/C,y=f/C,u=!1}}else for(let w=0,f=1;w<d;w+=2,f+=2){const x=a-s[w],C=h-s[f],I=n[w],S=n[f],D=x*I+C*S,L=D<0?-1:D>I*I+S*S?1:0;let k=!1,A=0,O=0,T=0;if(e&&p&&x*x+C*C>_&&(p=!1),L){const M=L===-1,B=M?w===0?d-2:w-2:w===d-2?0:w+2,E=B+1,P=a-s[B],R=h-s[E],z=n[B],H=n[E],q=P*z+R*H;if((q<0?-1:q>z*z+H*H?1:0)===-L){const G=M?x:P,N=M?C:R,st=G*G+N*N;if(st>_)return!1;if(e){const K=Math.sqrt(st);k=!0,A=c-K,O=G/K,T=N/K,u=!1}}}else{const M=r[w],B=r[f],E=x*M+C*B,P=E<0?-E:E;if(E>0&&P>c)return!1;e&&(k=!0,A=c-E,O=M,T=B,(u&&E>=0||A<l)&&(u=!1))}k&&(g===null||g>A)&&(g=A,b=O,y=T)}return e&&(e.a_in_b=i?u:p,e.b_in_a=i?p:u,e.overlap=g,e.overlap_x=i?-b:b,e.overlap_y=i?-y:y),!0},ri=(o,t,e=null)=>{const i=o.radius*o.scale,s=t.radius*t.scale,n=t.x-o.x,r=t.y-o.y,a=i+s,h=n*n+r*r;if(h>a*a)return!1;if(e){const c=Math.sqrt(h);e.a_in_b=i<=s&&c<=s-i,e.b_in_a=s<=i&&c<=i-s,e.overlap=a-c,e.overlap_x=n/c,e.overlap_y=r/c}return!0},ne=(o,t,e,i,s=null)=>{const n=o.length,r=t.length;if(!n||!r)return!0;let a=null,h=null,c=null,l=null;for(let _=0,d=1;_<n;_+=2,d+=2){const p=o[_]*e+o[d]*i;(a===null||a>p)&&(a=p),(h===null||h<p)&&(h=p)}for(let _=0,d=1;_<r;_+=2,d+=2){const p=t[_]*e+t[d]*i;(c===null||c>p)&&(c=p),(l===null||l<p)&&(l=p)}if(a>l||h<c)return!0;if(s){let _=0;if(a<c)if(s.a_in_b=!1,h<l)_=h-c,s.b_in_a=!1;else{const u=h-c,g=l-a;_=u<g?u:-g}else if(s.b_in_a=!1,h>l)_=a-l,s.a_in_b=!1;else{const u=h-c,g=l-a;_=u<g?u:-g}const d=s.overlap,p=_<0?-_:_;if(d===null||d>p){const u=_<0?-1:1;s.overlap=p,s.overlap_x=e*u,s.overlap_y=i*u}}return!1};class pe{constructor(t=0,e=0,i=0){m(this,"_circle",!1);m(this,"_polygon",!1);m(this,"_point",!1);m(this,"x");m(this,"y");m(this,"padding");m(this,"_bvh_branch",!1);m(this,"_bvh",null);m(this,"_bvh_parent",null);m(this,"_bvh_padding");m(this,"_bvh_min_x",0);m(this,"_bvh_min_y",0);m(this,"_bvh_max_x",0);m(this,"_bvh_max_y",0);this.x=t,this.y=e,this.padding=i,this._bvh_padding=i}collides(t,e=null,i=!0){return ue(this,t,e,i)}potentials(t,e){const i=this._bvh;if(i===null)throw new Error("Body does not belong to a collision system");return i.potentials(this,t,e)}remove(){const t=this._bvh;t&&t.remove(this,!1)}}const Tt=[];class ft{constructor(){m(this,"_bvh_branch",!0);m(this,"_bvh_parent",null);m(this,"_bvh_left",null);m(this,"_bvh_right",null);m(this,"_bvh_sort",0);m(this,"_bvh_min_x",0);m(this,"_bvh_min_y",0);m(this,"_bvh_max_x",0);m(this,"_bvh_max_y",0)}static get_branch(){return Tt.length?Tt.pop():new ft}static release_branch(t){Tt.push(t)}static sort_branches(t,e){return t._bvh_sort>e._bvh_sort?-1:1}}class hi{constructor(){m(this,"_hierarchy",null);m(this,"_bodies",[]);m(this,"_dirty_branches",[])}insert(t,e=!1){if(!e){const u=t._bvh;if(u&&u!==this)throw new Error("Body belongs to another collision system");t._bvh=this,this._bodies.push(t)}const i=t._polygon,s=t.x,n=t.y;i&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculate_coords();const r=t._bvh_padding,a=i?0:t.radius*t.scale,h=(i?t._min_x:s-a)-r,c=(i?t._min_y:n-a)-r,l=(i?t._max_x:s+a)+r,_=(i?t._max_y:n+a)+r;t._bvh_min_x=h,t._bvh_min_y=c,t._bvh_max_x=l,t._bvh_max_y=_;let d=this._hierarchy,p=0;if(!d)this._hierarchy=t;else for(;;)if(d._bvh_branch){const u=d._bvh_left,g=u._bvh_min_y,b=u._bvh_max_x,y=u._bvh_max_y,w=h<u._bvh_min_x?h:u._bvh_min_x,f=c<g?c:g,x=l>b?l:b,C=_>y?_:y,I=(b-u._bvh_min_x)*(y-g),D=(x-w)*(C-f)-I,L=d._bvh_right,k=L._bvh_min_x,A=L._bvh_min_y,O=L._bvh_max_x,T=L._bvh_max_y,M=h<k?h:k,B=c<A?c:A,E=l>O?l:O,P=_>T?_:T,R=(O-k)*(T-A),H=(E-M)*(P-B)-R;d._bvh_sort=p++,d._bvh_min_x=w<M?w:M,d._bvh_min_y=f<B?f:B,d._bvh_max_x=x>E?x:E,d._bvh_max_y=C>P?C:P,d=D<=H?u:L}else{const u=d._bvh_parent,g=d._bvh_min_x,b=d._bvh_min_y,y=d._bvh_max_x,w=d._bvh_max_y,f=d._bvh_parent=t._bvh_parent=ft.get_branch();f._bvh_parent=u,f._bvh_left=d,f._bvh_right=t,f._bvh_sort=p++,f._bvh_min_x=h<g?h:g,f._bvh_min_y=c<b?c:b,f._bvh_max_x=l>y?l:y,f._bvh_max_y=_>w?_:w,u?u._bvh_left===d?u._bvh_left=f:u._bvh_right=f:this._hierarchy=f;break}}remove(t,e=!1){if(!e){const a=t._bvh;if(a&&a!==this)throw new Error("Body belongs to another collision system");t._bvh=null,this._bodies.splice(this._bodies.indexOf(t),1)}if(this._hierarchy===t){this._hierarchy=null;return}const i=t._bvh_parent,s=i._bvh_parent,n=i._bvh_left,r=n===t?i._bvh_right:n;if(r._bvh_parent=s,r._bvh_branch&&(r._bvh_sort=i._bvh_sort),s){s._bvh_left===i?s._bvh_left=r:s._bvh_right=r;let a=s;for(;a;){const h=a._bvh_left,c=h._bvh_min_x,l=h._bvh_min_y,_=h._bvh_max_x,d=h._bvh_max_y,p=a._bvh_right,u=p._bvh_min_x,g=p._bvh_min_y,b=p._bvh_max_x,y=p._bvh_max_y;a._bvh_min_x=c<u?c:u,a._bvh_min_y=l<g?l:g,a._bvh_max_x=_>b?_:b,a._bvh_max_y=d>y?d:y,a=a._bvh_parent}}else this._hierarchy=r;ft.release_branch(i)}update(){const t=this._bodies,e=t.length;for(let i=0;i<e;++i){let s=t[i],n=!1;if(!n&&s.padding!==s._bvh_padding&&(s._bvh_padding=s.padding,n=!0),!n){const r=s._polygon;r&&(s=s,(s._dirty_coords||s.x!==s._x||s.y!==s._y||s.angle!==s._angle||s.scale_x!==s._scale_x||s.scale_y!==s._scale_y)&&s._calculate_coords());const a=s.x,h=s.y,c=r?0:s.radius*s.scale,l=r?s._min_x:a-c,_=r?s._min_y:h-c,d=r?s._max_x:a+c,p=r?s._max_y:h+c;n=l<s._bvh_min_x||_<s._bvh_min_y||d>s._bvh_max_x||p>s._bvh_max_y}n&&(this.remove(s,!0),this.insert(s,!0))}}potentials(t,e,i=[]){const s=t._bvh_min_x,n=t._bvh_min_y,r=t._bvh_max_x,a=t._bvh_max_y;let h=this._hierarchy,c=!0;if(!h||!h._bvh_branch)return i;for(;h;){if(c){c=!1;let _=h._bvh_branch?h._bvh_left:null;for(;_&&_._bvh_max_x>=s&&_._bvh_max_y>=n&&_._bvh_min_x<=r&&_._bvh_min_y<=a;)h=_,_=h._bvh_branch?h._bvh_left:null}const l=h._bvh_branch?h._bvh_right:null;if(l&&l._bvh_max_x>s&&l._bvh_max_y>n&&l._bvh_min_x<r&&l._bvh_min_y<a)h=l,c=!0;else{!h._bvh_branch&&h!==t&&(!e||e(t,h))&&i.push(h);let _=h._bvh_parent;if(_){for(;_&&_._bvh_right===h;)h=_,_=h._bvh_parent;h=_}else break}}return i}}class ai extends pe{constructor(e=0,i=0,s=0,n=1,r=0){super(e,i,r);m(this,"_polygon",!1);m(this,"_circle",!0);m(this,"_point",!1);m(this,"radius");m(this,"scale");this.radius=s,this.scale=n}}class ge extends pe{constructor(e=0,i=0,s=[],n=0,r=1,a=1,h=0){super(e,i,h);m(this,"_polygon",!0);m(this,"_circle",!1);m(this,"_point",!1);m(this,"angle");m(this,"scale_x");m(this,"scale_y");m(this,"_x");m(this,"_y");m(this,"_angle");m(this,"_scale_x");m(this,"_scale_y");m(this,"_min_x",0);m(this,"_min_y",0);m(this,"_max_x",0);m(this,"_max_y",0);m(this,"_points",null);m(this,"_coords",null);m(this,"_edges",null);m(this,"_normals",null);m(this,"_dirty_coords",!0);m(this,"_dirty_normals",!0);this.angle=n,this.scale_x=r,this.scale_y=a,this._x=e,this._y=i,this._angle=n,this._scale_x=r,this._scale_y=a,this.set_points(s)}set_points(e){const i=e.length;this._points=new Float64Array(i*2),this._coords=new Float64Array(i*2),this._edges=new Float64Array(i*2),this._normals=new Float64Array(i*2);const s=this._points;for(let n=0,r=0,a=1;n<i;++n,r+=2,a+=2){const h=e[n];s[r]=h[0],s[a]=h[1]}this._dirty_coords=!0}_calculate_coords(){const{x:e,y:i,angle:s,scale_x:n,scale_y:r,_points:a,_coords:h}=this,c=a.length;let l=0,_=0,d=0,p=0;for(let u=0,g=1;u<c;u+=2,g+=2){let b=a[u]*n,y=a[g]*r;if(s){const w=Math.cos(s),f=Math.sin(s),x=b,C=y;b=x*w-C*f,y=x*f+C*w}b+=e,y+=i,h[u]=b,h[g]=y,u===0?(l=_=b,d=p=y):(b<l?l=b:b>_&&(_=b),y<d?d=y:y>p&&(p=y))}this._x=e,this._y=i,this._angle=s,this._scale_x=n,this._scale_y=r,this._min_x=l,this._min_y=d,this._max_x=_,this._max_y=p,this._dirty_coords=!1,this._dirty_normals=!0}_calculate_normals(){const{_coords:e,_edges:i,_normals:s}=this,n=e.length;for(let r=0,a=1;r<n;r+=2,a+=2){const h=r+2<n?r+2:0,c=e[h]-e[r],l=e[h+1]-e[a],_=c||l?Math.sqrt(c*c+l*l):0;i[r]=c,i[a]=l,s[r]=_?l/_:0,s[a]=_?-c/_:0}this._dirty_normals=!1}}class oi extends ge{constructor(e=0,i=0,s=0){super(e,i,[[0,0]],0,1,1,s);m(this,"_polygon",!0);m(this,"_circle",!1);m(this,"_point",!0);m(this,"set_points")}}class li{constructor(){m(this,"_bvh");this._bvh=new hi}create_circle(t=0,e=0,i=0,s=1,n=0){const r=new ai(t,e,i,s,n);return this._bvh.insert(r),r}create_polygon(t=0,e=0,i=[[0,0]],s=0,n=1,r=1,a=0){const h=new ge(t,e,i,s,n,r,a);return this._bvh.insert(h),h}create_point(t=0,e=0,i=0){const s=new oi(t,e,i);return this._bvh.insert(s),s}insert(...t){for(const e of t)this._bvh.insert(e,!1);return this}remove(...t){for(const e of t)this._bvh.remove(e,!1);return this}update(){return this._bvh.update(),this}potentials(t,e,i){return this._bvh.potentials(t,e,i)}collides(t,e,i=null,s=!0){return ue(t,e,i,s)}}class ci{constructor(){m(this,"collision",!1);m(this,"a",null);m(this,"b",null);m(this,"a_in_b",!1);m(this,"b_in_a",!1);m(this,"overlap",0);m(this,"overlap_x",0);m(this,"overlap_y",0)}}const re=new ci,Si=(o,t,e)=>{const i=e.overlap*e.overlap_x,s=e.overlap*e.overlap_y,n=o.strength/(o.strength+t.strength)*(t.speed/(t.speed+o.speed)),r=1-n;o.x-=r*i,o.y-=r*s,t.x+=n*i,t.y+=n*s},Ti=(o,t,e,i=48)=>{const s=[];if(o.body._circle){const n=_i(Math.PI*o.radius**2,e,i);for(let r=0;r<e;r++){const a=new ti(t.create_circle(o.x,o.y,n[r]));a.speed=o.speed,a.directionX=o.directionX,a.directionY=o.directionY,a.color=o.color,s.push(a)}}else throw Error("TODO more types than circles");return s},_i=(o,t,e)=>{const i=[];for(let h=0;h<t;h++)i[h]=1+Be(0,1)*(e-1);const s=i.reduce((h,c)=>h+c);return i.map(h=>h/s).map(h=>h*o).map(h=>Math.sqrt(h/Math.PI))},Mt=[];class di{constructor(t){m(this,"collisions");m(this,"entities",new Set);this.collisions=t}addEntity(t){this.entities.add(t)}removeEntity(t){t.body.remove(),this.entities.delete(t)}update(t,e,i){this.collisions.update();let s;for(const n of this.entities)if(!n.disableSimulation&&(s=n.speed*t,n.x+=n.directionX*s,n.y+=n.directionY*s,!n.ghostly)){Mt.length=0,n.body.potentials(i,Mt);for(const r of Mt)if(!r.entity.ghostly&&n.body.collides(r,re)&&(e(n,r.entity,re),n.dead))break}}}class ui{constructor(){m(this,"moving",We(!1));m(this,"movingLeft",!1);m(this,"movingRight",!1);m(this,"movingUp",!1);m(this,"movingDown",!1);m(this,"pointer_down",!1);m(this,"viewportWidth",0);m(this,"viewportHeight",0);m(this,"viewWidth",0);m(this,"viewHeight",0);m(this,"worldWidth",0);m(this,"worldHeight",0);m(this,"pointerScreenX",null);m(this,"pointerScreenY",null)}setPointerDown(t){this.pointer_down=t,this.moving.set(this.isMoving())}setPointerLocation(t,e){this.pointerScreenX=t,this.pointerScreenY=e}isMoving(){return this.pointer_down||this.movingDown||this.movingUp||this.movingLeft||this.movingRight}handleKeydown(t){switch(t){case"ArrowLeft":case"a":{this.movingLeft=!0,this.moving.set(!0);break}case"ArrowRight":case"d":{this.movingRight=!0,this.moving.set(!0);break}case"ArrowUp":case"w":{this.movingUp=!0,this.moving.set(!0);break}case"ArrowDown":case"s":{this.movingDown=!0,this.moving.set(!0);break}default:console.log("unhandled keydown",t)}}handleKeyup(t){switch(t){case"ArrowLeft":case"a":{this.movingLeft=!1,this.moving.set(this.isMoving());break}case"ArrowRight":case"d":{this.movingRight=!1,this.moving.set(this.isMoving());break}case"ArrowUp":case"w":{this.movingUp=!1,this.moving.set(this.isMoving());break}case"ArrowDown":case"s":{this.movingDown=!1,this.moving.set(this.isMoving());break}default:console.log("unhandled keyup",t)}}}const pi=5,Mi=(o,t,e)=>{if(o.pointer_down&&o.pointerScreenX!==null&&o.pointerScreenY!==null){const i=o.viewWidth/o.worldWidth,s=o.pointerScreenX-o.viewportWidth/2+o.viewWidth/2,n=o.pointerScreenY-o.viewportHeight/2+o.viewHeight/2,r=s/i+e.x-e.width/2,a=n/i+e.y-e.height/2,h=r-t.x,c=a-t.y,l=Math.hypot(h,c),_=!l||l<pi;t.directionX=_?0:h/l,t.directionY=_?0:c/l}else{const{movingLeft:i,movingRight:s,movingUp:n,movingDown:r}=o,a=i&&!s?-1:s&&!i?1:0,h=n&&!r?-1:r&&!n?1:0;t.directionX=h===0?a:a/Math.SQRT2,t.directionY=a===0?h:h/Math.SQRT2}},fe={hard:!0},gi=(o,t)=>{const e={x:0,y:0,scale:1,width:0,height:0,...o},i=Fe(e,{stiffness:.006,damping:.12,...t}),{subscribe:s}=He(i,r=>{const a=r.x-r.width/2,h=r.y-r.height/2;return{...r,left:a,right:a+r.width,top:h,bottom:h+r.height}});return{subscribe:s,zoom:r=>{console.log("zoom amount",r)},setPosition:(r,a,h)=>i.update(c=>({...c,x:r,y:a}),h),set_dimensions:(r,a,h=fe)=>i.update(c=>({...c,width:r,height:a}),h)}};var Dt;let Di=(Dt=class{constructor(t){m(this,"exit");m(this,"sim");m(this,"collisions");m(this,"container");m(this,"mask",null);m(this,"controller");m(this,"random");m(this,"time",0);m(this,"timeDilation",1);m(this,"worldWidth");m(this,"worldHeight");m(this,"viewWidth");m(this,"viewHeight");m(this,"viewportWidth");m(this,"viewportHeight");m(this,"camera");m(this,"$camera");m(this,"freezeCamera",!1);m(this,"subscriptions",[]);const{exit:e,data:i,worldWidth:s,worldHeight:n,viewWidth:r,viewHeight:a,viewportWidth:h,viewportHeight:c,collisions:l=new li,sim:_=new di(l),container:d=new At,controller:p=new ui,random:u=ei()}=t;i&&(i.freezeCamera!==void 0&&(this.freezeCamera=i.freezeCamera),i.timeDilation!==void 0&&(this.timeDilation=i.timeDilation)),this.exit=e,this.sim=_,this.collisions=l,this.container=d,this.controller=p,this.random=u,this.worldWidth=s,this.worldHeight=n,this.viewWidth=r,this.viewHeight=a,this.viewportWidth=h,this.viewportHeight=c,this.camera=gi({width:s,height:n,x:s/2,y:n/2}),this.subscriptions.push(this.camera.subscribe(g=>this.$camera=g))}async setup(t){}async teardown(){}destroy(){this.container.destroy({children:!0,baseTexture:!0,texture:!0});for(const t of this.subscriptions)t()}update(t){this.time+=t,this.updateCameraPosition()}toData(){return{freezeCamera:this.freezeCamera,playerSpeed:this.player.speed,playerStrength:this.player.strength,timeDilation:this.timeDilation}}resize(t,e,i,s,n,r){this.worldWidth=t,this.worldHeight=e,this.viewWidth=i,this.viewHeight=s,this.viewportWidth=n,this.viewportHeight=r,this.drawMask(),this.camera.set_dimensions(t,e),this.freezeCamera&&this.camera.setPosition(t/2,e/2,fe),this.updateCameraPosition(),this.afterResize()}updateCameraPosition(){const{container:t,viewWidth:e,viewHeight:i,$camera:s}=this,n=Math.min(e/this.worldWidth,i/this.worldHeight);t.scale.set(n),t.position.set((-s.x+s.width/2)*n+(this.viewportWidth-e)/2,(-s.y+s.height/2)*n+(this.viewportHeight-i)/2)}afterResize(){}drawMask(){const t=(this.viewportWidth-this.viewWidth)/2,e=(this.viewportHeight-this.viewHeight)/2;t===0&&e===0?this.mask&&(this.container.mask=null,this.mask.parent.removeChild(this.mask),this.mask.destroy({baseTexture:!0,texture:!0}),this.mask=null):(this.mask?this.mask.clear():(this.mask=new kt,this.container.mask=this.mask,this.container.addChild(this.mask)),this.mask.beginFill(0),this.mask.drawRect(0,0,this.worldWidth,this.worldHeight),this.mask.endFill())}addEntity(t){this.sim.addEntity(t),this.container.addChild(t.container),t.draw()}removeEntity(t){this.container.removeChild(t.container),this.sim.removeEntity(t),t.destroy()}},m(Dt,"meta"),Dt);export{Ze as D,ti as E,Di as S,vi as a,Si as c,$t as d,Ti as f,Mi as u};
