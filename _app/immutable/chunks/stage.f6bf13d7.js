var be=Object.defineProperty;var we=(a,t,e)=>t in a?be(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var v=(a,t,e)=>(we(a,typeof t!="symbol"?t+"":t,e),e);import{q as zt,m as rt,i as j,a as ve,d as et,R as Dt,p as Se,r as Nt,t as F,u as Te,v as Lt,P as ut,w as Ce,x as Me,W as Ut,B as jt,y as qt,z as Gt,D as lt,C as At,f as De,G as Le,H as yt,I as Pe,J as Ie,K as ke,M as Ae,U as Ee,h as Re}from"./pixi.3ef5fa28.js";import{a as Be}from"./random.c2e51b4a.js";import{a as he,b as ae}from"./colors.454075f6.js";import{w as We,d as He}from"./index.6dadb349.js";import{s as Fe}from"./spring.da9c6ce4.js";function Yt(a,t,e){for(let i=0,s=4*e*t;i<t;++i,s+=4)if(a[s+3]!==0)return!1;return!0}function Vt(a,t,e,i,s){const n=4*t;for(let r=i,o=i*n+4*e;r<=s;++r,o+=n)if(a[o+3]!==0)return!1;return!0}function Oe(a){const{width:t,height:e}=a,i=a.getContext("2d",{willReadFrequently:!0});if(i===null)throw new TypeError("Failed to get canvas 2D context");const s=i.getImageData(0,0,t,e).data;let n=0,r=0,o=t-1,h=e-1;for(;r<e&&Yt(s,t,r);)++r;if(r===e)return zt.EMPTY;for(;Yt(s,t,h);)--h;for(;Vt(s,t,n,r,h);)++n;for(;Vt(s,t,o,r,h);)--o;return++o,++h,new zt(n,r,o,h)}function ze(a){const t=Oe(a),{width:e,height:i}=t;let s=null;if(!t.isEmpty()){const n=a.getContext("2d");if(n===null)throw new TypeError("Failed to get canvas 2D context");s=n.getImageData(t.left,t.top,e,i)}return{width:e,height:i,data:s}}var Xt=Object.prototype.hasOwnProperty;function $t(a,t){var e,i;if(a===t)return!0;if(a&&t&&(e=a.constructor)===t.constructor){if(e===Date)return a.getTime()===t.getTime();if(e===RegExp)return a.toString()===t.toString();if(e===Array){if((i=a.length)===t.length)for(;i--&&$t(a[i],t[i]););return i===-1}if(!e||typeof a=="object"){i=0;for(e in a)if(Xt.call(a,e)&&++i&&!Xt.call(t,e)||!(e in t)||!$t(a[e],t[e]))return!1;return Object.keys(t).length===i}}return a!==a&&t!==t}var Et=(a=>(a[a.LINEAR_VERTICAL=0]="LINEAR_VERTICAL",a[a.LINEAR_HORIZONTAL=1]="LINEAR_HORIZONTAL",a))(Et||{});const ct={willReadFrequently:!0},N=class w{static get experimentalLetterSpacingSupported(){let t=w._experimentalLetterSpacingSupported;if(t!==void 0){const e=rt.ADAPTER.getCanvasRenderingContext2D().prototype;t=w._experimentalLetterSpacingSupported="letterSpacing"in e||"textLetterSpacing"in e}return t}constructor(t,e,i,s,n,r,o,h,c){this.text=t,this.style=e,this.width=i,this.height=s,this.lines=n,this.lineWidths=r,this.lineHeight=o,this.maxLineWidth=h,this.fontProperties=c}static measureText(t,e,i,s=w._canvas){i=i??e.wordWrap;const n=e.toFontString(),r=w.measureFont(n);r.fontSize===0&&(r.fontSize=e.fontSize,r.ascent=e.fontSize);const o=s.getContext("2d",ct);o.font=n;const h=(i?w.wordWrap(t,e,s):t).split(/(?:\r\n|\r|\n)/),c=new Array(h.length);let l=0;for(let u=0;u<h.length;u++){const g=w._measureText(h[u],e.letterSpacing,o);c[u]=g,l=Math.max(l,g)}let _=l+e.strokeThickness;e.dropShadow&&(_+=e.dropShadowDistance);const d=e.lineHeight||r.fontSize+e.strokeThickness;let p=Math.max(d,r.fontSize+e.strokeThickness*2)+e.leading+(h.length-1)*(d+e.leading);return e.dropShadow&&(p+=e.dropShadowDistance),new w(t,e,_,p,h,c,d+e.leading,l,r)}static _measureText(t,e,i){let s=!1;w.experimentalLetterSpacingSupported&&(w.experimentalLetterSpacing?(i.letterSpacing=`${e}px`,i.textLetterSpacing=`${e}px`,s=!0):(i.letterSpacing="0px",i.textLetterSpacing="0px"));let n=i.measureText(t).width;return n>0&&(s?n-=e:n+=(w.graphemeSegmenter(t).length-1)*e),n}static wordWrap(t,e,i=w._canvas){const s=i.getContext("2d",ct);let n=0,r="",o="";const h=Object.create(null),{letterSpacing:c,whiteSpace:l}=e,_=w.collapseSpaces(l),d=w.collapseNewlines(l);let p=!_;const u=e.wordWrapWidth+c,g=w.tokenize(t);for(let y=0;y<g.length;y++){let x=g[y];if(w.isNewline(x)){if(!d){o+=w.addLine(r),p=!_,r="",n=0;continue}x=" "}if(_){const f=w.isBreakingSpace(x),m=w.isBreakingSpace(r[r.length-1]);if(f&&m)continue}const b=w.getFromCache(x,c,h,s);if(b>u)if(r!==""&&(o+=w.addLine(r),r="",n=0),w.canBreakWords(x,e.breakWords)){const f=w.wordWrapSplit(x);for(let m=0;m<f.length;m++){let D=f[m],P=D,S=1;for(;f[m+S];){const L=f[m+S];if(!w.canBreakChars(P,L,x,m,e.breakWords))D+=L;else break;P=L,S++}m+=S-1;const M=w.getFromCache(D,c,h,s);M+n>u&&(o+=w.addLine(r),p=!1,r="",n=0),r+=D,n+=M}}else{r.length>0&&(o+=w.addLine(r),r="",n=0);const f=y===g.length-1;o+=w.addLine(x,!f),p=!1,r="",n=0}else b+n>u&&(p=!1,o+=w.addLine(r),r="",n=0),(r.length>0||!w.isBreakingSpace(x)||p)&&(r+=x,n+=b)}return o+=w.addLine(r,!1),o}static addLine(t,e=!0){return t=w.trimRight(t),t=e?`${t}
`:t,t}static getFromCache(t,e,i,s){let n=i[t];return typeof n!="number"&&(n=w._measureText(t,e,s)+e,i[t]=n),n}static collapseSpaces(t){return t==="normal"||t==="pre-line"}static collapseNewlines(t){return t==="normal"}static trimRight(t){if(typeof t!="string")return"";for(let e=t.length-1;e>=0;e--){const i=t[e];if(!w.isBreakingSpace(i))break;t=t.slice(0,-1)}return t}static isNewline(t){return typeof t!="string"?!1:w._newlines.includes(t.charCodeAt(0))}static isBreakingSpace(t,e){return typeof t!="string"?!1:w._breakingSpaces.includes(t.charCodeAt(0))}static tokenize(t){const e=[];let i="";if(typeof t!="string")return e;for(let s=0;s<t.length;s++){const n=t[s],r=t[s+1];if(w.isBreakingSpace(n,r)||w.isNewline(n)){i!==""&&(e.push(i),i=""),e.push(n);continue}i+=n}return i!==""&&e.push(i),e}static canBreakWords(t,e){return e}static canBreakChars(t,e,i,s,n){return!0}static wordWrapSplit(t){return w.graphemeSegmenter(t)}static measureFont(t){if(w._fonts[t])return w._fonts[t];const e={ascent:0,descent:0,fontSize:0},i=w._canvas,s=w._context;s.font=t;const n=w.METRICS_STRING+w.BASELINE_SYMBOL,r=Math.ceil(s.measureText(n).width);let o=Math.ceil(s.measureText(w.BASELINE_SYMBOL).width);const h=Math.ceil(w.HEIGHT_MULTIPLIER*o);if(o=o*w.BASELINE_MULTIPLIER|0,r===0||h===0)return w._fonts[t]=e,e;i.width=r,i.height=h,s.fillStyle="#f00",s.fillRect(0,0,r,h),s.font=t,s.textBaseline="alphabetic",s.fillStyle="#000",s.fillText(n,0,o);const c=s.getImageData(0,0,r,h).data,l=c.length,_=r*4;let d=0,p=0,u=!1;for(d=0;d<o;++d){for(let g=0;g<_;g+=4)if(c[p+g]!==255){u=!0;break}if(!u)p+=_;else break}for(e.ascent=o-d,p=l-_,u=!1,d=h;d>o;--d){for(let g=0;g<_;g+=4)if(c[p+g]!==255){u=!0;break}if(!u)p-=_;else break}return e.descent=d-o,e.fontSize=e.ascent+e.descent,w._fonts[t]=e,e}static clearMetrics(t=""){t?delete w._fonts[t]:w._fonts={}}static get _canvas(){var t;if(!w.__canvas){let e;try{const i=new OffscreenCanvas(0,0);if((t=i.getContext("2d",ct))!=null&&t.measureText)return w.__canvas=i,i;e=rt.ADAPTER.createCanvas()}catch{e=rt.ADAPTER.createCanvas()}e.width=e.height=10,w.__canvas=e}return w.__canvas}static get _context(){return w.__context||(w.__context=w._canvas.getContext("2d",ct)),w.__context}};N.METRICS_STRING="|ÉqÅ",N.BASELINE_SYMBOL="M",N.BASELINE_MULTIPLIER=1.4,N.HEIGHT_MULTIPLIER=2,N.graphemeSegmenter=(()=>{if(typeof(Intl==null?void 0:Intl.Segmenter)=="function"){const a=new Intl.Segmenter;return t=>[...a.segment(t)].map(e=>e.segment)}return a=>[...a]})(),N.experimentalLetterSpacing=!1,N._fonts={},N._newlines=[10,13],N._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];let Z=N;const Ne=["serif","sans-serif","monospace","cursive","fantasy","system-ui"],oe=class nt{constructor(t){this.styleID=0,this.reset(),wt(this,t,t)}clone(){const t={};return wt(t,this,nt.defaultStyle),new nt(t)}reset(){wt(this,nt.defaultStyle,nt.defaultStyle)}get align(){return this._align}set align(t){this._align!==t&&(this._align=t,this.styleID++)}get breakWords(){return this._breakWords}set breakWords(t){this._breakWords!==t&&(this._breakWords=t,this.styleID++)}get dropShadow(){return this._dropShadow}set dropShadow(t){this._dropShadow!==t&&(this._dropShadow=t,this.styleID++)}get dropShadowAlpha(){return this._dropShadowAlpha}set dropShadowAlpha(t){this._dropShadowAlpha!==t&&(this._dropShadowAlpha=t,this.styleID++)}get dropShadowAngle(){return this._dropShadowAngle}set dropShadowAngle(t){this._dropShadowAngle!==t&&(this._dropShadowAngle=t,this.styleID++)}get dropShadowBlur(){return this._dropShadowBlur}set dropShadowBlur(t){this._dropShadowBlur!==t&&(this._dropShadowBlur=t,this.styleID++)}get dropShadowColor(){return this._dropShadowColor}set dropShadowColor(t){const e=bt(t);this._dropShadowColor!==e&&(this._dropShadowColor=e,this.styleID++)}get dropShadowDistance(){return this._dropShadowDistance}set dropShadowDistance(t){this._dropShadowDistance!==t&&(this._dropShadowDistance=t,this.styleID++)}get fill(){return this._fill}set fill(t){const e=bt(t);this._fill!==e&&(this._fill=e,this.styleID++)}get fillGradientType(){return this._fillGradientType}set fillGradientType(t){this._fillGradientType!==t&&(this._fillGradientType=t,this.styleID++)}get fillGradientStops(){return this._fillGradientStops}set fillGradientStops(t){Ue(this._fillGradientStops,t)||(this._fillGradientStops=t,this.styleID++)}get fontFamily(){return this._fontFamily}set fontFamily(t){this.fontFamily!==t&&(this._fontFamily=t,this.styleID++)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.styleID++)}get fontStyle(){return this._fontStyle}set fontStyle(t){this._fontStyle!==t&&(this._fontStyle=t,this.styleID++)}get fontVariant(){return this._fontVariant}set fontVariant(t){this._fontVariant!==t&&(this._fontVariant=t,this.styleID++)}get fontWeight(){return this._fontWeight}set fontWeight(t){this._fontWeight!==t&&(this._fontWeight=t,this.styleID++)}get letterSpacing(){return this._letterSpacing}set letterSpacing(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.styleID++)}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.styleID++)}get leading(){return this._leading}set leading(t){this._leading!==t&&(this._leading=t,this.styleID++)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin!==t&&(this._lineJoin=t,this.styleID++)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit!==t&&(this._miterLimit=t,this.styleID++)}get padding(){return this._padding}set padding(t){this._padding!==t&&(this._padding=t,this.styleID++)}get stroke(){return this._stroke}set stroke(t){const e=bt(t);this._stroke!==e&&(this._stroke=e,this.styleID++)}get strokeThickness(){return this._strokeThickness}set strokeThickness(t){this._strokeThickness!==t&&(this._strokeThickness=t,this.styleID++)}get textBaseline(){return this._textBaseline}set textBaseline(t){this._textBaseline!==t&&(this._textBaseline=t,this.styleID++)}get trim(){return this._trim}set trim(t){this._trim!==t&&(this._trim=t,this.styleID++)}get whiteSpace(){return this._whiteSpace}set whiteSpace(t){this._whiteSpace!==t&&(this._whiteSpace=t,this.styleID++)}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!==t&&(this._wordWrap=t,this.styleID++)}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.styleID++)}toFontString(){const t=typeof this.fontSize=="number"?`${this.fontSize}px`:this.fontSize;let e=this.fontFamily;Array.isArray(this.fontFamily)||(e=this.fontFamily.split(","));for(let i=e.length-1;i>=0;i--){let s=e[i].trim();!/([\"\'])[^\'\"]+\1/.test(s)&&!Ne.includes(s)&&(s=`"${s}"`),e[i]=s}return`${this.fontStyle} ${this.fontVariant} ${this.fontWeight} ${t} ${e.join(",")}`}};oe.defaultStyle={align:"left",breakWords:!1,dropShadow:!1,dropShadowAlpha:1,dropShadowAngle:Math.PI/6,dropShadowBlur:0,dropShadowColor:"black",dropShadowDistance:5,fill:"black",fillGradientType:Et.LINEAR_VERTICAL,fillGradientStops:[],fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,lineJoin:"miter",miterLimit:10,padding:0,stroke:"black",strokeThickness:0,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let Jt=oe;function bt(a){const t=j.shared,e=i=>{const s=t.setValue(i);return s.alpha===1?s.toHex():s.toRgbaString()};return Array.isArray(a)?a.map(e):e(a)}function Ue(a,t){if(!Array.isArray(a)||!Array.isArray(t)||a.length!==t.length)return!1;for(let e=0;e<a.length;++e)if(a[e]!==t[e])return!1;return!0}function wt(a,t,e){for(const i in e)Array.isArray(t[i])?a[i]=t[i].slice():a[i]=t[i]}const je={texture:!0,children:!1,baseTexture:!0},le=class Pt extends ve{constructor(t,e,i){let s=!1;i||(i=rt.ADAPTER.createCanvas(),s=!0),i.width=3,i.height=3;const n=et.from(i);n.orig=new Dt,n.trim=new Dt,super(n),this._ownCanvas=s,this.canvas=i,this.context=i.getContext("2d",{willReadFrequently:!0}),this._resolution=Pt.defaultResolution??rt.RESOLUTION,this._autoResolution=Pt.defaultAutoResolution,this._text=null,this._style=null,this._styleListener=null,this._font="",this.text=t,this.style=e,this.localStyleID=-1}static get experimentalLetterSpacing(){return Z.experimentalLetterSpacing}static set experimentalLetterSpacing(t){Se("7.1.0","Text.experimentalLetterSpacing is deprecated, use TextMetrics.experimentalLetterSpacing"),Z.experimentalLetterSpacing=t}updateText(t){const e=this._style;if(this.localStyleID!==e.styleID&&(this.dirty=!0,this.localStyleID=e.styleID),!this.dirty&&t)return;this._font=this._style.toFontString();const i=this.context,s=Z.measureText(this._text||" ",this._style,this._style.wordWrap,this.canvas),n=s.width,r=s.height,o=s.lines,h=s.lineHeight,c=s.lineWidths,l=s.maxLineWidth,_=s.fontProperties;this.canvas.width=Math.ceil(Math.ceil(Math.max(1,n)+e.padding*2)*this._resolution),this.canvas.height=Math.ceil(Math.ceil(Math.max(1,r)+e.padding*2)*this._resolution),i.scale(this._resolution,this._resolution),i.clearRect(0,0,this.canvas.width,this.canvas.height),i.font=this._font,i.lineWidth=e.strokeThickness,i.textBaseline=e.textBaseline,i.lineJoin=e.lineJoin,i.miterLimit=e.miterLimit;let d,p;const u=e.dropShadow?2:1;for(let g=0;g<u;++g){const y=e.dropShadow&&g===0,x=y?Math.ceil(Math.max(1,r)+e.padding*2):0,b=x*this._resolution;if(y){i.fillStyle="black",i.strokeStyle="black";const m=e.dropShadowColor,D=e.dropShadowBlur*this._resolution,P=e.dropShadowDistance*this._resolution;i.shadowColor=j.shared.setValue(m).setAlpha(e.dropShadowAlpha).toRgbaString(),i.shadowBlur=D,i.shadowOffsetX=Math.cos(e.dropShadowAngle)*P,i.shadowOffsetY=Math.sin(e.dropShadowAngle)*P+b}else i.fillStyle=this._generateFillStyle(e,o,s),i.strokeStyle=e.stroke,i.shadowColor="black",i.shadowBlur=0,i.shadowOffsetX=0,i.shadowOffsetY=0;let f=(h-_.fontSize)/2;h-_.fontSize<0&&(f=0);for(let m=0;m<o.length;m++)d=e.strokeThickness/2,p=e.strokeThickness/2+m*h+_.ascent+f,e.align==="right"?d+=l-c[m]:e.align==="center"&&(d+=(l-c[m])/2),e.stroke&&e.strokeThickness&&this.drawLetterSpacing(o[m],d+e.padding,p+e.padding-x,!0),e.fill&&this.drawLetterSpacing(o[m],d+e.padding,p+e.padding-x)}this.updateTexture()}drawLetterSpacing(t,e,i,s=!1){const n=this._style.letterSpacing;let r=!1;if(Z.experimentalLetterSpacingSupported&&(Z.experimentalLetterSpacing?(this.context.letterSpacing=`${n}px`,this.context.textLetterSpacing=`${n}px`,r=!0):(this.context.letterSpacing="0px",this.context.textLetterSpacing="0px")),n===0||r){s?this.context.strokeText(t,e,i):this.context.fillText(t,e,i);return}let o=e;const h=Z.graphemeSegmenter(t);let c=this.context.measureText(t).width,l=0;for(let _=0;_<h.length;++_){const d=h[_];s?this.context.strokeText(d,o,i):this.context.fillText(d,o,i);let p="";for(let u=_+1;u<h.length;++u)p+=h[u];l=this.context.measureText(p).width,o+=c-l+n,c=l}}updateTexture(){const t=this.canvas;if(this._style.trim){const r=ze(t);r.data&&(t.width=r.width,t.height=r.height,this.context.putImageData(r.data,0,0))}const e=this._texture,i=this._style,s=i.trim?0:i.padding,n=e.baseTexture;e.trim.width=e._frame.width=t.width/this._resolution,e.trim.height=e._frame.height=t.height/this._resolution,e.trim.x=-s,e.trim.y=-s,e.orig.width=e._frame.width-s*2,e.orig.height=e._frame.height-s*2,this._onTextureUpdate(),n.setRealSize(t.width,t.height,this._resolution),e.updateUvs(),this.dirty=!1}_render(t){this._autoResolution&&this._resolution!==t.resolution&&(this._resolution=t.resolution,this.dirty=!0),this.updateText(!0),super._render(t)}updateTransform(){this.updateText(!0),super.updateTransform()}getBounds(t,e){return this.updateText(!0),this._textureID===-1&&(t=!1),super.getBounds(t,e)}getLocalBounds(t){return this.updateText(!0),super.getLocalBounds.call(this,t)}_calculateBounds(){this.calculateVertices(),this._bounds.addQuad(this.vertexData)}_generateFillStyle(t,e,i){const s=t.fill;if(Array.isArray(s)){if(s.length===1)return s[0]}else return s;let n;const r=t.dropShadow?t.dropShadowDistance:0,o=t.padding||0,h=this.canvas.width/this._resolution-r-o*2,c=this.canvas.height/this._resolution-r-o*2,l=s.slice(),_=t.fillGradientStops.slice();if(!_.length){const d=l.length+1;for(let p=1;p<d;++p)_.push(p/d)}if(l.unshift(s[0]),_.unshift(0),l.push(s[s.length-1]),_.push(1),t.fillGradientType===Et.LINEAR_VERTICAL){n=this.context.createLinearGradient(h/2,o,h/2,c+o);const d=i.fontProperties.fontSize+t.strokeThickness;for(let p=0;p<e.length;p++){const u=i.lineHeight*(p-1)+d,g=i.lineHeight*p;let y=g;p>0&&u>g&&(y=(g+u)/2);const x=g+d,b=i.lineHeight*(p+1);let f=x;p+1<e.length&&b<x&&(f=(x+b)/2);const m=(f-y)/c;for(let D=0;D<l.length;D++){let P=0;typeof _[D]=="number"?P=_[D]:P=D/l.length;let S=Math.min(1,Math.max(0,y/c+P*m));S=Number(S.toFixed(5)),n.addColorStop(S,l[D])}}}else{n=this.context.createLinearGradient(o,c/2,h+o,c/2);const d=l.length+1;let p=1;for(let u=0;u<l.length;u++){let g;typeof _[u]=="number"?g=_[u]:g=p/d,n.addColorStop(g,l[u]),p++}}return n}destroy(t){typeof t=="boolean"&&(t={children:t}),t=Object.assign({},je,t),super.destroy(t),this._ownCanvas&&(this.canvas.height=this.canvas.width=0),this.context=null,this.canvas=null,this._style=null}get width(){return this.updateText(!0),Math.abs(this.scale.x)*this._texture.orig.width}set width(t){this.updateText(!0);const e=Nt(this.scale.x)||1;this.scale.x=e*t/this._texture.orig.width,this._width=t}get height(){return this.updateText(!0),Math.abs(this.scale.y)*this._texture.orig.height}set height(t){this.updateText(!0);const e=Nt(this.scale.y)||1;this.scale.y=e*t/this._texture.orig.height,this._height=t}get style(){return this._style}set style(t){t=t||{},t instanceof Jt?this._style=t:this._style=new Jt(t),this.localStyleID=-1,this.dirty=!0}get text(){return this._text}set text(t){t=String(t??""),this._text!==t&&(this._text=t,this.dirty=!0)}get resolution(){return this._resolution}set resolution(t){this._autoResolution=!1,this._resolution!==t&&(this._resolution=t,this.dirty=!0)}};le.defaultAutoResolution=!0;let qe=le;const pt={build(a){const t=a.points;let e,i,s,n,r,o;if(a.type===F.CIRC){const u=a.shape;e=u.x,i=u.y,r=o=u.radius,s=n=0}else if(a.type===F.ELIP){const u=a.shape;e=u.x,i=u.y,r=u.width,o=u.height,s=n=0}else{const u=a.shape,g=u.width/2,y=u.height/2;e=u.x+g,i=u.y+y,r=o=Math.max(0,Math.min(u.radius,Math.min(g,y))),s=g-r,n=y-o}if(!(r>=0&&o>=0&&s>=0&&n>=0)){t.length=0;return}const h=Math.ceil(2.3*Math.sqrt(r+o)),c=h*8+(s?4:0)+(n?4:0);if(t.length=c,c===0)return;if(h===0){t.length=8,t[0]=t[6]=e+s,t[1]=t[3]=i+n,t[2]=t[4]=e-s,t[5]=t[7]=i-n;return}let l=0,_=h*4+(s?2:0)+2,d=_,p=c;{const u=s+r,g=n,y=e+u,x=e-u,b=i+g;if(t[l++]=y,t[l++]=b,t[--_]=b,t[--_]=x,n){const f=i-g;t[d++]=x,t[d++]=f,t[--p]=f,t[--p]=y}}for(let u=1;u<h;u++){const g=Math.PI/2*(u/h),y=s+Math.cos(g)*r,x=n+Math.sin(g)*o,b=e+y,f=e-y,m=i+x,D=i-x;t[l++]=b,t[l++]=m,t[--_]=m,t[--_]=f,t[d++]=f,t[d++]=D,t[--p]=D,t[--p]=b}{const u=s,g=n+o,y=e+u,x=e-u,b=i+g,f=i-g;t[l++]=y,t[l++]=b,t[--p]=f,t[--p]=y,s&&(t[l++]=x,t[l++]=b,t[--p]=f,t[--p]=x)}},triangulate(a,t){const e=a.points,i=t.points,s=t.indices;if(e.length===0)return;let n=i.length/2;const r=n;let o,h;if(a.type!==F.RREC){const l=a.shape;o=l.x,h=l.y}else{const l=a.shape;o=l.x+l.width/2,h=l.y+l.height/2}const c=a.matrix;i.push(a.matrix?c.a*o+c.c*h+c.tx:o,a.matrix?c.b*o+c.d*h+c.ty:h),n++,i.push(e[0],e[1]);for(let l=2;l<e.length;l+=2)i.push(e[l],e[l+1]),s.push(n++,r,n);s.push(r+1,r,n)}};function Qt(a,t=!1){const e=a.length;if(e<6)return;let i=0;for(let s=0,n=a[e-2],r=a[e-1];s<e;s+=2){const o=a[s],h=a[s+1];i+=(o-n)*(h+r),n=o,r=h}if(!t&&i>0||t&&i<=0){const s=e/2;for(let n=s+s%2;n<e;n+=2){const r=e-n-2,o=e-n-1,h=n,c=n+1;[a[r],a[h]]=[a[h],a[r]],[a[o],a[c]]=[a[c],a[o]]}}}const ce={build(a){a.points=a.shape.points.slice()},triangulate(a,t){let e=a.points;const i=a.holes,s=t.points,n=t.indices;if(e.length>=6){Qt(e,!1);const r=[];for(let c=0;c<i.length;c++){const l=i[c];Qt(l.points,!0),r.push(e.length/2),e=e.concat(l.points)}const o=Te(e,r,2);if(!o)return;const h=s.length/2;for(let c=0;c<o.length;c+=3)n.push(o[c]+h),n.push(o[c+1]+h),n.push(o[c+2]+h);for(let c=0;c<e.length;c++)s.push(e[c])}}},Ge={build(a){const t=a.shape,e=t.x,i=t.y,s=t.width,n=t.height,r=a.points;r.length=0,s>=0&&n>=0&&r.push(e,i,e+s,i,e+s,i+n,e,i+n)},triangulate(a,t){const e=a.points,i=t.points;if(e.length===0)return;const s=i.length/2;i.push(e[0],e[1],e[2],e[3],e[6],e[7],e[4],e[5]),t.indices.push(s,s+1,s+2,s+1,s+2,s+3)}},Ye={build(a){pt.build(a)},triangulate(a,t){pt.triangulate(a,t)}};var W=(a=>(a.MITER="miter",a.BEVEL="bevel",a.ROUND="round",a))(W||{}),Y=(a=>(a.BUTT="butt",a.ROUND="round",a.SQUARE="square",a))(Y||{});const it={adaptive:!0,maxLength:10,minSegments:8,maxSegments:2048,epsilon:1e-4,_segmentsCount(a,t=20){if(!this.adaptive||!a||isNaN(a))return t;let e=Math.ceil(a/this.maxLength);return e<this.minSegments?e=this.minSegments:e>this.maxSegments&&(e=this.maxSegments),e}};class Kt{static curveTo(t,e,i,s,n,r){const o=r[r.length-2],h=r[r.length-1]-e,c=o-t,l=s-e,_=i-t,d=Math.abs(h*_-c*l);if(d<1e-8||n===0)return(r[r.length-2]!==t||r[r.length-1]!==e)&&r.push(t,e),null;const p=h*h+c*c,u=l*l+_*_,g=h*l+c*_,y=n*Math.sqrt(p)/d,x=n*Math.sqrt(u)/d,b=y*g/p,f=x*g/u,m=y*_+x*c,D=y*l+x*h,P=c*(x+b),S=h*(x+b),M=_*(y+f),L=l*(y+f),k=Math.atan2(S-D,P-m),A=Math.atan2(L-D,M-m);return{cx:m+t,cy:D+e,radius:n,startAngle:k,endAngle:A,anticlockwise:c*l>_*h}}static arc(t,e,i,s,n,r,o,h,c){const l=o-r,_=it._segmentsCount(Math.abs(l)*n,Math.ceil(Math.abs(l)/Lt)*40),d=l/(_*2),p=d*2,u=Math.cos(d),g=Math.sin(d),y=_-1,x=y%1/y;for(let b=0;b<=y;++b){const f=b+x*b,m=d+r+p*f,D=Math.cos(m),P=-Math.sin(m);c.push((u*D+g*P)*n+i,(u*-P+g*D)*n+s)}}}class Ve{constructor(){this.reset()}begin(t,e,i){this.reset(),this.style=t,this.start=e,this.attribStart=i}end(t,e){this.attribSize=e-this.attribStart,this.size=t-this.start}reset(){this.style=null,this.size=0,this.start=0,this.attribStart=0,this.attribSize=0}}class Rt{static curveLength(t,e,i,s,n,r,o,h){let c=0,l=0,_=0,d=0,p=0,u=0,g=0,y=0,x=0,b=0,f=0,m=t,D=e;for(let P=1;P<=10;++P)l=P/10,_=l*l,d=_*l,p=1-l,u=p*p,g=u*p,y=g*t+3*u*l*i+3*p*_*n+d*o,x=g*e+3*u*l*s+3*p*_*r+d*h,b=m-y,f=D-x,m=y,D=x,c+=Math.sqrt(b*b+f*f);return c}static curveTo(t,e,i,s,n,r,o){const h=o[o.length-2],c=o[o.length-1];o.length-=2;const l=it._segmentsCount(Rt.curveLength(h,c,t,e,i,s,n,r));let _=0,d=0,p=0,u=0,g=0;o.push(h,c);for(let y=1,x=0;y<=l;++y)x=y/l,_=1-x,d=_*_,p=d*_,u=x*x,g=u*x,o.push(p*h+3*d*x*t+3*_*u*i+g*n,p*c+3*d*x*e+3*_*u*s+g*r)}}function Zt(a,t,e,i,s,n,r,o){const h=a-e*s,c=t-i*s,l=a+e*n,_=t+i*n;let d,p;r?(d=i,p=-e):(d=-i,p=e);const u=h+d,g=c+p,y=l+d,x=_+p;return o.push(u,g,y,x),2}function Q(a,t,e,i,s,n,r,o){const h=e-a,c=i-t;let l=Math.atan2(h,c),_=Math.atan2(s-a,n-t);o&&l<_?l+=Math.PI*2:!o&&l>_&&(_+=Math.PI*2);let d=l;const p=_-l,u=Math.abs(p),g=Math.sqrt(h*h+c*c),y=(15*u*Math.sqrt(g)/Math.PI>>0)+1,x=p/y;if(d+=x,o){r.push(a,t,e,i);for(let b=1,f=d;b<y;b++,f+=x)r.push(a,t,a+Math.sin(f)*g,t+Math.cos(f)*g);r.push(a,t,s,n)}else{r.push(e,i,a,t);for(let b=1,f=d;b<y;b++,f+=x)r.push(a+Math.sin(f)*g,t+Math.cos(f)*g,a,t);r.push(s,n,a,t)}return y*2}function Xe(a,t){const e=a.shape;let i=a.points||e.points.slice();const s=t.closePointEps;if(i.length===0)return;const n=a.lineStyle,r=new ut(i[0],i[1]),o=new ut(i[i.length-2],i[i.length-1]),h=e.type!==F.POLY||e.closeStroke,c=Math.abs(r.x-o.x)<s&&Math.abs(r.y-o.y)<s;if(h){i=i.slice(),c&&(i.pop(),i.pop(),o.set(i[i.length-2],i[i.length-1]));const I=(r.x+o.x)*.5,R=(o.y+r.y)*.5;i.unshift(I,R),i.push(I,R)}const l=t.points,_=i.length/2;let d=i.length;const p=l.length/2,u=n.width/2,g=u*u,y=n.miterLimit*n.miterLimit;let x=i[0],b=i[1],f=i[2],m=i[3],D=0,P=0,S=-(b-m),M=x-f,L=0,k=0,A=Math.sqrt(S*S+M*M);S/=A,M/=A,S*=u,M*=u;const O=n.alignment,T=(1-O)*2,C=O*2;h||(n.cap===Y.ROUND?d+=Q(x-S*(T-C)*.5,b-M*(T-C)*.5,x-S*T,b-M*T,x+S*C,b+M*C,l,!0)+2:n.cap===Y.SQUARE&&(d+=Zt(x,b,S,M,T,C,!0,l))),l.push(x-S*T,b-M*T,x+S*C,b+M*C);for(let I=1;I<_-1;++I){x=i[(I-1)*2],b=i[(I-1)*2+1],f=i[I*2],m=i[I*2+1],D=i[(I+1)*2],P=i[(I+1)*2+1],S=-(b-m),M=x-f,A=Math.sqrt(S*S+M*M),S/=A,M/=A,S*=u,M*=u,L=-(m-P),k=f-D,A=Math.sqrt(L*L+k*k),L/=A,k/=A,L*=u,k*=u;const R=f-x,z=b-m,H=f-D,q=P-m,xt=R*H+z*q,G=z*H-q*R,U=G<0;if(Math.abs(G)<.001*Math.abs(xt)){l.push(f-S*T,m-M*T,f+S*C,m+M*C),xt>=0&&(n.join===W.ROUND?d+=Q(f,m,f-S*T,m-M*T,f-L*T,m-k*T,l,!1)+4:d+=2,l.push(f-L*C,m-k*C,f+L*T,m+k*T));continue}const st=(-S+x)*(-M+m)-(-S+f)*(-M+b),K=(-L+D)*(-k+m)-(-L+f)*(-k+P),ht=(R*K-H*st)/G,at=(q*st-z*K)/G,Ft=(ht-f)*(ht-f)+(at-m)*(at-m),V=f+(ht-f)*T,X=m+(at-m)*T,$=f-(ht-f)*C,J=m-(at-m)*C,me=Math.min(R*R+z*z,H*H+q*q),Ot=U?T:C,xe=me+Ot*Ot*g,ye=Ft<=xe;let ot=n.join;if(ot===W.MITER&&Ft/g>y&&(ot=W.BEVEL),ye)switch(ot){case W.MITER:{l.push(V,X,$,J);break}case W.BEVEL:{U?l.push(V,X,f+S*C,m+M*C,V,X,f+L*C,m+k*C):l.push(f-S*T,m-M*T,$,J,f-L*T,m-k*T,$,J),d+=2;break}case W.ROUND:{U?(l.push(V,X,f+S*C,m+M*C),d+=Q(f,m,f+S*C,m+M*C,f+L*C,m+k*C,l,!0)+4,l.push(V,X,f+L*C,m+k*C)):(l.push(f-S*T,m-M*T,$,J),d+=Q(f,m,f-S*T,m-M*T,f-L*T,m-k*T,l,!1)+4,l.push(f-L*T,m-k*T,$,J));break}}else{switch(l.push(f-S*T,m-M*T,f+S*C,m+M*C),ot){case W.MITER:{U?l.push($,J,$,J):l.push(V,X,V,X),d+=2;break}case W.ROUND:{U?d+=Q(f,m,f+S*C,m+M*C,f+L*C,m+k*C,l,!0)+2:d+=Q(f,m,f-S*T,m-M*T,f-L*T,m-k*T,l,!1)+2;break}}l.push(f-L*T,m-k*T,f+L*C,m+k*C),d+=2}}x=i[(_-2)*2],b=i[(_-2)*2+1],f=i[(_-1)*2],m=i[(_-1)*2+1],S=-(b-m),M=x-f,A=Math.sqrt(S*S+M*M),S/=A,M/=A,S*=u,M*=u,l.push(f-S*T,m-M*T,f+S*C,m+M*C),h||(n.cap===Y.ROUND?d+=Q(f-S*(T-C)*.5,m-M*(T-C)*.5,f-S*T,m-M*T,f+S*C,m+M*C,l,!1)+2:n.cap===Y.SQUARE&&(d+=Zt(f,m,S,M,T,C,!1,l)));const B=t.indices,E=it.epsilon*it.epsilon;for(let I=p;I<d+p-2;++I)x=l[I*2],b=l[I*2+1],f=l[(I+1)*2],m=l[(I+1)*2+1],D=l[(I+2)*2],P=l[(I+2)*2+1],!(Math.abs(x*(m-P)+f*(P-b)+D*(b-m))<E)&&B.push(I,I+1,I+2)}function $e(a,t){let e=0;const i=a.shape,s=a.points||i.points,n=i.type!==F.POLY||i.closeStroke;if(s.length===0)return;const r=t.points,o=t.indices,h=s.length/2,c=r.length/2;let l=c;for(r.push(s[0],s[1]),e=1;e<h;e++)r.push(s[e*2],s[e*2+1]),o.push(l,l+1),l++;n&&o.push(l,c)}function te(a,t){a.lineStyle.native?$e(a,t):Xe(a,t)}class Bt{static curveLength(t,e,i,s,n,r){const o=t-2*i+n,h=e-2*s+r,c=2*i-2*t,l=2*s-2*e,_=4*(o*o+h*h),d=4*(o*c+h*l),p=c*c+l*l,u=2*Math.sqrt(_+d+p),g=Math.sqrt(_),y=2*_*g,x=2*Math.sqrt(p),b=d/g;return(y*u+g*d*(u-x)+(4*p*_-d*d)*Math.log((2*g+b+u)/(b+x)))/(4*y)}static curveTo(t,e,i,s,n){const r=n[n.length-2],o=n[n.length-1],h=it._segmentsCount(Bt.curveLength(r,o,t,e,i,s));let c=0,l=0;for(let _=1;_<=h;++_){const d=_/h;c=r+(t-r)*d,l=o+(e-o)*d,n.push(c+(t+(i-t)*d-c)*d,l+(e+(s-e)*d-l)*d)}}}const vt={[F.POLY]:ce,[F.CIRC]:pt,[F.ELIP]:pt,[F.RECT]:Ge,[F.RREC]:Ye},ee=[],_t=[];class gt{constructor(t,e=null,i=null,s=null){this.points=[],this.holes=[],this.shape=t,this.lineStyle=i,this.fillStyle=e,this.matrix=s,this.type=t.type}clone(){return new gt(this.shape,this.fillStyle,this.lineStyle,this.matrix)}destroy(){this.shape=null,this.holes.length=0,this.holes=null,this.points.length=0,this.points=null,this.lineStyle=null,this.fillStyle=null}}const tt=new ut,_e=class de extends Ce{constructor(){super(),this.closePointEps=1e-4,this.boundsPadding=0,this.uvsFloat32=null,this.indicesUint16=null,this.batchable=!1,this.points=[],this.colors=[],this.uvs=[],this.indices=[],this.textureIds=[],this.graphicsData=[],this.drawCalls=[],this.batchDirty=-1,this.batches=[],this.dirty=0,this.cacheDirty=-1,this.clearDirty=0,this.shapeIndex=0,this._bounds=new Me,this.boundsDirty=-1}get bounds(){return this.updateBatches(),this.boundsDirty!==this.dirty&&(this.boundsDirty=this.dirty,this.calculateBounds()),this._bounds}invalidate(){this.boundsDirty=-1,this.dirty++,this.batchDirty++,this.shapeIndex=0,this.points.length=0,this.colors.length=0,this.uvs.length=0,this.indices.length=0,this.textureIds.length=0;for(let t=0;t<this.drawCalls.length;t++)this.drawCalls[t].texArray.clear(),_t.push(this.drawCalls[t]);this.drawCalls.length=0;for(let t=0;t<this.batches.length;t++){const e=this.batches[t];e.reset(),ee.push(e)}this.batches.length=0}clear(){return this.graphicsData.length>0&&(this.invalidate(),this.clearDirty++,this.graphicsData.length=0),this}drawShape(t,e=null,i=null,s=null){const n=new gt(t,e,i,s);return this.graphicsData.push(n),this.dirty++,this}drawHole(t,e=null){if(!this.graphicsData.length)return null;const i=new gt(t,null,null,e),s=this.graphicsData[this.graphicsData.length-1];return i.lineStyle=s.lineStyle,s.holes.push(i),this.dirty++,this}destroy(){super.destroy();for(let t=0;t<this.graphicsData.length;++t)this.graphicsData[t].destroy();this.points.length=0,this.points=null,this.colors.length=0,this.colors=null,this.uvs.length=0,this.uvs=null,this.indices.length=0,this.indices=null,this.indexBuffer.destroy(),this.indexBuffer=null,this.graphicsData.length=0,this.graphicsData=null,this.drawCalls.length=0,this.drawCalls=null,this.batches.length=0,this.batches=null,this._bounds=null}containsPoint(t){const e=this.graphicsData;for(let i=0;i<e.length;++i){const s=e[i];if(s.fillStyle.visible&&s.shape&&(s.matrix?s.matrix.applyInverse(t,tt):tt.copyFrom(t),s.shape.contains(tt.x,tt.y))){let n=!1;if(s.holes){for(let r=0;r<s.holes.length;r++)if(s.holes[r].shape.contains(tt.x,tt.y)){n=!0;break}}if(!n)return!0}}return!1}updateBatches(){if(!this.graphicsData.length){this.batchable=!0;return}if(!this.validateBatching())return;this.cacheDirty=this.dirty;const t=this.uvs,e=this.graphicsData;let i=null,s=null;this.batches.length>0&&(i=this.batches[this.batches.length-1],s=i.style);for(let h=this.shapeIndex;h<e.length;h++){this.shapeIndex++;const c=e[h],l=c.fillStyle,_=c.lineStyle;vt[c.type].build(c),c.matrix&&this.transformPoints(c.points,c.matrix),(l.visible||_.visible)&&this.processHoles(c.holes);for(let d=0;d<2;d++){const p=d===0?l:_;if(!p.visible)continue;const u=p.texture.baseTexture,g=this.indices.length,y=this.points.length/2;u.wrapMode=Ut.REPEAT,d===0?this.processFill(c):this.processLine(c);const x=this.points.length/2-y;x!==0&&(i&&!this._compareStyles(s,p)&&(i.end(g,y),i=null),i||(i=ee.pop()||new Ve,i.begin(p,g,y),this.batches.push(i),s=p),this.addUvs(this.points,t,p.texture,y,x,p.matrix))}}const n=this.indices.length,r=this.points.length/2;if(i&&i.end(n,r),this.batches.length===0){this.batchable=!0;return}const o=r>65535;this.indicesUint16&&this.indices.length===this.indicesUint16.length&&o===this.indicesUint16.BYTES_PER_ELEMENT>2?this.indicesUint16.set(this.indices):this.indicesUint16=o?new Uint32Array(this.indices):new Uint16Array(this.indices),this.batchable=this.isBatchable(),this.batchable?this.packBatches():this.buildDrawCalls()}_compareStyles(t,e){return!(!t||!e||t.texture.baseTexture!==e.texture.baseTexture||t.color+t.alpha!==e.color+e.alpha||!!t.native!=!!e.native)}validateBatching(){if(this.dirty===this.cacheDirty||!this.graphicsData.length)return!1;for(let t=0,e=this.graphicsData.length;t<e;t++){const i=this.graphicsData[t],s=i.fillStyle,n=i.lineStyle;if(s&&!s.texture.baseTexture.valid||n&&!n.texture.baseTexture.valid)return!1}return!0}packBatches(){this.batchDirty++,this.uvsFloat32=new Float32Array(this.uvs);const t=this.batches;for(let e=0,i=t.length;e<i;e++){const s=t[e];for(let n=0;n<s.size;n++){const r=s.start+n;this.indicesUint16[r]=this.indicesUint16[r]-s.attribStart}}}isBatchable(){if(this.points.length>65535*2)return!1;const t=this.batches;for(let e=0;e<t.length;e++)if(t[e].style.native)return!1;return this.points.length<de.BATCHABLE_SIZE*2}buildDrawCalls(){let t=++jt._globalBatch;for(let _=0;_<this.drawCalls.length;_++)this.drawCalls[_].texArray.clear(),_t.push(this.drawCalls[_]);this.drawCalls.length=0;const e=this.colors,i=this.textureIds;let s=_t.pop();s||(s=new qt,s.texArray=new Gt),s.texArray.count=0,s.start=0,s.size=0,s.type=lt.TRIANGLES;let n=0,r=null,o=0,h=!1,c=lt.TRIANGLES,l=0;this.drawCalls.push(s);for(let _=0;_<this.batches.length;_++){const d=this.batches[_],p=8,u=d.style,g=u.texture.baseTexture;h!==!!u.native&&(h=!!u.native,c=h?lt.LINES:lt.TRIANGLES,r=null,n=p,t++),r!==g&&(r=g,g._batchEnabled!==t&&(n===p&&(t++,n=0,s.size>0&&(s=_t.pop(),s||(s=new qt,s.texArray=new Gt),this.drawCalls.push(s)),s.start=l,s.size=0,s.texArray.count=0,s.type=c),g.touched=1,g._batchEnabled=t,g._batchLocation=n,g.wrapMode=Ut.REPEAT,s.texArray.elements[s.texArray.count++]=g,n++)),s.size+=d.size,l+=d.size,o=g._batchLocation,this.addColors(e,u.color,u.alpha,d.attribSize,d.attribStart),this.addTextureIds(i,o,d.attribSize,d.attribStart)}jt._globalBatch=t,this.packAttributes()}packAttributes(){const t=this.points,e=this.uvs,i=this.colors,s=this.textureIds,n=new ArrayBuffer(t.length*3*4),r=new Float32Array(n),o=new Uint32Array(n);let h=0;for(let c=0;c<t.length/2;c++)r[h++]=t[c*2],r[h++]=t[c*2+1],r[h++]=e[c*2],r[h++]=e[c*2+1],o[h++]=i[c],r[h++]=s[c];this._buffer.update(n),this._indexBuffer.update(this.indicesUint16)}processFill(t){t.holes.length?ce.triangulate(t,this):vt[t.type].triangulate(t,this)}processLine(t){te(t,this);for(let e=0;e<t.holes.length;e++)te(t.holes[e],this)}processHoles(t){for(let e=0;e<t.length;e++){const i=t[e];vt[i.type].build(i),i.matrix&&this.transformPoints(i.points,i.matrix)}}calculateBounds(){const t=this._bounds;t.clear(),t.addVertexData(this.points,0,this.points.length),t.pad(this.boundsPadding,this.boundsPadding)}transformPoints(t,e){for(let i=0;i<t.length/2;i++){const s=t[i*2],n=t[i*2+1];t[i*2]=e.a*s+e.c*n+e.tx,t[i*2+1]=e.b*s+e.d*n+e.ty}}addColors(t,e,i,s,n=0){const r=j.shared.setValue(e).toLittleEndianNumber(),o=j.shared.setValue(r).toPremultiplied(i);t.length=Math.max(t.length,n+s);for(let h=0;h<s;h++)t[n+h]=o}addTextureIds(t,e,i,s=0){t.length=Math.max(t.length,s+i);for(let n=0;n<i;n++)t[s+n]=e}addUvs(t,e,i,s,n,r=null){let o=0;const h=e.length,c=i.frame;for(;o<n;){let _=t[(s+o)*2],d=t[(s+o)*2+1];if(r){const p=r.a*_+r.c*d+r.tx;d=r.b*_+r.d*d+r.ty,_=p}o++,e.push(_/c.width,d/c.height)}const l=i.baseTexture;(c.width<l.width||c.height<l.height)&&this.adjustUvs(e,i,h,n)}adjustUvs(t,e,i,s){const n=e.baseTexture,r=1e-6,o=i+s*2,h=e.frame,c=h.width/n.width,l=h.height/n.height;let _=h.x/h.width,d=h.y/h.height,p=Math.floor(t[i]+r),u=Math.floor(t[i+1]+r);for(let g=i+2;g<o;g+=2)p=Math.min(p,Math.floor(t[g]+r)),u=Math.min(u,Math.floor(t[g+1]+r));_-=p,d-=u;for(let g=i;g<o;g+=2)t[g]=(t[g]+_)*c,t[g+1]=(t[g+1]+d)*l}};_e.BATCHABLE_SIZE=100;let Je=_e;class mt{constructor(){this.color=16777215,this.alpha=1,this.texture=et.WHITE,this.matrix=null,this.visible=!1,this.reset()}clone(){const t=new mt;return t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.matrix=this.matrix,t.visible=this.visible,t}reset(){this.color=16777215,this.alpha=1,this.texture=et.WHITE,this.matrix=null,this.visible=!1}destroy(){this.texture=null,this.matrix=null}}class Wt extends mt{constructor(){super(...arguments),this.width=0,this.alignment=.5,this.native=!1,this.cap=Y.BUTT,this.join=W.MITER,this.miterLimit=10}clone(){const t=new Wt;return t.color=this.color,t.alpha=this.alpha,t.texture=this.texture,t.matrix=this.matrix,t.visible=this.visible,t.width=this.width,t.alignment=this.alignment,t.native=this.native,t.cap=this.cap,t.join=this.join,t.miterLimit=this.miterLimit,t}reset(){super.reset(),this.color=0,this.alignment=.5,this.width=0,this.native=!1,this.cap=Y.BUTT,this.join=W.MITER,this.miterLimit=10}}const St={},It=class dt extends At{constructor(t=null){super(),this.shader=null,this.pluginName="batch",this.currentPath=null,this.batches=[],this.batchTint=-1,this.batchDirty=-1,this.vertexData=null,this._fillStyle=new mt,this._lineStyle=new Wt,this._matrix=null,this._holeMode=!1,this.state=De.for2d(),this._geometry=t||new Je,this._geometry.refCount++,this._transformID=-1,this._tintColor=new j(16777215),this.blendMode=Le.NORMAL}get geometry(){return this._geometry}clone(){return this.finishPoly(),new dt(this._geometry)}set blendMode(t){this.state.blendMode=t}get blendMode(){return this.state.blendMode}get tint(){return this._tintColor.value}set tint(t){this._tintColor.setValue(t)}get fill(){return this._fillStyle}get line(){return this._lineStyle}lineStyle(t=null,e=0,i,s=.5,n=!1){return typeof t=="number"&&(t={width:t,color:e,alpha:i,alignment:s,native:n}),this.lineTextureStyle(t)}lineTextureStyle(t){const e={width:0,texture:et.WHITE,color:t!=null&&t.texture?16777215:0,matrix:null,alignment:.5,native:!1,cap:Y.BUTT,join:W.MITER,miterLimit:10};t=Object.assign(e,t),this.normalizeColor(t),this.currentPath&&this.startPoly();const i=t.width>0&&t.alpha>0;return i?(t.matrix&&(t.matrix=t.matrix.clone(),t.matrix.invert()),Object.assign(this._lineStyle,{visible:i},t)):this._lineStyle.reset(),this}startPoly(){if(this.currentPath){const t=this.currentPath.points,e=this.currentPath.points.length;e>2&&(this.drawShape(this.currentPath),this.currentPath=new yt,this.currentPath.closeStroke=!1,this.currentPath.points.push(t[e-2],t[e-1]))}else this.currentPath=new yt,this.currentPath.closeStroke=!1}finishPoly(){this.currentPath&&(this.currentPath.points.length>2?(this.drawShape(this.currentPath),this.currentPath=null):this.currentPath.points.length=0)}moveTo(t,e){return this.startPoly(),this.currentPath.points[0]=t,this.currentPath.points[1]=e,this}lineTo(t,e){this.currentPath||this.moveTo(0,0);const i=this.currentPath.points,s=i[i.length-2],n=i[i.length-1];return(s!==t||n!==e)&&i.push(t,e),this}_initCurve(t=0,e=0){this.currentPath?this.currentPath.points.length===0&&(this.currentPath.points=[t,e]):this.moveTo(t,e)}quadraticCurveTo(t,e,i,s){this._initCurve();const n=this.currentPath.points;return n.length===0&&this.moveTo(0,0),Bt.curveTo(t,e,i,s,n),this}bezierCurveTo(t,e,i,s,n,r){return this._initCurve(),Rt.curveTo(t,e,i,s,n,r,this.currentPath.points),this}arcTo(t,e,i,s,n){this._initCurve(t,e);const r=this.currentPath.points,o=Kt.curveTo(t,e,i,s,n,r);if(o){const{cx:h,cy:c,radius:l,startAngle:_,endAngle:d,anticlockwise:p}=o;this.arc(h,c,l,_,d,p)}return this}arc(t,e,i,s,n,r=!1){if(s===n)return this;if(!r&&n<=s?n+=Lt:r&&s<=n&&(s+=Lt),n-s===0)return this;const o=t+Math.cos(s)*i,h=e+Math.sin(s)*i,c=this._geometry.closePointEps;let l=this.currentPath?this.currentPath.points:null;if(l){const _=Math.abs(l[l.length-2]-o),d=Math.abs(l[l.length-1]-h);_<c&&d<c||l.push(o,h)}else this.moveTo(o,h),l=this.currentPath.points;return Kt.arc(o,h,t,e,i,s,n,r,l),this}beginFill(t=0,e){return this.beginTextureFill({texture:et.WHITE,color:t,alpha:e})}normalizeColor(t){const e=j.shared.setValue(t.color??0);t.color=e.toNumber(),t.alpha??(t.alpha=e.alpha)}beginTextureFill(t){const e={texture:et.WHITE,color:16777215,matrix:null};t=Object.assign(e,t),this.normalizeColor(t),this.currentPath&&this.startPoly();const i=t.alpha>0;return i?(t.matrix&&(t.matrix=t.matrix.clone(),t.matrix.invert()),Object.assign(this._fillStyle,{visible:i},t)):this._fillStyle.reset(),this}endFill(){return this.finishPoly(),this._fillStyle.reset(),this}drawRect(t,e,i,s){return this.drawShape(new Dt(t,e,i,s))}drawRoundedRect(t,e,i,s,n){return this.drawShape(new Pe(t,e,i,s,n))}drawCircle(t,e,i){return this.drawShape(new Ie(t,e,i))}drawEllipse(t,e,i,s){return this.drawShape(new ke(t,e,i,s))}drawPolygon(...t){let e,i=!0;const s=t[0];s.points?(i=s.closeStroke,e=s.points):Array.isArray(t[0])?e=t[0]:e=t;const n=new yt(e);return n.closeStroke=i,this.drawShape(n),this}drawShape(t){return this._holeMode?this._geometry.drawHole(t,this._matrix):this._geometry.drawShape(t,this._fillStyle.clone(),this._lineStyle.clone(),this._matrix),this}clear(){return this._geometry.clear(),this._lineStyle.reset(),this._fillStyle.reset(),this._boundsID++,this._matrix=null,this._holeMode=!1,this.currentPath=null,this}isFastRect(){const t=this._geometry.graphicsData;return t.length===1&&t[0].shape.type===F.RECT&&!t[0].matrix&&!t[0].holes.length&&!(t[0].lineStyle.visible&&t[0].lineStyle.width)}_render(t){this.finishPoly();const e=this._geometry;e.updateBatches(),e.batchable?(this.batchDirty!==e.batchDirty&&this._populateBatches(),this._renderBatched(t)):(t.batch.flush(),this._renderDirect(t))}_populateBatches(){const t=this._geometry,e=this.blendMode,i=t.batches.length;this.batchTint=-1,this._transformID=-1,this.batchDirty=t.batchDirty,this.batches.length=i,this.vertexData=new Float32Array(t.points);for(let s=0;s<i;s++){const n=t.batches[s],r=n.style.color,o=new Float32Array(this.vertexData.buffer,n.attribStart*4*2,n.attribSize*2),h=new Float32Array(t.uvsFloat32.buffer,n.attribStart*4*2,n.attribSize*2),c=new Uint16Array(t.indicesUint16.buffer,n.start*2,n.size),l={vertexData:o,blendMode:e,indices:c,uvs:h,_batchRGB:j.shared.setValue(r).toRgbArray(),_tintRGB:r,_texture:n.style.texture,alpha:n.style.alpha,worldAlpha:1};this.batches[s]=l}}_renderBatched(t){if(this.batches.length){t.batch.setObjectRenderer(t.plugins[this.pluginName]),this.calculateVertices(),this.calculateTints();for(let e=0,i=this.batches.length;e<i;e++){const s=this.batches[e];s.worldAlpha=this.worldAlpha*s.alpha,t.plugins[this.pluginName].render(s)}}}_renderDirect(t){const e=this._resolveDirectShader(t),i=this._geometry,s=this.worldAlpha,n=e.uniforms,r=i.drawCalls;n.translationMatrix=this.transform.worldTransform,j.shared.setValue(this._tintColor).premultiply(s).toArray(n.tint),t.shader.bind(e),t.geometry.bind(i,e),t.state.set(this.state);for(let o=0,h=r.length;o<h;o++)this._renderDrawCallDirect(t,i.drawCalls[o])}_renderDrawCallDirect(t,e){const{texArray:i,type:s,size:n,start:r}=e,o=i.count;for(let h=0;h<o;h++)t.texture.bind(i.elements[h],h);t.geometry.draw(s,n,r)}_resolveDirectShader(t){let e=this.shader;const i=this.pluginName;if(!e){if(!St[i]){const{maxTextures:s}=t.plugins[i],n=new Int32Array(s);for(let h=0;h<s;h++)n[h]=h;const r={tint:new Float32Array([1,1,1,1]),translationMatrix:new Ae,default:Ee.from({uSamplers:n},!0)},o=t.plugins[i]._shader.program;St[i]=new Re(o,r)}e=St[i]}return e}_calculateBounds(){this.finishPoly();const t=this._geometry;if(!t.graphicsData.length)return;const{minX:e,minY:i,maxX:s,maxY:n}=t.bounds;this._bounds.addFrame(this.transform,e,i,s,n)}containsPoint(t){return this.worldTransform.applyInverse(t,dt._TEMP_POINT),this._geometry.containsPoint(dt._TEMP_POINT)}calculateTints(){if(this.batchTint!==this.tint){this.batchTint=this._tintColor.toNumber();for(let t=0;t<this.batches.length;t++){const e=this.batches[t];e._tintRGB=j.shared.setValue(this._tintColor).multiply(e._batchRGB).toLittleEndianNumber()}}}calculateVertices(){const t=this.transform._worldID;if(this._transformID===t)return;this._transformID=t;const e=this.transform.worldTransform,i=e.a,s=e.b,n=e.c,r=e.d,o=e.tx,h=e.ty,c=this._geometry.points,l=this.vertexData;let _=0;for(let d=0;d<c.length;d+=2){const p=c[d],u=c[d+1];l[_++]=i*p+n*u+o,l[_++]=r*u+s*p+h}}closePath(){const t=this.currentPath;return t&&(t.closeStroke=!0,this.finishPoly()),this}setMatrix(t){return this._matrix=t,this}beginHole(){return this.finishPoly(),this._holeMode=!0,this}endHole(){return this.finishPoly(),this._holeMode=!1,this}destroy(t){this._geometry.refCount--,this._geometry.refCount===0&&this._geometry.dispose(),this._matrix=null,this.currentPath=null,this._lineStyle.destroy(),this._lineStyle=null,this._fillStyle.destroy(),this._fillStyle=null,this._geometry=null,this.shader=null,this.vertexData=null,this.batches.length=0,this.batches=null,super.destroy(t)}};It.curves=it,It._TEMP_POINT=new ut;let kt=It;const Ht=[.611,1,.7],Qe=he(...Ht),Ke=ae(...Ht),ie=3,Ze=1,vi=1;class ti{constructor(t,e=new At){v(this,"speed",0);v(this,"strength",Ze);v(this,"directionX",0);v(this,"directionY",0);v(this,"_radius",0);v(this,"_invisible",!1);v(this,"dead",!1);v(this,"ghostly",!1);v(this,"disableSimulation",!1);v(this,"_color",Ht);v(this,"colorStr",Qe);v(this,"colorHex",Ke);v(this,"text",null);v(this,"textOffsetX",0);v(this,"textOffsetY",0);v(this,"_fontFamily","Arial");v(this,"_fontSize",26);v(this,"_font","26px Arial");v(this,"_x");v(this,"_y");v(this,"graphics");v(this,"drawn",!1);this.body=t,this.container=e,t.entity=this,this.x=t.x,this.y=t.y,t._circle&&(this.radius=t.radius)}get radius(){return this._radius}set radius(t){this._radius=t,this.body._circle&&(this.body.radius=t)}get invisible(){return this._invisible}set invisible(t){this._invisible=t,this.container.visible=!t}get color(){return this._color}set color(t){const{_color:e}=this;if(t===e)return;const[i,s,n]=t,[r,o,h]=e;if(i===r&&s===o&&n===h)return;this._color=t,this.colorStr=he(i,s,n);const c=this.colorHex=ae(i,s,n);this.graphics&&(this.graphics.tint=c)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this._font=`${t}px ${this._fontFamily}`}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this._font=`${this._fontSize}px ${t}`}get font(){return this._font}get x(){return this._x}set x(t){this._x=t,this.body.x=t,this.container.x=t}get y(){return this._y}set y(t){this._y=t,this.body.y=t,this.container.y=t}draw(){if(this.drawn)throw Error("TODO allow drawing an entity more than once");this.drawn=!0;const{body:t}=this;if(t._circle){const e=this.graphics=new kt;this.container.addChild(e),e.lineStyle(ie,16777215),e.beginFill(0,0),e.drawCircle(0,0,this.radius),e.endFill(),e.tint=this.colorHex}else if(t._polygon){const e=this.graphics=new kt;this.container.addChild(e),e.lineStyle(ie,16777215),e.beginFill(0,0),e.rotation=t.angle,e.drawPolygon(Array.from(t._points)),e.endFill(),e.tint=this.colorHex}if(this.text){const e=new qe(this.text,{fontSize:this.fontSize,fontFamily:this.fontFamily});(this.textOffsetX||this.textOffsetY)&&e.position.set(this.textOffsetX,this.textOffsetY),this.container.addChild(e),e.anchor.set(.5,.5)}}destroy(){this.dead=!0,this.container.destroy({children:!0,texture:!0,baseTexture:!0})}}const ei=(...a)=>{let t=0,e=0,i=0,s=1;const n=a.length?a:[Date.now()];let r=ii();t=r(" "),e=r(" "),i=r(" ");for(const h of n)t-=r(h),t<0&&(t+=1),e-=r(h),e<0&&(e+=1),i-=r(h),i<0&&(i+=1);r=null;const o=()=>{const h=2091639*t+s*23283064365386963e-26;return t=e,e=i,i=h-(s=h|0)};return o.uint32=()=>o()*4294967296,o.fract53=()=>o()+(o()*2097152|0)*11102230246251565e-32,o.version="Alea 0.9",o.seeds=n,o},ii=()=>{let a=4022871197;return t=>{const e=t+"";for(let i=0;i<e.length;i++){a+=e.charCodeAt(i);let s=.02519603282416938*a;a=s>>>0,s-=a,s*=a,a=s>>>0,s-=a,a+=s*4294967296}return(a>>>0)*23283064365386963e-26}};function ue(a,t,e=null,i=!0){const s=a._polygon,n=t._polygon;let r=!1;return e&&(e.a=a,e.b=t,e.a_in_b=!0,e.b_in_a=!0,e.overlap=null,e.overlap_x=0,e.overlap_y=0),s&&(a._dirty_coords||a.x!==a._x||a.y!==a._y||a.angle!==a._angle||a.scale_x!==a._scale_x||a.scale_y!==a._scale_y)&&a._calculateCoords(),n&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords(),(!i||si(a,t))&&(s&&a._dirty_normals&&a._calculateNormals(),n&&t._dirty_normals&&t._calculateNormals(),r=s&&n?ni(a,t,e):s?se(a,t,e,!1):n?se(t,a,e,!0):ri(a,t,e)),e&&(e.collision=r),r}const si=(a,t)=>{const e=a._polygon,i=e?0:a.x,s=e?0:a.y,n=e?0:a.radius*a.scale,r=e?a._min_x:i-n,o=e?a._min_y:s-n,h=e?a._max_x:i+n,c=e?a._max_y:s+n,l=t._polygon,_=l?0:t.x,d=l?0:t.y,p=l?0:t.radius*t.scale,u=l?t._min_x:_-p,g=l?t._min_y:d-p,y=l?t._max_x:_+p,x=l?t._max_y:d+p;return r<y&&o<x&&h>u&&c>g},ni=(a,t,e=null)=>{const i=a._coords.length,s=t._coords.length;if(i===2&&s===2){const c=a._coords,l=t._coords;return e&&(e.overlap=0),c[0]===l[0]&&c[1]===l[1]}const n=a._coords,r=t._coords,o=a._normals,h=t._normals;if(i>2){for(let c=0,l=1;c<i;c+=2,l+=2)if(ne(n,r,o[c],o[l],e))return!1}if(s>2){for(let c=0,l=1;c<s;c+=2,l+=2)if(ne(n,r,h[c],h[l],e))return!1}return!0},se=(a,t,e=null,i=!1)=>{const s=a._coords,n=a._edges,r=a._normals,o=t.x,h=t.y,c=t.radius*t.scale,l=c*2,_=c*c,d=s.length;let p=!0,u=!0,g=null,y=0,x=0;if(d===2){const b=o-s[0],f=h-s[1],m=b*b+f*f;if(m>_)return!1;if(e){const D=Math.sqrt(m);g=c-D,y=b/D,x=f/D,u=!1}}else for(let b=0,f=1;b<d;b+=2,f+=2){const m=o-s[b],D=h-s[f],P=n[b],S=n[f],M=m*P+D*S,L=M<0?-1:M>P*P+S*S?1:0;let k=!1,A=0,O=0,T=0;if(e&&p&&m*m+D*D>_&&(p=!1),L){const C=L===-1,B=C?b===0?d-2:b-2:b===d-2?0:b+2,E=B+1,I=o-s[B],R=h-s[E],z=n[B],H=n[E],q=I*z+R*H;if((q<0?-1:q>z*z+H*H?1:0)===-L){const G=C?m:I,U=C?D:R,st=G*G+U*U;if(st>_)return!1;if(e){const K=Math.sqrt(st);k=!0,A=c-K,O=G/K,T=U/K,u=!1}}}else{const C=r[b],B=r[f],E=m*C+D*B,I=E<0?-E:E;if(E>0&&I>c)return!1;e&&(k=!0,A=c-E,O=C,T=B,(u&&E>=0||A<l)&&(u=!1))}k&&(g===null||g>A)&&(g=A,y=O,x=T)}return e&&(e.a_in_b=i?u:p,e.b_in_a=i?p:u,e.overlap=g,e.overlap_x=i?-y:y,e.overlap_y=i?-x:x),!0},ri=(a,t,e=null)=>{const i=a.radius*a.scale,s=t.radius*t.scale,n=t.x-a.x,r=t.y-a.y,o=i+s,h=n*n+r*r;if(h>o*o)return!1;if(e){const c=Math.sqrt(h);e.a_in_b=i<=s&&c<=s-i,e.b_in_a=s<=i&&c<=i-s,e.overlap=o-c,e.overlap_x=n/c,e.overlap_y=r/c}return!0},ne=(a,t,e,i,s=null)=>{const n=a.length,r=t.length;if(!n||!r)return!0;let o=null,h=null,c=null,l=null;for(let _=0,d=1;_<n;_+=2,d+=2){const p=a[_]*e+a[d]*i;(o===null||o>p)&&(o=p),(h===null||h<p)&&(h=p)}for(let _=0,d=1;_<r;_+=2,d+=2){const p=t[_]*e+t[d]*i;(c===null||c>p)&&(c=p),(l===null||l<p)&&(l=p)}if(o>l||h<c)return!0;if(s){let _=0;if(o<c)if(s.a_in_b=!1,h<l)_=h-c,s.b_in_a=!1;else{const u=h-c,g=l-o;_=u<g?u:-g}else if(s.b_in_a=!1,h>l)_=o-l,s.a_in_b=!1;else{const u=h-c,g=l-o;_=u<g?u:-g}const d=s.overlap,p=_<0?-_:_;if(d===null||d>p){const u=_<0?-1:1;s.overlap=p,s.overlap_x=e*u,s.overlap_y=i*u}}return!1};class pe{constructor(t=0,e=0,i=0){this._circle=!1,this._polygon=!1,this._point=!1,this._bvh_branch=!1,this._bvh=null,this._bvh_parent=null,this._bvh_min_x=0,this._bvh_min_y=0,this._bvh_max_x=0,this._bvh_max_y=0,this.x=t,this.y=e,this.padding=i,this._bvh_padding=i}collides(t,e=null,i=!0){return ue(this,t,e,i)}potentials(t,e){const i=this._bvh;if(i===null)throw new Error("Body does not belong to a collision system");return i.potentials(this,t,e)}remove(){const t=this._bvh;t&&t.remove(this,!1)}}const Tt=[];class ft{constructor(){this._bvh_branch=!0,this._bvh_parent=null,this._bvh_left=null,this._bvh_right=null,this._bvh_sort=0,this._bvh_min_x=0,this._bvh_min_y=0,this._bvh_max_x=0,this._bvh_max_y=0}static getBranch(){return Tt.length?Tt.pop():new ft}static releaseBranch(t){Tt.push(t)}static sortBranches(t,e){return t._bvh_sort>e._bvh_sort?-1:1}}class hi{constructor(){this._hierarchy=null,this._bodies=[],this._dirty_branches=[]}insert(t,e=!1){if(!e){const u=t._bvh;if(u&&u!==this)throw new Error("Body belongs to another collision system");t._bvh=this,this._bodies.push(t)}const i=t._polygon,s=t.x,n=t.y;i&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords();const r=t._bvh_padding,o=i?0:t.radius*t.scale,h=(i?t._min_x:s-o)-r,c=(i?t._min_y:n-o)-r,l=(i?t._max_x:s+o)+r,_=(i?t._max_y:n+o)+r;t._bvh_min_x=h,t._bvh_min_y=c,t._bvh_max_x=l,t._bvh_max_y=_;let d=this._hierarchy,p=0;if(!d)this._hierarchy=t;else for(;;)if(d._bvh_branch){const u=d._bvh_left,g=u._bvh_min_y,y=u._bvh_max_x,x=u._bvh_max_y,b=h<u._bvh_min_x?h:u._bvh_min_x,f=c<g?c:g,m=l>y?l:y,D=_>x?_:x,P=(y-u._bvh_min_x)*(x-g),M=(m-b)*(D-f)-P,L=d._bvh_right,k=L._bvh_min_x,A=L._bvh_min_y,O=L._bvh_max_x,T=L._bvh_max_y,C=h<k?h:k,B=c<A?c:A,E=l>O?l:O,I=_>T?_:T,R=(O-k)*(T-A),H=(E-C)*(I-B)-R;d._bvh_sort=p++,d._bvh_min_x=b<C?b:C,d._bvh_min_y=f<B?f:B,d._bvh_max_x=m>E?m:E,d._bvh_max_y=D>I?D:I,d=M<=H?u:L}else{const u=d._bvh_parent,g=d._bvh_min_x,y=d._bvh_min_y,x=d._bvh_max_x,b=d._bvh_max_y,f=d._bvh_parent=t._bvh_parent=ft.getBranch();f._bvh_parent=u,f._bvh_left=d,f._bvh_right=t,f._bvh_sort=p++,f._bvh_min_x=h<g?h:g,f._bvh_min_y=c<y?c:y,f._bvh_max_x=l>x?l:x,f._bvh_max_y=_>b?_:b,u?u._bvh_left===d?u._bvh_left=f:u._bvh_right=f:this._hierarchy=f;break}}remove(t,e=!1){if(!e){const o=t._bvh;if(o&&o!==this)throw new Error("Body belongs to another collision system");t._bvh=null,this._bodies.splice(this._bodies.indexOf(t),1)}if(this._hierarchy===t){this._hierarchy=null;return}const i=t._bvh_parent,s=i._bvh_parent,n=i._bvh_left,r=n===t?i._bvh_right:n;if(r._bvh_parent=s,r._bvh_branch&&(r._bvh_sort=i._bvh_sort),s){s._bvh_left===i?s._bvh_left=r:s._bvh_right=r;let o=s;for(;o;){const h=o._bvh_left,c=h._bvh_min_x,l=h._bvh_min_y,_=h._bvh_max_x,d=h._bvh_max_y,p=o._bvh_right,u=p._bvh_min_x,g=p._bvh_min_y,y=p._bvh_max_x,x=p._bvh_max_y;o._bvh_min_x=c<u?c:u,o._bvh_min_y=l<g?l:g,o._bvh_max_x=_>y?_:y,o._bvh_max_y=d>x?d:x,o=o._bvh_parent}}else this._hierarchy=r;ft.releaseBranch(i)}update(){const t=this._bodies,e=t.length;for(let i=0;i<e;++i){let s=t[i],n=!1;if(!n&&s.padding!==s._bvh_padding&&(s._bvh_padding=s.padding,n=!0),!n){const r=s._polygon;r&&(s=s,(s._dirty_coords||s.x!==s._x||s.y!==s._y||s.angle!==s._angle||s.scale_x!==s._scale_x||s.scale_y!==s._scale_y)&&s._calculateCoords());const o=s.x,h=s.y,c=r?0:s.radius*s.scale,l=r?s._min_x:o-c,_=r?s._min_y:h-c,d=r?s._max_x:o+c,p=r?s._max_y:h+c;n=l<s._bvh_min_x||_<s._bvh_min_y||d>s._bvh_max_x||p>s._bvh_max_y}n&&(this.remove(s,!0),this.insert(s,!0))}}potentials(t,e,i=[]){const s=t._bvh_min_x,n=t._bvh_min_y,r=t._bvh_max_x,o=t._bvh_max_y;let h=this._hierarchy,c=!0;if(!h||!h._bvh_branch)return i;for(;h;){if(c){c=!1;let _=h._bvh_branch?h._bvh_left:null;for(;_&&_._bvh_max_x>=s&&_._bvh_max_y>=n&&_._bvh_min_x<=r&&_._bvh_min_y<=o;)h=_,_=h._bvh_branch?h._bvh_left:null}const l=h._bvh_branch?h._bvh_right:null;if(l&&l._bvh_max_x>s&&l._bvh_max_y>n&&l._bvh_min_x<r&&l._bvh_min_y<o)h=l,c=!0;else{!h._bvh_branch&&h!==t&&(!e||e(t,h))&&i.push(h);let _=h._bvh_parent;if(_){for(;_&&_._bvh_right===h;)h=_,_=h._bvh_parent;h=_}else break}}return i}}class ai extends pe{constructor(t=0,e=0,i=0,s=1,n=0){super(t,e,n),this._polygon=!1,this._circle=!0,this._point=!1,this.radius=i,this.scale=s}}class ge extends pe{constructor(t=0,e=0,i=[],s=0,n=1,r=1,o=0){super(t,e,o),this._polygon=!0,this._circle=!1,this._point=!1,this._min_x=0,this._min_y=0,this._max_x=0,this._max_y=0,this._points=null,this._coords=null,this._edges=null,this._normals=null,this._dirty_coords=!0,this._dirty_normals=!0,this.angle=s,this.scale_x=n,this.scale_y=r,this._x=t,this._y=e,this._angle=s,this._scale_x=n,this._scale_y=r,this.setPoints(i)}setPoints(t){const e=t.length;this._points=new Float64Array(e*2),this._coords=new Float64Array(e*2),this._edges=new Float64Array(e*2),this._normals=new Float64Array(e*2);const i=this._points;for(let s=0,n=0,r=1;s<e;++s,n+=2,r+=2){const o=t[s];i[n]=o[0],i[r]=o[1]}this._dirty_coords=!0}_calculateCoords(){const{x:t,y:e,angle:i,scale_x:s,scale_y:n,_points:r,_coords:o}=this,h=r.length;let c=0,l=0,_=0,d=0;for(let p=0,u=1;p<h;p+=2,u+=2){let g=r[p]*s,y=r[u]*n;if(i){const x=Math.cos(i),b=Math.sin(i),f=g,m=y;g=f*x-m*b,y=f*b+m*x}g+=t,y+=e,o[p]=g,o[u]=y,p===0?(c=l=g,_=d=y):(g<c?c=g:g>l&&(l=g),y<_?_=y:y>d&&(d=y))}this._x=t,this._y=e,this._angle=i,this._scale_x=s,this._scale_y=n,this._min_x=c,this._min_y=_,this._max_x=l,this._max_y=d,this._dirty_coords=!1,this._dirty_normals=!0}_calculateNormals(){const{_coords:t,_edges:e,_normals:i}=this,s=t.length;for(let n=0,r=1;n<s;n+=2,r+=2){const o=n+2<s?n+2:0,h=t[o]-t[n],c=t[o+1]-t[r],l=h||c?Math.sqrt(h*h+c*c):0;e[n]=h,e[r]=c,i[n]=l?c/l:0,i[r]=l?-h/l:0}this._dirty_normals=!1}}class oi extends ge{constructor(t=0,e=0,i=0){super(t,e,[[0,0]],0,1,1,i),this._polygon=!0,this._circle=!1,this._point=!0,this.setPoints=void 0}}class li{constructor(){this._bvh=new hi}createCircle(t=0,e=0,i=0,s=1,n=0){const r=new ai(t,e,i,s,n);return this._bvh.insert(r),r}createPolygon(t=0,e=0,i=[[0,0]],s=0,n=1,r=1,o=0){const h=new ge(t,e,i,s,n,r,o);return this._bvh.insert(h),h}createPoint(t=0,e=0,i=0){const s=new oi(t,e,i);return this._bvh.insert(s),s}insert(...t){for(const e of t)this._bvh.insert(e,!1);return this}remove(...t){for(const e of t)this._bvh.remove(e,!1);return this}update(){return this._bvh.update(),this}potentials(t,e,i){return this._bvh.potentials(t,e,i)}collides(t,e,i=null,s=!0){return ue(t,e,i,s)}}class ci{constructor(){this.collision=!1,this.a=null,this.b=null,this.a_in_b=!1,this.b_in_a=!1,this.overlap=0,this.overlap_x=0,this.overlap_y=0}}const re=new ci,Si=(a,t,e)=>{const i=e.overlap*e.overlap_x,s=e.overlap*e.overlap_y,n=a.strength/(a.strength+t.strength)*(t.speed/(t.speed+a.speed)),r=1-n;a.x-=r*i,a.y-=r*s,t.x+=n*i,t.y+=n*s},Ti=(a,t,e,i=48)=>{const s=[];if(a.body._circle){const n=_i(Math.PI*a.radius**2,e,i);for(let r=0;r<e;r++){const o=new ti(t.createCircle(a.x,a.y,n[r]));o.speed=a.speed,o.directionX=a.directionX,o.directionY=a.directionY,o.color=a.color,s.push(o)}}else throw Error("TODO more types than circles");return s},_i=(a,t,e)=>{const i=[];for(let h=0;h<t;h++)i[h]=1+Be(0,1)*(e-1);const s=i.reduce((h,c)=>h+c);return i.map(h=>h/s).map(h=>h*a).map(h=>Math.sqrt(h/Math.PI))},Ct=[];class di{constructor(t){v(this,"collisions");v(this,"entities",new Set);this.collisions=t}addEntity(t){this.entities.add(t)}removeEntity(t){t.body.remove(),this.entities.delete(t)}update(t,e,i){this.collisions.update();let s;for(const n of this.entities)if(!n.disableSimulation&&(s=n.speed*t,n.x+=n.directionX*s,n.y+=n.directionY*s,!n.ghostly)){Ct.length=0,n.body.potentials(i,Ct);for(const r of Ct)if(!r.entity.ghostly&&n.body.collides(r,re)&&(e(n,r.entity,re),n.dead))break}}}class ui{constructor(){v(this,"moving",We(!1));v(this,"movingLeft",!1);v(this,"movingRight",!1);v(this,"movingUp",!1);v(this,"movingDown",!1);v(this,"pointerDown",!1);v(this,"viewportWidth",0);v(this,"viewportHeight",0);v(this,"viewWidth",0);v(this,"viewHeight",0);v(this,"worldWidth",0);v(this,"worldHeight",0);v(this,"pointerScreenX",null);v(this,"pointerScreenY",null)}setPointerDown(t){this.pointerDown=t,this.moving.set(this.isMoving())}setPointerLocation(t,e){this.pointerScreenX=t,this.pointerScreenY=e}isMoving(){return this.pointerDown||this.movingDown||this.movingUp||this.movingLeft||this.movingRight}handleKeydown(t){switch(t){case"ArrowLeft":case"a":{this.movingLeft=!0,this.moving.set(!0);break}case"ArrowRight":case"d":{this.movingRight=!0,this.moving.set(!0);break}case"ArrowUp":case"w":{this.movingUp=!0,this.moving.set(!0);break}case"ArrowDown":case"s":{this.movingDown=!0,this.moving.set(!0);break}default:console.log("unhandled keydown",t)}}handleKeyup(t){switch(t){case"ArrowLeft":case"a":{this.movingLeft=!1,this.moving.set(this.isMoving());break}case"ArrowRight":case"d":{this.movingRight=!1,this.moving.set(this.isMoving());break}case"ArrowUp":case"w":{this.movingUp=!1,this.moving.set(this.isMoving());break}case"ArrowDown":case"s":{this.movingDown=!1,this.moving.set(this.isMoving());break}default:console.log("unhandled keyup",t)}}}const pi=5,Ci=(a,t,e)=>{if(a.pointerDown&&a.pointerScreenX!==null&&a.pointerScreenY!==null){const i=a.viewWidth/a.worldWidth,s=a.pointerScreenX-a.viewportWidth/2+a.viewWidth/2,n=a.pointerScreenY-a.viewportHeight/2+a.viewHeight/2,r=s/i+e.x-e.width/2,o=n/i+e.y-e.height/2,h=r-t.x,c=o-t.y,l=Math.hypot(h,c),_=!l||l<pi;t.directionX=_?0:h/l,t.directionY=_?0:c/l}else{const{movingLeft:i,movingRight:s,movingUp:n,movingDown:r}=a,o=i&&!s?-1:s&&!i?1:0,h=n&&!r?-1:r&&!n?1:0;t.directionX=h===0?o:o/Math.SQRT2,t.directionY=o===0?h:h/Math.SQRT2}},fe={hard:!0},gi=(a,t)=>{const e={x:0,y:0,scale:1,width:0,height:0,...a},i=Fe(e,{stiffness:.006,damping:.12,...t}),{subscribe:s}=He(i,r=>{const o=r.x-r.width/2,h=r.y-r.height/2;return{...r,left:o,right:o+r.width,top:h,bottom:h+r.height}});return{subscribe:s,zoom:r=>{console.log("zoom amount",r)},setPosition:(r,o,h)=>i.update(c=>({...c,x:r,y:o}),h),set_dimensions:(r,o,h=fe)=>i.update(c=>({...c,width:r,height:o}),h)}};var Mt;let Mi=(Mt=class{constructor(t){v(this,"exit");v(this,"sim");v(this,"collisions");v(this,"container");v(this,"mask",null);v(this,"controller");v(this,"random");v(this,"time",0);v(this,"timeDilation",1);v(this,"worldWidth");v(this,"worldHeight");v(this,"viewWidth");v(this,"viewHeight");v(this,"viewportWidth");v(this,"viewportHeight");v(this,"camera");v(this,"$camera");v(this,"freezeCamera",!1);v(this,"subscriptions",[]);const{exit:e,data:i,worldWidth:s,worldHeight:n,viewWidth:r,viewHeight:o,viewportWidth:h,viewportHeight:c,collisions:l=new li,sim:_=new di(l),container:d=new At,controller:p=new ui,random:u=ei()}=t;i&&(i.freezeCamera!==void 0&&(this.freezeCamera=i.freezeCamera),i.timeDilation!==void 0&&(this.timeDilation=i.timeDilation)),this.exit=e,this.sim=_,this.collisions=l,this.container=d,this.controller=p,this.random=u,this.worldWidth=s,this.worldHeight=n,this.viewWidth=r,this.viewHeight=o,this.viewportWidth=h,this.viewportHeight=c,this.camera=gi({width:s,height:n,x:s/2,y:n/2}),this.subscriptions.push(this.camera.subscribe(g=>this.$camera=g))}async setup(t){}async teardown(){}destroy(){this.container.destroy({children:!0,baseTexture:!0,texture:!0});for(const t of this.subscriptions)t()}update(t){this.time+=t,this.updateCameraPosition()}toData(){return{freezeCamera:this.freezeCamera,playerSpeed:this.player.speed,playerStrength:this.player.strength,timeDilation:this.timeDilation}}resize(t,e,i,s,n,r){this.worldWidth=t,this.worldHeight=e,this.viewWidth=i,this.viewHeight=s,this.viewportWidth=n,this.viewportHeight=r,this.drawMask(),this.camera.set_dimensions(t,e),this.freezeCamera&&this.camera.setPosition(t/2,e/2,fe),this.updateCameraPosition(),this.afterResize()}updateCameraPosition(){const{container:t,viewWidth:e,viewHeight:i,$camera:s}=this,n=Math.min(e/this.worldWidth,i/this.worldHeight);t.scale.set(n),t.position.set((-s.x+s.width/2)*n+(this.viewportWidth-e)/2,(-s.y+s.height/2)*n+(this.viewportHeight-i)/2)}afterResize(){}drawMask(){const t=(this.viewportWidth-this.viewWidth)/2,e=(this.viewportHeight-this.viewHeight)/2;t===0&&e===0?this.mask&&(this.container.mask=null,this.mask.parent.removeChild(this.mask),this.mask.destroy({baseTexture:!0,texture:!0}),this.mask=null):(this.mask?this.mask.clear():(this.mask=new kt,this.container.mask=this.mask,this.container.addChild(this.mask)),this.mask.beginFill(0),this.mask.drawRect(0,0,this.worldWidth,this.worldHeight),this.mask.endFill())}addEntity(t){this.sim.addEntity(t),this.container.addChild(t.container),t.draw()}removeEntity(t){this.container.removeChild(t.container),this.sim.removeEntity(t),t.destroy()}},v(Mt,"meta"),Mt);export{Ze as D,ti as E,Mi as S,vi as a,Si as c,$t as d,Ti as f,Ci as u};
