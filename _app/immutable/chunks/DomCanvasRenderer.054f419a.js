var ae=Object.defineProperty;var he=(i,e,t)=>e in i?ae(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var P=(i,e,t)=>(he(i,typeof e!="symbol"?e+"":e,t),t);import{n as L,e as O,b as z,l as I,d as X,m as K,i as q,o as J,a as E,a2 as se,D as B,F as S,K as oe,L as Z,O as re,s as x,c as $,p as A,I as C,P as le,Q as ce,R as fe,B as ue,J as M}from"./scheduler.37029f49.js";import{S as R,i as V,t as y,g as ee,b as D,e as te,c as N,a as Q,m as G,d as U,f as j}from"./index.13406d9d.js";import{g as de}from"./clock.740c61c8.js";import{s as H}from"./dom.affe8f60.js";import{w as ge}from"./index.6dadb349.js";function _e(i){let e,t;return{c(){e=O("div"),t=O("canvas"),this.h()},l(n){e=z(n,"DIV",{class:!0});var s=I(e);t=z(s,"CANVAS",{}),I(t).forEach(X),s.forEach(X),this.h()},h(){K(e,"class","canvas svelte-cdatl6")},m(n,s){q(n,e,s),J(e,t),i[11](t)},p:E,i:E,o:E,d(n){n&&X(e),i[11](null)}}}function we(i,e,t){let n,s,c=E,u=()=>(c(),c=B(n,m=>t(9,s=m)),n),a,g=E,d=()=>(g(),g=B(_,m=>t(10,a=m)),_);i.$$.on_destroy.push(()=>c()),i.$$.on_destroy.push(()=>g());let{width:f}=e,{height:h}=e,{domCanvasRenderer:o}=e,{stage:r}=e,{clock:_}=e;d();let b,k,p;const v=(m,Y)=>{o==null||o.resize(m,Y),t(7,k=m),t(8,p=Y)};se(()=>(o==null||o.setCanvas(b),()=>{o==null||o.unsetCanvas()}));function W(m){S[m?"unshift":"push"](()=>{b=m,t(1,b)})}return i.$$set=m=>{"width"in m&&t(3,f=m.width),"height"in m&&t(4,h=m.height),"domCanvasRenderer"in m&&t(5,o=m.domCanvasRenderer),"stage"in m&&t(6,r=m.stage),"clock"in m&&d(t(0,_=m.clock))},i.$$.update=()=>{i.$$.dirty&410&&b&&(k!==f||p!==h)&&v(f,h),i.$$.dirty&32&&u(t(2,n=o==null?void 0:o.dirty)),i.$$.dirty&1632&&o!=null&&o.ctx&&(a.running||s)&&(o.clear(),o.render(r.sim.entities,r.$camera))},[_,b,n,f,h,o,r,k,p,s,a,W]}class me extends R{constructor(e){super(),V(this,e,we,_e,L,{width:3,height:4,domCanvasRenderer:5,stage:6,clock:0})}}function ve(i,e,t){let n,s,c,u=E,a=()=>(u(),u=B(f,r=>t(6,c=r)),f);i.$$.on_destroy.push(()=>u());let{pixi:g}=e,{stage:d}=e,{clock:f}=e;a();const{container:h,camera:o}=d;return oe(i,o,r=>t(5,s=r)),g.current_scene.addChild(h),Z(()=>{g.current_scene.removeChild(h)}),Z(()=>{g.app.render(),g.app.start()}),i.$$set=r=>{"pixi"in r&&t(2,g=r.pixi),"stage"in r&&t(3,d=r.stage),"clock"in r&&a(t(0,f=r.clock))},i.$$.update=()=>{i.$$.dirty&64&&t(4,{running:n}=c,n),i.$$.dirty&52&&(n?g.app.start():(g.app.stop(),o.setPosition(s.x,s.y,{hard:!0})))},[f,o,g,d,n,s,c]}class be extends R{constructor(e){super(),V(this,e,ve,null,L,{pixi:2,stage:3,clock:0})}}function ie(i){let e,t;return e=new me({props:{width:i[3],height:i[4],domCanvasRenderer:i[2],stage:i[0],clock:i[6]}}),{c(){N(e.$$.fragment)},l(n){Q(e.$$.fragment,n)},m(n,s){G(e,n,s),t=!0},p(n,s){const c={};s&8&&(c.width=n[3]),s&16&&(c.height=n[4]),s&4&&(c.domCanvasRenderer=n[2]),s&1&&(c.stage=n[0]),e.$set(c)},i(n){t||(y(e.$$.fragment,n),t=!0)},o(n){D(e.$$.fragment,n),t=!1},d(n){U(e,n)}}}function ne(i){let e,t;return e=new be({props:{stage:i[0],pixi:i[1],clock:i[6]}}),{c(){N(e.$$.fragment)},l(n){Q(e.$$.fragment,n)},m(n,s){G(e,n,s),t=!0},p(n,s){const c={};s&1&&(c.stage=n[0]),s&2&&(c.pixi=n[1]),e.$set(c)},i(n){t||(y(e.$$.fragment,n),t=!0)},o(n){D(e.$$.fragment,n),t=!1},d(n){U(e,n)}}}function ye(i){let e,t,n,s=`${i[3]}px`,c=`${i[4]}px`,u,a,g,d=i[2]&&ie(i),f=i[1]&&ne(i);const h=i[18].default,o=re(h,i,i[17],null);return{c(){e=O("div"),d&&d.c(),t=x(),f&&f.c(),n=x(),o&&o.c(),this.h()},l(r){e=z(r,"DIV",{class:!0});var _=I(e);d&&d.l(_),t=$(_),f&&f.l(_),n=$(_),o&&o.l(_),_.forEach(X),this.h()},h(){K(e,"class","world svelte-2qhvjl"),A(e,"width",s),A(e,"height",c)},m(r,_){q(r,e,_),d&&d.m(e,null),J(e,t),f&&f.m(e,null),J(e,n),o&&o.m(e,null),u=!0,a||(g=[C(window,"keydown",i[7]),C(window,"keyup",i[8])],a=!0)},p(r,[_]){r[2]?d?(d.p(r,_),_&4&&y(d,1)):(d=ie(r),d.c(),y(d,1),d.m(e,t)):d&&(ee(),D(d,1,1,()=>{d=null}),te()),r[1]?f?(f.p(r,_),_&2&&y(f,1)):(f=ne(r),f.c(),y(f,1),f.m(e,n)):f&&(ee(),D(f,1,1,()=>{f=null}),te()),o&&o.p&&(!u||_&131072)&&le(o,h,r,r[17],u?fe(h,r[17],_,null):ce(r[17]),null),_&8&&s!==(s=`${r[3]}px`)&&A(e,"width",s),_&16&&c!==(c=`${r[4]}px`)&&A(e,"height",c)},i(r){u||(y(d),y(f),y(o,r),u=!0)},o(r){D(d),D(f),D(o,r),u=!1},d(r){r&&X(e),d&&d.d(),f&&f.d(),o&&o.d(r),a=!1,ue(g)}}}function ke(i,e,t){let n,s,c,u,a,g=E,d=()=>(g(),g=B(s,w=>t(16,a=w)),s);i.$$.on_destroy.push(()=>g());let{$$slots:f={},$$scope:h}=e,{stage:o}=e,{pixi:r=null}=e,{domCanvasRenderer:_=null}=e,{worldWidth:b}=e,{worldHeight:k}=e,{viewWidth:p}=e,{viewHeight:v}=e,{viewportWidth:W}=e,{viewportHeight:m}=e;const Y=de();oe(i,Y,w=>t(15,u=w)),se(()=>{o.update(0),l()});const l=()=>{r==null||r.app.render()},F=w=>{n.handleKeydown(w.key)},T=w=>{n.handleKeyup(w.key)};return i.$$set=w=>{"stage"in w&&t(0,o=w.stage),"pixi"in w&&t(1,r=w.pixi),"domCanvasRenderer"in w&&t(2,_=w.domCanvasRenderer),"worldWidth"in w&&t(3,b=w.worldWidth),"worldHeight"in w&&t(4,k=w.worldHeight),"viewWidth"in w&&t(9,p=w.viewWidth),"viewHeight"in w&&t(10,v=w.viewHeight),"viewportWidth"in w&&t(11,W=w.viewportWidth),"viewportHeight"in w&&t(12,m=w.viewportHeight),"$$scope"in w&&t(17,h=w.$$scope)},i.$$.update=()=>{i.$$.dirty&6&&console.log("pixi, domCanvasRenderer",r,_),i.$$.dirty&1&&t(13,{controller:n}=o,n),i.$$.dirty&8192&&d(t(5,{moving:s}=n,s)),i.$$.dirty&32768&&t(14,{running:c}=u,c),i.$$.dirty&81920&&!c&&a&&Y.resume(),i.$$.dirty&49153&&c&&o.update(u.dt),i.$$.dirty&24089&&(o.resize(b,k,p,v,W,m),!c&&l())},[o,r,_,b,k,s,Y,F,T,p,v,W,m,n,c,u,a,h,f]}class Ie extends R{constructor(e){super(),V(this,e,ke,ye,L,{stage:0,pixi:1,domCanvasRenderer:2,worldWidth:3,worldHeight:4,viewWidth:9,viewHeight:10,viewportWidth:11,viewportHeight:12})}}function pe(i){let e,t,n,s;const c=i[14].default,u=re(c,i,i[13],null);return{c(){e=O("div"),u&&u.c(),this.h()},l(a){e=z(a,"DIV",{class:!0,tabindex:!0,role:!0});var g=I(e);u&&u.l(g),g.forEach(X),this.h()},h(){K(e,"class","surface svelte-1ktoghv"),K(e,"tabindex","0"),K(e,"role","button")},m(a,g){q(a,e,g),u&&u.m(e,null),i[15](e),t=!0,n||(s=[C(e,"pointerdown",i[1]),C(e,"pointerup",i[2]),C(e,"pointermove",i[3]),C(e,"pointerenter",i[4]),C(e,"pointerleave",i[5]),C(e,"pointercancel",i[6])],n=!0)},p(a,[g]){u&&u.p&&(!t||g&8192)&&le(u,c,a,a[13],t?fe(c,a[13],g,null):ce(a[13]),null)},i(a){t||(y(u,a),t=!0)},o(a){D(u,a),t=!1},d(a){a&&X(e),u&&u.d(a),i[15](null),n=!1,ue(s)}}}function De(i,e,t){let{$$slots:n={},$$scope:s}=e,{scale:c=1}=e,{pointing:u=void 0}=e,{pointerDown:a=void 0}=e,{pointerX:g=void 0}=e,{pointerY:d=void 0}=e,{cancelOnLeave:f=!0}=e;const h=(l,F)=>{const T=v.getBoundingClientRect();t(9,g=(l-T.left)/c),t(10,d=(F-T.top)/c)},o=l=>{l.shiftKey||l.button>=3||(H(l),h(l.clientX,l.clientY),t(8,a=!0),W())},r=l=>{l.shiftKey||l.button>=3||(H(l),h(l.clientX,l.clientY),t(8,a=!1))},_=l=>{l.shiftKey||(H(l),h(l.clientX,l.clientY))},b=l=>{l.shiftKey||(H(l),h(l.clientX,l.clientY),t(7,u=!0))},k=l=>{l.shiftKey||(H(l),h(l.clientX,l.clientY),t(7,u=!1),f&&a&&(t(8,a=!1),m()))},p=l=>{l.shiftKey||(H(l),a&&(t(8,a=!1),m()))};let v;const W=()=>{document.activeElement!==v&&v.focus()},m=()=>{document.activeElement===v&&v.blur()};function Y(l){S[l?"unshift":"push"](()=>{v=l,t(0,v)})}return i.$$set=l=>{"scale"in l&&t(11,c=l.scale),"pointing"in l&&t(7,u=l.pointing),"pointerDown"in l&&t(8,a=l.pointerDown),"pointerX"in l&&t(9,g=l.pointerX),"pointerY"in l&&t(10,d=l.pointerY),"cancelOnLeave"in l&&t(12,f=l.cancelOnLeave),"$$scope"in l&&t(13,s=l.$$scope)},[v,o,r,_,b,k,p,u,a,g,d,c,f,s,n,Y]}class Xe extends R{constructor(e){super(),V(this,e,De,pe,L,{scale:11,pointing:7,pointerDown:8,pointerX:9,pointerY:10,cancelOnLeave:12})}}function Ye(i){let e,t,n,s,c,u;function a(h){i[4](h)}function g(h){i[5](h)}function d(h){i[6](h)}let f={};return i[0]!==void 0&&(f.pointerDown=i[0]),i[1]!==void 0&&(f.pointerX=i[1]),i[2]!==void 0&&(f.pointerY=i[2]),t=new Xe({props:f}),S.push(()=>j(t,"pointerDown",a)),S.push(()=>j(t,"pointerX",g)),S.push(()=>j(t,"pointerY",d)),{c(){e=O("div"),N(t.$$.fragment),this.h()},l(h){e=z(h,"DIV",{class:!0});var o=I(e);Q(t.$$.fragment,o),o.forEach(X),this.h()},h(){K(e,"class","surface-wrapper svelte-1w41ucz")},m(h,o){q(h,e,o),G(t,e,null),u=!0},p(h,[o]){const r={};!n&&o&1&&(n=!0,r.pointerDown=h[0],M(()=>n=!1)),!s&&o&2&&(s=!0,r.pointerX=h[1],M(()=>s=!1)),!c&&o&4&&(c=!0,r.pointerY=h[2],M(()=>c=!1)),t.$set(r)},i(h){u||(y(t.$$.fragment,h),u=!0)},o(h){D(t.$$.fragment,h),u=!1},d(h){h&&X(e),U(t)}}}function Ce(i,e,t){let{controller:n}=e,s=!1,c,u;function a(f){s=f,t(0,s)}function g(f){c=f,t(1,c)}function d(f){u=f,t(2,u)}return i.$$set=f=>{"controller"in f&&t(3,n=f.controller)},i.$$.update=()=>{i.$$.dirty&14&&c!==void 0&&n.setPointerLocation(c,u),i.$$.dirty&9&&n.pointerDown!==s&&n.setPointerDown(s)},[s,c,u,n,a,g,d]}class Le extends R{constructor(e){super(),V(this,e,Ce,Ye,L,{controller:3})}}class Re{constructor(){P(this,"width",-1);P(this,"height",-1);P(this,"canvas",null);P(this,"ctx",null);P(this,"dirty",ge(!1))}setCanvas(e){if(this.canvas=e,!(this.ctx=e.getContext("2d")))throw Error("Failed to get canvas context");this.width!==-1&&this.height!==-1&&(e.width=this.width,e.height=this.height),this.dirty.set(!0)}unsetCanvas(){this.canvas=null,this.ctx=null}resize(e,t){console.log("[renderer] resize, width, height",e,t),this.width=e,this.height=t,this.canvas&&(this.canvas.width=e,this.canvas.height=t),this.dirty.set(!0)}clear(){const{ctx:e,width:t,height:n}=this;if(!e)throw Error("Expected rendering context");if(t===-1||n===-1)throw Error("Expected renderer dimensions");e.clearRect(0,0,t,n)}render(e,t){const{ctx:n}=this;if(!n)throw Error("Expected rendering context");if(this.width===-1||this.height===-1)throw Error("Expected renderer dimensions");this.dirty.set(!1);for(const s of e)if(!s.invisible){if(n.beginPath(),n.strokeStyle=s.colorStr||"#fff",s.body._circle)We(n,s.body,t);else throw Error("TODO");n.stroke(),s.text&&Ee(n,s,t)}}}const We=(i,e,t)=>{const{x:n,y:s}=e,c=e.radius*e.scale,u=(n-t.x)*t.scale+t.width/2,a=(s-t.y)*t.scale+t.height/2;i.moveTo(u+c,a),i.arc(u,a,c,0,Math.PI*2)},Ee=(i,e,t)=>{const n=(e.x-t.x)*t.scale+t.width/2+e.textOffsetX,s=(e.y-t.y)*t.scale+t.height/2+e.textOffsetY;i.textAlign="center",i.textBaseline="middle",i.font=e.font||"30px sans-serif",i.fillText(e.text,n,s)};export{Re as D,Le as S,Ie as W};
