var ae=Object.defineProperty;var he=(i,e,t)=>e in i?ae(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var S=(i,e,t)=>(he(i,typeof e!="symbol"?e+"":e,t),t);import{n as I,e as z,b as P,l as V,d as W,m as Y,i as q,o as F,a as K,a4 as se,E as M,G as x,L as oe,M as Q,T as re,s as Z,c as $,p as A,J as H,U as le,V as ce,W as fe,C as ue,K as L}from"./scheduler.317e39f5.js";import{S as R,i as T,t as b,g as ee,b as C,e as te,c as G,a as J,m as N,d as U,f as j}from"./index.3972ef43.js";import{g as de}from"./clock.fa46b71f.js";import{s as X}from"./dom.affe8f60.js";import{w as _e}from"./index.28c54d51.js";function ge(i){let e,t;return{c(){e=z("div"),t=z("canvas"),this.h()},l(n){e=P(n,"DIV",{class:!0});var s=V(e);t=P(s,"CANVAS",{}),V(t).forEach(W),s.forEach(W),this.h()},h(){Y(e,"class","canvas svelte-cdatl6")},m(n,s){q(n,e,s),F(e,t),i[11](t)},p:K,i:K,o:K,d(n){n&&W(e),i[11](null)}}}function we(i,e,t){let n,s,c=K,u=()=>(c(),c=M(n,m=>t(9,s=m)),n),a,_=K,d=()=>(_(),_=M(g,m=>t(10,a=m)),g);i.$$.on_destroy.push(()=>c()),i.$$.on_destroy.push(()=>_());let{width:f}=e,{height:h}=e,{domCanvasRenderer:o}=e,{stage:r}=e,{clock:g}=e;d();let v,p,k;const y=(m,E)=>{o==null||o.resize(m,E),t(7,p=m),t(8,k=E)};se(()=>(o==null||o.setCanvas(v),()=>{o==null||o.unsetCanvas()}));function D(m){x[m?"unshift":"push"](()=>{v=m,t(1,v)})}return i.$$set=m=>{"width"in m&&t(3,f=m.width),"height"in m&&t(4,h=m.height),"domCanvasRenderer"in m&&t(5,o=m.domCanvasRenderer),"stage"in m&&t(6,r=m.stage),"clock"in m&&d(t(0,g=m.clock))},i.$$.update=()=>{i.$$.dirty&410&&v&&(p!==f||k!==h)&&y(f,h),i.$$.dirty&32&&u(t(2,n=o==null?void 0:o.dirty)),i.$$.dirty&1632&&o!=null&&o.ctx&&(a.running||s)&&(o.clear(),o.render(r.sim.entities,r.$camera))},[g,v,n,f,h,o,r,p,k,s,a,D]}class me extends R{constructor(e){super(),T(this,e,we,ge,I,{width:3,height:4,domCanvasRenderer:5,stage:6,clock:0})}}function ye(i,e,t){let n,s,c,u=K,a=()=>(u(),u=M(f,r=>t(6,c=r)),f);i.$$.on_destroy.push(()=>u());let{pixi:_}=e,{stage:d}=e,{clock:f}=e;a();const{container:h,camera:o}=d;return oe(i,o,r=>t(5,s=r)),_.current_scene.addChild(h),Q(()=>{_.current_scene.removeChild(h)}),Q(()=>{_.app.render(),_.app.start()}),i.$$set=r=>{"pixi"in r&&t(2,_=r.pixi),"stage"in r&&t(3,d=r.stage),"clock"in r&&a(t(0,f=r.clock))},i.$$.update=()=>{i.$$.dirty&64&&t(4,{running:n}=c,n),i.$$.dirty&52&&(n?_.app.start():(_.app.stop(),o.setPosition(s.x,s.y,{hard:!0})))},[f,o,_,d,n,s,c]}class ve extends R{constructor(e){super(),T(this,e,ye,null,I,{pixi:2,stage:3,clock:0})}}function ie(i){let e,t;return e=new me({props:{width:i[3],height:i[4],domCanvasRenderer:i[2],stage:i[0],clock:i[6]}}),{c(){G(e.$$.fragment)},l(n){J(e.$$.fragment,n)},m(n,s){N(e,n,s),t=!0},p(n,s){const c={};s&8&&(c.width=n[3]),s&16&&(c.height=n[4]),s&4&&(c.domCanvasRenderer=n[2]),s&1&&(c.stage=n[0]),e.$set(c)},i(n){t||(b(e.$$.fragment,n),t=!0)},o(n){C(e.$$.fragment,n),t=!1},d(n){U(e,n)}}}function ne(i){let e,t;return e=new ve({props:{stage:i[0],pixi:i[1],clock:i[6]}}),{c(){G(e.$$.fragment)},l(n){J(e.$$.fragment,n)},m(n,s){N(e,n,s),t=!0},p(n,s){const c={};s&1&&(c.stage=n[0]),s&2&&(c.pixi=n[1]),e.$set(c)},i(n){t||(b(e.$$.fragment,n),t=!0)},o(n){C(e.$$.fragment,n),t=!1},d(n){U(e,n)}}}function be(i){let e,t,n,s=`${i[3]}px`,c=`${i[4]}px`,u,a,_,d=i[2]&&ie(i),f=i[1]&&ne(i);const h=i[18].default,o=re(h,i,i[17],null);return{c(){e=z("div"),d&&d.c(),t=Z(),f&&f.c(),n=Z(),o&&o.c(),this.h()},l(r){e=P(r,"DIV",{class:!0});var g=V(e);d&&d.l(g),t=$(g),f&&f.l(g),n=$(g),o&&o.l(g),g.forEach(W),this.h()},h(){Y(e,"class","world svelte-2qhvjl"),A(e,"width",s),A(e,"height",c)},m(r,g){q(r,e,g),d&&d.m(e,null),F(e,t),f&&f.m(e,null),F(e,n),o&&o.m(e,null),u=!0,a||(_=[H(window,"keydown",i[7]),H(window,"keyup",i[8])],a=!0)},p(r,[g]){r[2]?d?(d.p(r,g),g&4&&b(d,1)):(d=ie(r),d.c(),b(d,1),d.m(e,t)):d&&(ee(),C(d,1,1,()=>{d=null}),te()),r[1]?f?(f.p(r,g),g&2&&b(f,1)):(f=ne(r),f.c(),b(f,1),f.m(e,n)):f&&(ee(),C(f,1,1,()=>{f=null}),te()),o&&o.p&&(!u||g&131072)&&le(o,h,r,r[17],u?fe(h,r[17],g,null):ce(r[17]),null),g&8&&s!==(s=`${r[3]}px`)&&A(e,"width",s),g&16&&c!==(c=`${r[4]}px`)&&A(e,"height",c)},i(r){u||(b(d),b(f),b(o,r),u=!0)},o(r){C(d),C(f),C(o,r),u=!1},d(r){r&&W(e),d&&d.d(),f&&f.d(),o&&o.d(r),a=!1,ue(_)}}}function pe(i,e,t){let n,s,c,u,a,_=K,d=()=>(_(),_=M(s,w=>t(16,a=w)),s);i.$$.on_destroy.push(()=>_());let{$$slots:f={},$$scope:h}=e,{stage:o}=e,{pixi:r=null}=e,{domCanvasRenderer:g=null}=e,{worldWidth:v}=e,{worldHeight:p}=e,{viewWidth:k}=e,{viewHeight:y}=e,{viewportWidth:D}=e,{viewportHeight:m}=e;const E=de();oe(i,E,w=>t(15,u=w)),se(()=>{o.update(0),l()});const l=()=>{r==null||r.app.render()},B=w=>{n.handleKeydown(w.key)},O=w=>{n.handleKeyup(w.key)};return i.$$set=w=>{"stage"in w&&t(0,o=w.stage),"pixi"in w&&t(1,r=w.pixi),"domCanvasRenderer"in w&&t(2,g=w.domCanvasRenderer),"worldWidth"in w&&t(3,v=w.worldWidth),"worldHeight"in w&&t(4,p=w.worldHeight),"viewWidth"in w&&t(9,k=w.viewWidth),"viewHeight"in w&&t(10,y=w.viewHeight),"viewportWidth"in w&&t(11,D=w.viewportWidth),"viewportHeight"in w&&t(12,m=w.viewportHeight),"$$scope"in w&&t(17,h=w.$$scope)},i.$$.update=()=>{i.$$.dirty&6&&console.log("pixi, domCanvasRenderer",r,g),i.$$.dirty&1&&t(13,{controller:n}=o,n),i.$$.dirty&8192&&d(t(5,{moving:s}=n,s)),i.$$.dirty&32768&&t(14,{running:c}=u,c),i.$$.dirty&81920&&!c&&a&&E.resume(),i.$$.dirty&49153&&c&&o.update(u.dt),i.$$.dirty&24089&&(o.resize(v,p,k,y,D,m),!c&&l())},[o,r,g,v,p,s,E,B,O,k,y,D,m,n,c,u,a,h,f]}class Ve extends R{constructor(e){super(),T(this,e,pe,be,I,{stage:0,pixi:1,domCanvasRenderer:2,worldWidth:3,worldHeight:4,viewWidth:9,viewHeight:10,viewportWidth:11,viewportHeight:12})}}function ke(i){let e,t,n,s;const c=i[14].default,u=re(c,i,i[13],null);return{c(){e=z("div"),u&&u.c(),this.h()},l(a){e=P(a,"DIV",{class:!0,tabindex:!0,role:!0});var _=V(e);u&&u.l(_),_.forEach(W),this.h()},h(){Y(e,"class","surface svelte-1ktoghv"),Y(e,"tabindex","0"),Y(e,"role","button")},m(a,_){q(a,e,_),u&&u.m(e,null),i[15](e),t=!0,n||(s=[H(e,"pointerdown",i[1]),H(e,"pointerup",i[2]),H(e,"pointermove",i[3]),H(e,"pointerenter",i[4]),H(e,"pointerleave",i[5]),H(e,"pointercancel",i[6])],n=!0)},p(a,[_]){u&&u.p&&(!t||_&8192)&&le(u,c,a,a[13],t?fe(c,a[13],_,null):ce(a[13]),null)},i(a){t||(b(u,a),t=!0)},o(a){C(u,a),t=!1},d(a){a&&W(e),u&&u.d(a),i[15](null),n=!1,ue(s)}}}function Ce(i,e,t){let{$$slots:n={},$$scope:s}=e,{scale:c=1}=e,{pointing:u=void 0}=e,{pointer_down:a=void 0}=e,{pointer_x:_=void 0}=e,{pointer_y:d=void 0}=e,{cancel_on_leave:f=!0}=e;const h=(l,B)=>{const O=y.getBoundingClientRect();t(9,_=(l-O.left)/c),t(10,d=(B-O.top)/c)},o=l=>{l.shiftKey||l.button>=3||(X(l),h(l.clientX,l.clientY),t(8,a=!0),D())},r=l=>{l.shiftKey||l.button>=3||(X(l),h(l.clientX,l.clientY),t(8,a=!1))},g=l=>{l.shiftKey||(X(l),h(l.clientX,l.clientY))},v=l=>{l.shiftKey||(X(l),h(l.clientX,l.clientY),t(7,u=!0))},p=l=>{l.shiftKey||(X(l),h(l.clientX,l.clientY),t(7,u=!1),f&&a&&(t(8,a=!1),m()))},k=l=>{l.shiftKey||(X(l),a&&(t(8,a=!1),m()))};let y;const D=()=>{document.activeElement!==y&&y.focus()},m=()=>{document.activeElement===y&&y.blur()};function E(l){x[l?"unshift":"push"](()=>{y=l,t(0,y)})}return i.$$set=l=>{"scale"in l&&t(11,c=l.scale),"pointing"in l&&t(7,u=l.pointing),"pointer_down"in l&&t(8,a=l.pointer_down),"pointer_x"in l&&t(9,_=l.pointer_x),"pointer_y"in l&&t(10,d=l.pointer_y),"cancel_on_leave"in l&&t(12,f=l.cancel_on_leave),"$$scope"in l&&t(13,s=l.$$scope)},[y,o,r,g,v,p,k,u,a,_,d,c,f,s,n,E]}class We extends R{constructor(e){super(),T(this,e,Ce,ke,I,{scale:11,pointing:7,pointer_down:8,pointer_x:9,pointer_y:10,cancel_on_leave:12})}}function Ee(i){let e,t,n,s,c,u;function a(h){i[4](h)}function _(h){i[5](h)}function d(h){i[6](h)}let f={};return i[0]!==void 0&&(f.pointer_down=i[0]),i[1]!==void 0&&(f.pointer_x=i[1]),i[2]!==void 0&&(f.pointer_y=i[2]),t=new We({props:f}),x.push(()=>j(t,"pointer_down",a)),x.push(()=>j(t,"pointer_x",_)),x.push(()=>j(t,"pointer_y",d)),{c(){e=z("div"),G(t.$$.fragment),this.h()},l(h){e=P(h,"DIV",{class:!0});var o=V(e);J(t.$$.fragment,o),o.forEach(W),this.h()},h(){Y(e,"class","surface-wrapper svelte-1w41ucz")},m(h,o){q(h,e,o),N(t,e,null),u=!0},p(h,[o]){const r={};!n&&o&1&&(n=!0,r.pointer_down=h[0],L(()=>n=!1)),!s&&o&2&&(s=!0,r.pointer_x=h[1],L(()=>s=!1)),!c&&o&4&&(c=!0,r.pointer_y=h[2],L(()=>c=!1)),t.$set(r)},i(h){u||(b(t.$$.fragment,h),u=!0)},o(h){C(t.$$.fragment,h),u=!1},d(h){h&&W(e),U(t)}}}function He(i,e,t){let{controller:n}=e,s=!1,c,u;function a(f){s=f,t(0,s)}function _(f){c=f,t(1,c)}function d(f){u=f,t(2,u)}return i.$$set=f=>{"controller"in f&&t(3,n=f.controller)},i.$$.update=()=>{i.$$.dirty&14&&c!==void 0&&n.setPointerLocation(c,u),i.$$.dirty&9&&n.pointer_down!==s&&n.setPointerDown(s)},[s,c,u,n,a,_,d]}class Ie extends R{constructor(e){super(),T(this,e,He,Ee,I,{controller:3})}}class Re{constructor(){S(this,"width",-1);S(this,"height",-1);S(this,"canvas",null);S(this,"ctx",null);S(this,"dirty",_e(!1))}setCanvas(e){if(this.canvas=e,!(this.ctx=e.getContext("2d")))throw Error("Failed to get canvas context");this.width!==-1&&this.height!==-1&&(e.width=this.width,e.height=this.height),this.dirty.set(!0)}unsetCanvas(){this.canvas=null,this.ctx=null}resize(e,t){console.log("[renderer] resize, width, height",e,t),this.width=e,this.height=t,this.canvas&&(this.canvas.width=e,this.canvas.height=t),this.dirty.set(!0)}clear(){const{ctx:e,width:t,height:n}=this;if(!e)throw Error("Expected rendering context");if(t===-1||n===-1)throw Error("Expected renderer dimensions");e.clearRect(0,0,t,n)}render(e,t){const{ctx:n}=this;if(!n)throw Error("Expected rendering context");if(this.width===-1||this.height===-1)throw Error("Expected renderer dimensions");this.dirty.set(!1);for(const s of e)if(!s.invisible){if(n.beginPath(),n.strokeStyle=s.colorStr||"#fff",s.body._circle)De(n,s.body,t);else throw Error("TODO");n.stroke(),s.text&&Ke(n,s,t)}}}const De=(i,e,t)=>{const{x:n,y:s}=e,c=e.radius*e.scale,u=(n-t.x)*t.scale+t.width/2,a=(s-t.y)*t.scale+t.height/2;i.moveTo(u+c,a),i.arc(u,a,c,0,Math.PI*2)},Ke=(i,e,t)=>{const n=(e.x-t.x)*t.scale+t.width/2+e.textOffsetX,s=(e.y-t.y)*t.scale+t.height/2+e.textOffsetY;i.textAlign="center",i.textBaseline="middle",i.font=e.font||"30px sans-serif",i.fillText(e.text,n,s)};export{Re as D,Ie as S,Ve as W};
